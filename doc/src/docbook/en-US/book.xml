<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<book>
    <bookinfo>
        <title>AlgoTrader</title>
        <subtitle>Algorithmic Trading Platform</subtitle>
        <productname>Reference Documentation</productname>
        <productnumber>2.0</productnumber>
        <copyright>
            <year>2013</year>
            <holder>Flury Trading</holder>
        </copyright>
        <authorgroup>
            <author>
                <firstname>Andy</firstname>
                <surname>Flury</surname>
                <affiliation>
                    <orgname>Flury Trading</orgname>
                </affiliation>
                <email>andyflury@gmail.com</email>
            </author>
        </authorgroup>
    </bookinfo>
    <preface id="Preface">
        <title>Preface</title>
        <section>
            <title>Document Conventions</title>
            <para>This manual uses several conventions to highlight certain words and phrases and
                draw attention to specific pieces of information.</para>
            <para>In PDF and paper editions, this manual uses typefaces drawn from the <ulink url="https://fedorahosted.org/liberation-fonts/">Liberation Fonts</ulink> set.
                The Liberation Fonts set is also used in HTML editions if the set is installed on
                your system. If not, alternative but equivalent typefaces are displayed.</para>
            <section>
                <title>Typographic Conventions</title>
                <para>The following <application>typographic</application> conventions are used to
                    call attention to specific words and phrases. These conventions, and the
                    circumstances they apply to, are as follows.</para>
                <para>System input, including shell commands, file names and paths, and key caps and
                    key-combinations are presented as follows.</para>
                <blockquote>
                    <para>To see the contents of the file
                            <filename>my_next_bestselling_novel</filename> in your current working
                        directory, enter the <command>cat my_next_bestselling_novel</command>
                        command at the shell prompt and press <keycap>Enter</keycap> to execute the
                        command.</para>
                </blockquote>
                <para>The above includes a file name, a shell command and a key cap, all
                    distinguishable thanks to context.</para>
                <para>Key-combinations can be distinguished from key caps by the symbol connecting
                    each part of a key-combination. For example:</para>
                <blockquote>
                    <para>Press <keycap>Enter</keycap> to execute the command.</para>
                    <para>Press <keycombo>
                            <keycap>Ctrl</keycap>
                            <keycap>Alt</keycap>
                            <keycap>F1</keycap>
                        </keycombo> to switch to the first virtual terminal. Press <keycombo>
                            <keycap>Ctrl</keycap>
                            <keycap>Alt</keycap>
                            <keycap>F7</keycap>
                        </keycombo> to return to your X-Windows session.</para>
                </blockquote>
                <para>The first sentence highlights the particular key cap to press. The second
                    highlights two sets of three key caps, each set pressed simultaneously.</para>
                <para>If source code is discussed, class names, methods, functions, variable names
                    and returned values mentioned within a paragraph are presented as
                    follows.</para>
                <blockquote>
                    <para>File-related classes include <classname>filesystem</classname> for file
                        systems, <classname>file</classname> for files, and
                            <classname>dir</classname> for directories. Each class has its own
                        associated set of permissions.</para>
                </blockquote>
                <para>Words or phrases encountered on a system, including application names; dialog
                    box text; labeled buttons; check-box and radio button labels; menu titles and
                    sub-menu titles are presented as follows.</para>
                <blockquote>
                    <para>Choose <menuchoice>
                            <guimenu>System</guimenu>
                            <guimenuitem>Preferences</guimenuitem>
                            <guisubmenu>Mouse</guisubmenu>
                        </menuchoice> from the main menu bar to launch <application>Mouse
                            Preferences</application>. In the <guilabel>Buttons</guilabel> tab,
                        click the <guilabel>Left-handed mouse</guilabel> check box and click
                            <guibutton>Close</guibutton> to switch the primary mouse button from the
                        left to the right (making the mouse suitable for use in the left
                        hand).</para>
                    <para>To insert a special character into a <application>gedit</application>
                        file, choose <menuchoice>
                            <guimenu>Applications</guimenu>
                            <guimenuitem>Accessories</guimenuitem>
                            <guisubmenu>Character Map</guisubmenu>
                        </menuchoice> from the main menu bar. Next, choose <menuchoice>
                            <guimenu>Search</guimenu>
                            <guimenuitem>Find</guimenuitem>
                        </menuchoice> from the <application>Character Map</application> menu bar,
                        type the name of the character in the <guilabel>Search</guilabel> field and
                        click <guibutton>Next</guibutton>. The character you sought will be
                        highlighted in the <guilabel>Character Table</guilabel>. Double-click this
                        highlighted character to place it in the <guilabel>Text to copy</guilabel>
                        field and then click the <guibutton>Copy</guibutton> button. Now switch back
                        to your document and choose <menuchoice>
                            <guimenu>Edit</guimenu>
                            <guimenuitem>Paste</guimenuitem>
                        </menuchoice> from the <application>gedit</application> menu bar.</para>
                </blockquote>
                <para>The above text includes application names; system-wide menu names and items;
                    application-specific menu names; and buttons and text found within a GUI
                    interface, all distinguishable by context.</para>
                <para>Note the shorthand used to indicate traversal through a menu and its
                    sub-menus. This is to avoid the difficult-to-follow &apos;Select
                        <guimenuitem>Mouse</guimenuitem> from the <guimenu>Preferences</guimenu>
                    sub-menu in the <guimenu>System</guimenu> menu of the main menu bar&apos;
                    approach.</para>
                <para>Italics denotes text you do not input literally or displayed text that changes
                    depending on circumstance. Replaceable or variable text is presented as
                    follows.</para>
                <blockquote>
                    <para>To connect to a remote machine using ssh, type <command>ssh
                                <replaceable>username</replaceable>@<replaceable>domain.name</replaceable>
                        </command> at a shell prompt. If the remote machine is
                            <filename>example.com</filename> and your username on that machine is
                        john, type <command>ssh john@example.com</command>.</para>
                    <para>The <command>mount -o remount <replaceable>file-system</replaceable>
                        </command> command remounts the named file system. For example, to remount
                        the <filename>home</filename> file system, the command is <command>mount -o
                            remount /home</command>.</para>
                    <para>To see the version of a currently installed package, use the <command>rpm
                            -q <replaceable>package</replaceable>
                        </command> command. It will return a result as follows: <command>
                            <replaceable>package-version-release</replaceable>
                        </command>.</para>
                </blockquote>
                <para>Note the words in italics above &mdash; username, domain.name, file-system,
                    package, version and release. Each word is a placeholder, either for text you
                    enter when issuing a command or for text displayed by the system.</para>
            </section>
            <section>
                <title>Pull-quote Conventions</title>
                <para>Two commonly multi-line data types are set off visually from the surrounding
                    text.</para>
                <para>Output sent to a terminal is presented as follows:</para>
                <screen>books        Desktop   documentation  drafts  mss    photos   stuff  svn
books_tests  Desktop1  downloads      images  notes  scripts  svgs</screen>
                <para>Source-code listings are presented and highlighted as follows:</para>
                <programlisting language="Java">
package org.jboss.book.jca.ex1;

import javax.naming.InitialContext;

public class ExClient {

  public static void main(String args[]) throws Exception {

    InitialContext iniCtx = new InitialContext();
    Object ref = iniCtx.lookup("EchoBean");
    EchoHome home   = (EchoHome) ref;
    Echo echo = home.create();

    System.out.println("Created Echo");

    System.out.println("Echo.echo('Hello') = " + echo.echo("Hello"));
  }
}</programlisting>
            </section>
            <section>
                <title>Notes and Warnings</title>
                <para>Finally, three visual styles are used to draw attention to information that might
                    otherwise be overlooked.</para>
                <warning>
                    <title>Warning</title>
                    <para>A Warning should not be ignored. Ignoring warnings will most likely cause
                        data loss.</para>
                </warning>
                <important>
                    <title>Important</title>
                    <para>Important boxes detail things that are easily missed: configuration
                        changes that only apply to the current session, or services that need
                        restarting before an update will apply. Ignoring Important boxes won&apos;t
                        cause data loss but may cause irritation and frustration.</para>
                </important>
                <note>
                    <title>Note</title>
                    <para>A note is a tip or shortcut or alternative approach to the task at hand.
                        Ignoring a note should have no negative consequences, but you might miss out
                        on a trick that makes your life easier.</para>
                </note>
            </section>
        </section>
    </preface>
    <chapter id="Introduction">
        <title>Introduction</title>
        <para>
            <emphasis role="bold">What is AlgoTrader:</emphasis>
        </para>
        <itemizedlist>
            <listitem>
                <para>AlgoTrader is a Server based Algorithmic Trading Platform</para>
            </listitem>
            <listitem>
                <para>AlgoTrader enables development, simulation and execution of multiple
                        strategies in parallel</para>
            </listitem>
            <listitem>
                <para>AlgoTrader can trade multiple securities and multiple markets</para>
            </listitem>
            <listitem>
                <para>AlgoTrader can create a signal based on one or more securities but then
                        trade another security or combination of securities</para>
            </listitem>
            <listitem>
                <para>AlgoTrader can trade Futures / Options in a continuous fashion (i.e.
                        automatic rolling and constant maturity adjustment)</para>
            </listitem>
            <listitem>
                <para>AlgoTrader supports Multi Module Strategies</para>
            </listitem>
            <listitem>
                <para>AlgoTrader supports custom Derivative Spreads (e.g. Option Straddles,
                        Strangles, Butterflys etc.)</para>
            </listitem>
            <listitem>
                <para>AlgoTrader has several sophisticated built-in Execution Algorithms aimed
                        at getting better execution prices as well as minimizing market visibility
                        and impact</para>
            </listitem>
            <listitem>
                <para>AlgoTrader has its own Option Pricing Engine and can therefore be used for
                        OTC Options trading</para>
            </listitem>
            <listitem>
                <para>AlgoTrader is built on Event Driven Architecture and therefore accommodates strategies
                    that are predominantly time-based and cannot be programed with traditional
                    procedural programming languages. Time-based Market Data Analysis and Signal
                    Generation are coded in SQL-like statements, whereas procedural actions like
                    placing an order are coded in plain Java Code. The combination of the two
                    provides a best-of-both-worlds approach. </para>
            </listitem>
            <listitem>
                <para>AlgoTrader is especially useful for strategies that need sophisticated time
                    window functions and can be expressed with words like during, between,
                    afterwards, parallel with, along with, finishes and begins with</para>
            </listitem>
            <listitem>
                <para>AlgoTrader is extensible and fully customizable for situations where strategy specific
                    functionalities are required. Full access to the Source Code of the System is
                    provided. By its pluggable architecture the system accommodates integration of
                    additional 3rd party libraries.</para>
            </listitem>
            <listitem>
                <para>Through its flexible and extensible architecture AlgoTrader is best suited for
                    quantitative strategies, that follow formal trading rules but have had to be
                    traded manually due to a lack of a suitable trading platform.  As long as a
                    trading strategy can be defined via a set of rules, AlgoTrader will be able to
                    accommodate it. </para>
            </listitem>
            <listitem>
                <para>AlgoTrader  enables rapid development of quantitative strategies that process
                    large volumes of market data </para>
            </listitem>
        </itemizedlist>
        <para>
            <emphasis role="bold">What it is not:</emphasis>
        </para>
        <itemizedlist>
            <listitem>
                <para>AlgoTrader is not a Chart based Trading Platform (like Tradestation, MetaTrader or
                    NinjaTrader). It does not have a fancy GUI with drag-and-drop functionality and
                    hundreds of indicators. It is our belief, that successful strategies are based
                    on economic facts and not on extensive back-testing or chart pattern analysis
                    based on many different technical indicators. AlgoTrader does have a GUI Front
                    end, but it's purpose is to give an overview of a strategy's current trading
                    activities and state in Live Trading. If a strategy is simple enough that it can
                    be developed with one of the above mentioned Platforms, it is recommended to use
                    them. However if specific requirements of a Strategy cannot be met by these
                    Platforms, AlgoTrader with its open architecture and available Source Code would
                    be the right choice.</para>
            </listitem>
            <listitem>
                <para>AlgoTrader is not a High-Frequency-Trading Application. If Latency in Microsecond or
                    Nanosecond range is of concern, other platforms will be a better fit. AlgoTrader
                    is best suited if complex trading logic is more important than being the first
                    at the market. However, AlgoTrader is very much optimized for high-throughput
                    and low latency, meaning that network design and distance to the executing
                    market will still have a much greater influence on latency, than the actual
                    internal processing inside AlgoTrader. </para>
            </listitem>
        </itemizedlist>
        <para>
            <emphasis role="bold">Features:</emphasis>
        </para>
        <itemizedlist>
            <listitem>
                <para>Automate Trading Strategies based on Complex Trading Rules</para>
            </listitem>
            <listitem>
                <para>Enables Development, Simulation and Live Trading of several strategies in
                    parallel</para>
            </listitem>
            <listitem>
                <para>Multiple Broker Interfaces: </para>
                <itemizedlist>
                    <listitem>
                        <para>Interactive Brokers (IB) Native </para>
                    </listitem>
                    <listitem>
                        <para>Interactive Brokers (IB) Fix (via  QuickFix/J)</para>
                    </listitem>
                    <listitem>
                        <para>JP Morgan via FIX (via  QuickFix/J)</para>
                    </listitem>
                    <listitem>
                        <para>DukasCopy via Fix (via  QuickFix/J)</para>
                    </listitem>
                    <listitem>
                        <para>additional Broker Interfaces can be added with minimal effort</para>
                    </listitem>
                </itemizedlist>
            </listitem>
            <listitem>
                <para>Multiple Market Data Providers:</para>
                <itemizedlist>
                    <listitem>
                        <para>Interactive Brokers </para>
                    </listitem>
                    <listitem>
                        <para>Bloomberg</para>
                    </listitem>
                </itemizedlist>
            </listitem>
            <listitem>
                <para>Support for wide array of security types and asset classes: e.g. Equities,
                        Indices, Futures, Options, Rates, Forex/ForexFuture, etc.</para>
            </listitem>
            <listitem>
                <para>Support for Synthetic Instruments &amp; Custom Derivative Spreads (i.e.
                        virtual Securities consisting of several different Futures, Options, etc.)
                    </para>
            </listitem>
            <listitem>
                <para>Different Order Types including Market, Limit, Stop, Stop Limit</para>
            </listitem>
            <listitem>
                <para>Several build-in Execution Algorithms: e.g. Slicing, Incremental and
                    Distributional Algos (additional ExecutionAlgos on request)</para>
            </listitem>
            <listitem>
                <para>Support for Multi Module Strategies (strategies that consist of several
                        modules that communicate with each other)</para>
            </listitem>
            <listitem>
                <para>Inter Module Communication based on Generic Events</para>
            </listitem>
            <listitem>
                <para>Custom Alerts and Trade Suggestions (via Email or Text Message) which allow manual
                    confirmation of automatically generated Signals</para>
            </listitem>
            <listitem>
                <para>Multi-Account Functionality (including Sub Account, Account Group and
                        Allocation Profile functionality)</para>
            </listitem>
            <listitem>
                <para>Sophisticated Client Application:</para>
                <itemizedlist>
                    <listitem>
                        <para>Full overview of Open Positions, Orders, Transactions,
                                Subscriptions, Cash Balances</para>
                    </listitem>
                    <listitem>
                        <para>Manual operations for Order Management, Position Management
                                (e.g. stops), System Parameters, Market Data Feed, Forex
                                Hedging, Portfolio Rebalancing , Position Transfers,
                                Customization of Synthetic Instruments &amp; Derivative Spreads,
                                etc.</para>
                    </listitem>
                    <listitem>
                        <para>Technical Management interface for: QuickFix Sessions, Esper
                                Engines, JDBC Connections, Logging Subsystem &amp; EhCache
                                Database Cache, etc.</para>
                    </listitem>
                    <listitem>
                        <para>Highly customizable Charting Functionality including Bars/Ticks,
                            Indicators, horizontal/vertical Markers, Annotations, etc.</para>
                    </listitem>
                    <listitem>
                        <para>Esper HQ based A multi-window user interface for management of Esper CEP engines, design
                            and deployment of Esper Statements as well as creation and launching of
                            configurable and interactive dashboards to present a one-screen overview
                            of the system (Cockpit)</para>
                    </listitem>
                    <listitem>
                        <para>Grails based CRUD Client (Create, Read, Update &amp; Delete) for
                            management of Reference Data (e.g. Strategies, Securities, Security
                            Families, Accounts, etc.)</para>
                    </listitem>
                </itemizedlist>
            </listitem>
            <listitem>
                <para>Automated Reconciliation Process with external Brokers (Trades, Current
                        Positions,Subscriptions &amp; Redemptions)</para>
            </listitem>
            <listitem>
                <para>Automated Forex Hedging (based on Spot FX or FX Futures)</para>
            </listitem>
            <listitem>
                <para>Options Pricing Engine using SABR Volatility Model</para>
            </listitem>
            <listitem>
                <para>Sophisticated Portfolio Tracking &amp; Performance Measurement via graphs,
                        key ratios, custom statistics (per strategy), etc.</para>
            </listitem>
            <listitem>
                <para>Integrated Risk Management and Money Management</para>
            </listitem>
            <listitem>
                <para>Different Numerical and Statistical Libraries</para>
            </listitem>
            <listitem>
                <para>Backtesting of strategies using Historical Tick- or Bar-Data and Exchange Simulator. After
                    Backtesting the same Code can be used for Live Trading</para>
            </listitem>
            <listitem>
                <para>Historical Data Download functionality</para>
            </listitem>
            <listitem>
                <para>Automated Parameter Optimization</para>
            </listitem>
            <listitem>
                <para>Multi JVM approach (RMI/JMS based communication) vs. One JVM based approach
                    (OSGI &amp; Spring DynamicModules)</para>
            </listitem>
            <listitem>
                <para>Scalable / Low Latency / High Throughput Architecture:</para>
                <itemizedlist>
                    <listitem>
                        <para>Scalability - Deployment onto multiple JVM's and/or multiple
                            Servers</para>
                    </listitem>
                    <listitem>
                        <para>High Throughput - Processing of large volumes of up to  500'000 market data events per
                            second on a dual CPU 2GHz Intel based hardware, see <ulink url="http://esper.codehaus.org/esper/performance/performance.html">Esper Performance</ulink></para>
                    </listitem>
                    <listitem>
                        <para>Low Latency - React in real-time to changing market conditions in timeframes below one
                            millisecond, see <ulink url="http://esper.codehaus.org/esper/performance/performance.html">Esper Performance</ulink></para>
                    </listitem>
                </itemizedlist>
            </listitem>
            <listitem>
                <para>High-Availability Server-Infrastructure based on a highly concurrent / memory
                    efficient / multi-threaded architecture</para>
            </listitem>
            <listitem>
                <para>Complex event processing (CEP) and event stream analysis of real-time or historical market
                    data enable detection of patterns among market data events (event correlation),
                    filter market data events, aggregate time or length windows of market data
                    events, join market data event streams, trigger based on absence of market data
                    events etc</para>
            </listitem>
            <listitem>
                <para>Hibernate / RDBMS based Persistence Framework. All Orders, Transactions,
                    Positions, Subscriptions, etc. are available in the Database where they can be
                    accessed for Reporting Purposes. All Write-Operations are carried out
                    asynchronous to minimize system latency.</para>
            </listitem>
            <listitem>
                <para>Dynamic Datamodel which allows to define custom properties (e.g. integer or
                    string property) on Entities like Strategy, Position &amp; Subscription </para>
            </listitem>
            <listitem>
                <para>Spring Profiles based system packaging to enable customization of deployed
                        Spring Services (e.g. FixOrderService types)</para>
            </listitem>
            <listitem>
                <para>Highly customizable Logging based on <ulink url="http://logging.apache.org/log4j/">log4j</ulink> including
                        Email-Logging, Text-Message-Logging, Portfolio Value Logging, etc.</para>
            </listitem>
            <listitem>
                <para>Subversion / Maven based development / Release and Change Management
                        Process</para>
            </listitem>
        </itemizedlist>
        <para>
            <emphasis role="bold">Technologies and architectural principals:</emphasis>
        </para>
        <itemizedlist>
            <listitem>
                <para>Event Driven Architecture / Complex Event Processing (CEP) using <ulink url="http://esper.codehaus.org/"> Esper</ulink>
                </para>
            </listitem>
            <listitem>
                <para>Model Driven Architecture based on <ulink url="http://www.uml.org/">
                            UML</ulink> and <ulink url="http://www.andromda.org/"> AndroMDA</ulink>
                </para>
            </listitem>
            <listitem>
                <para>Service Oriented Architecture using <ulink url="http://www.springsource.org/"> Spring
                        Framework</ulink>
                </para>
            </listitem>
            <listitem>
                <para>Persistence Framework based on <ulink url="http://www.hibernate.org">
                            Hibernate</ulink>
                </para>
            </listitem>
            <listitem>
                <para>Messaging based on JMS and <ulink url="http://activemq.apache.org/">
                            ActiveMQ</ulink>
                </para>
            </listitem>
            <listitem>
                <para>Fix Engine based on <ulink url="http://www.quickfixj.org/">
                            QuickFix/J</ulink>
                </para>
            </listitem>
            <listitem>
                <para>JDBC based Persistence Layer with Support for multiple RDBMS Database Types:</para>
                <itemizedlist>
                    <listitem>
                        <para>
                            <ulink url="http://www.oracle.com/us/products/database/overview/index.html"> Oracle</ulink>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <ulink url="http://www.mysql.com/"> MySql</ulink>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <ulink url="http://www.postgresql.org/"> PostgresQL</ulink>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <ulink url="http://www-01.ibm.com/software/data/db2/">
                                        DB2</ulink>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <ulink url="http://www.microsoft.com/en-us/sqlserver/default.aspx">
                                        MS SQL</ulink>
                        </para>
                    </listitem>
                </itemizedlist>
            </listitem>
        </itemizedlist>
    </chapter>
    <chapter id="Architecture">
        <title>Architecture</title>
        <para> The Architecture of AlgoTrader is composed of the following components. </para>
        <para>The Trading Framework called Base provides the infrastructure for all strategies running on
            top of it. The Base holds the main Esper Complex Event Processing (CEP) Engine. It is
            responsible for all Domain Model Objects and their persistence to the database.
            Different Market Data Adapters and  are available to process live as well as historical
            market data. On the other end Adapters for different Execution Brokers / Venues are
            available which are responsible for placing orders and receiving executions. </para>
        <para>In addition the Base provides Business Components for Portfolio Management,
            Performance Measurement, Risk Management, Money Management, Option Pricing,
            Reconciliation, FX Hedging and Parameter Optimization. </para>
        <para>On top of the Base any number of Strategies can be deployed. Each Strategy contains its own
            Esper CEP Engine. A Strategy can deploy any number of Esper EPL statements for temporal
            analysis of market data &amp; signals generation. Procedural actions are deployed as
            Java Code available to the Esper EPL statements. </para>
        <para>For management and monitoring of the system three different GUI Clients exist. The
            AlgoTrader JMX Client provides Trading related Functionality as well as general JVM
            Management Functionality. The EsperHQ Client is responsible for Management of all Esper
            CEP Engine. The Grails Client is a generic Client for Reference Data Management.</para>
        <figure>
            <title>Architecture</title>
            <mediaobject>
                <imageobject>
                    <imagedata scalefit="1" fileref="images/ArchitectureLayers.png"/>
                </imageobject>
            </mediaobject>
        </figure>
        <section>
            <title>Operating Systems</title>
            <para>The entire system is developed in Java. Therefor the system is portable to any
                environment. The System has been developed on a Windows 7 machine and has been in
                production on FreeBSD as well as CentOS based Linux Systems.</para>
        </section>
        <section>
            <title>Services and Processes</title>
            <para>The following Services and Process are used by the system:</para>
            <table frame="all" pgwide="1">
                <title>Services and Process</title>
                <tgroup cols="2">
                    <colspec colwidth="1*"/>
                    <colspec colwidth="3*"/>
                    <thead>
                        <row>
                            <entry>Service / Process</entry>
                            <entry>Description</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>Base</entry>
                            <entry>This is the main process that should be kept running all the time in order to record
                                market data without gaps</entry>
                        </row>
                        <row>
                            <entry>Strategies</entry>
                            <entry>In Live Trading Mode each strategy runs in its own Java process. In simulation mode,
                                the strategies run within the same process as the Base</entry>
                        </row>
                        <row>
                            <entry>ActiveMQ</entry>
                            <entry>this is the JMS (Java Messaging Service) Broker that is
                                responsible for transfering messages between the Base and the
                                Strategies</entry>
                        </row>
                        <row>
                            <entry>MySql</entry>
                            <entry>Database process</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
            <para>Because the Base and the strategies are running within separate processes,
                individual strategies can be stopped / altered / restarted independent of each other
                and the Base.</para>
            <para>Optionally the system can be deployed in an OSGi Container (like <ulink url="http://felix.apache.org/">Apache Felix</ulink>). This way the Base as well
                as strategies can be deployed as OSGi Modules within the same JVM. Because of the
                Class Loader Architecture of OSGi, strategies can still be stopped / altered /
                restarted independent of each other and the Base.</para>
        </section>
    </chapter>
    <chapter id="UML_Model">
        <title>UML Model</title>
        <para>The UML Model of the system is described in the following sections</para>
        <section>
            <title>Entities</title>
            <figure>
                <title>Entities Overview</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/Overview.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <figure>
                <title>Base Entities</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/BaseEntities.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>Each Entity defines fields and methods. For each field the necessary database
                columns are generated and for each method the necessary method signature is
                generated. A special type of method called finder method defines hibernate query
                statements for database lookup of entities.</para>
            <para>Relations are specified using common UML syntax. Based on that the necessary
                referential integrity and join tables are also generated automatically.</para>
            <para>The Main Entities of the system are specified within the following table:</para>
            <table frame="all" pgwide="1">
                <title>Entities</title>
                <tgroup cols="2">
                    <colspec colwidth="1*"/>
                    <colspec colwidth="3*"/>
                    <thead>
                        <row>
                            <entry>Entity</entry>
                            <entry>Description</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>Strategy</entry>
                            <entry>Each object of this class represents a running strategy within
                                the system</entry>
                        </row>
                        <row>
                            <entry>Security</entry>
                            <entry>This is the base class of all securities in the system</entry>
                        </row>
                        <row>
                            <entry>Subscription</entry>
                            <entry>Market Data Subscriptions of a Strategy for particular Securities are represented by
                                this class. For every Subscription the Strategy will receive Live
                                Market Data for the corresponding Security</entry>
                        </row>
                        <row>
                            <entry>MarketDataEvent</entry>
                            <entry>Represents any type of market data related to a particular Security</entry>
                        </row>
                        <row>
                            <entry>Order</entry>
                            <entry>An Order for a particular security</entry>
                        </row>
                        <row>
                            <entry>Account</entry>
                            <entry>Represents an actual account / account group / allocation profile
                                with an external Broker / Bank</entry>
                        </row>
                        <row>
                            <entry>Transaction</entry>
                            <entry>Each Fill is recorded as a transaction in the database using this
                                entity. In addition the table transaction also stores transactions
                                like intrest, debit, credit &amp; fees</entry>
                        </row>
                        <row>
                            <entry>Position</entry>
                            <entry>For each opening transaction a position is created which also
                                carries exit values and maintenance margin</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
            <section>
                <title>Strategy</title>
                <figure>
                    <title>Strategy</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/Strategy.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>There are several classes that are directly related to the strategy</para>
                <table frame="all" pgwide="1">
                    <title>Strategy Classes</title>
                    <tgroup cols="2">
                        <colspec colwidth="0.8*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Class</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>PortfolioValue</entry>
                                <entry>Every hour certain portfolio values (e.g. NetLiqValue,
                                    CashBalance, etc.) are saved to the database for every strategy.
                                    These will be displayed in the PortfolioChart for every strategy
                                    (in the client)</entry>
                            </row>
                            <row>
                                <entry>Measurement</entry>
                                <entry>Custom Measurements (e.g. current value of a custom indicator) related to a strategy
                                    can be saved using this class</entry>
                            </row>
                            <row>
                                <entry>CashBalance</entry>
                                <entry>A CashBalance represents the current cash amount of a
                                    particular strategy in a particular currency</entry>
                            </row>
                            <row>
                                <entry>OrderPreference</entry>
                                <entry>This class allows the definition of certain order default
                                    values for an order (e.g. quantity, orderType, delays, etc.).
                                    Except for the orderType, all values have to be defined through
                                    Properties. The method
                                        <classname>LookupService.getOrderByName()</classname> will
                                    lookup an orderPreference by its name, instantiate the
                                    corresponding OrderType and set all properties.</entry>
                            </row>
                            <row>
                                <entry>DefaultOrderPreference</entry>
                                <entry>This class allows the assignment of an OrderPreference and
                                    SecurityFamily for an individual strategy. This is useful for
                                    situations where the Base has to send an order regarding a
                                    position that belongs to a strategy (e.g. ClosePosition when the
                                    ExitValue is reached). The method
                                        <classname>LookupService.getOrderByStrategyAndSecurityFamily()</classname>
                                    will lookup a defaultOrderPreference by the specified
                                    strategyName and securityFamily, instantiate the corresponding
                                    OrderType and set all properties.</entry>
                            </row>
                            <row>
                                <entry>Allocation</entry>
                                <entry>
                                    <para>If an OrderPreference is defined for an OrderType that
                                        sends orders to multiple accounts (e.g. DistributingOrder),
                                        allocations to different accounts can be defined.</para>
                                    <para>
                                        <emphasis>Note: the total of all allocations needs to be
                                            1.0</emphasis>
                                    </para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>Security</title>
                <figure>
                    <title>Securities</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/Security.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>The above UML Class diagram shows all available Security classes and related
                    SecurityFamilies</para>
                <table frame="all">
                    <title>Security Types</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="3*"/>
                        <thead>
                            <row>
                                <entry>Entity</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>StockOption</entry>
                                <entry>
                                    <para>A tradeable Option</para>
                                    <para>
                                        <emphasis role="italic">Note: because Option is a
                                                reserved keyword, the Entity was called
                                                StockOption</emphasis>
                                    </para>
                                </entry>
                            </row>
                            <row>
                                <entry>Future</entry>
                                <entry>A tradeable Future</entry>
                            </row>
                            <row>
                                <entry>Forex</entry>
                                <entry>A Foreign Exchange Currency</entry>
                            </row>
                            <row>
                                <entry>ForexFuture</entry>
                                <entry>A Foreign Exchange Future</entry>
                            </row>
                            <row>
                                <entry>Stock</entry>
                                <entry>A Single Stock</entry>
                            </row>
                            <row>
                                <entry>GenericFuture</entry>
                                <entry>A virtual Future with a fixed duration</entry>
                            </row>
                            <row>
                                <entry>Implied Volatility</entry>
                                <entry>
                                    <para>A virtual Security representing a certain Duration,
                                            either Moneyness or Delta and an Option Type.</para>
                                    <para>
                                        <emphasis role="italic">Note: Prices to this Security
                                                represent Volatilities</emphasis>
                                    </para>
                                </entry>
                            </row>
                            <row>
                                <entry>IntrestRate</entry>
                                <entry>Any type of Intrest Rate</entry>
                            </row>
                            <row>
                                <entry>Natural Index</entry>
                                <entry>
                                    <para>Any type of Index</para>
                                    <para>
                                        <emphasis role="italic">Note: because Index is a
                                                reserved keyword, the Entity was called
                                                NaturalIndex</emphasis>
                                    </para>
                                </entry>
                            </row>
                            <row>
                                <entry>Combination</entry>
                                <entry>A synthetic security composed of one or many Components
                                        (see <xref linkend="Synthetic_Instruments_and_Derivative_Spreads"/>)</entry>
                            </row>
                            <row>
                                <entry>SyntheticIndex</entry>
                                <entry>A synthetic security based on an arbitrary class which
                                        implements the pricing logic (e.g. a Volatility Index
                                        calculating its price based on the Implied Volatility of its
                                        underlying Options)</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
                <para>A Security Family contains the common information about an entire family
                    of securities (i.e. all general information about options on S&amp;P500 are
                    stored using this class). The class provides fields like market, currency,
                    market opening hour &amp; market closing hour.</para>
            </section>
            <section>
                <title>Market Data Events</title>
                <figure>
                    <title>Market Data Event</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/MarketDataEvent.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>Market Data exists in two different kinds:</para>
                <table frame="all" pgwide="1">
                    <title>Market Data Types</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="3*"/>
                        <thead>
                            <row>
                                <entry>Entity</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>Bar</entry>
                                <entry>Open-High-Low-Close Bars / Candles</entry>
                            </row>
                            <row>
                                <entry>Tick</entry>
                                <entry>Snapshot of the market at a particular point in time,
                                    containing information like last price, last time, bid, ask,
                                    volume, etc.</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
                <para>For simulation purposes Bars and Ticks can be supplied through CSV files (see
                        <xref linkend="Market_Data_File_Format"/>). In live trading Trades, Bids and
                    Asks are received by the broker specific MarketDataService and routed to the
                    Esper Service Instances.</para>
                <para>Live Order Book Data will be available in near future.</para>
            </section>
            <section id="Order">
                <title>Order</title>
                <figure>
                    <title>Orders</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/Trade.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>The following UML Class diagram shows the Order and its related
                    subclasses.</para>
                <table frame="all" pgwide="1">
                    <title>Order Classes</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Entity</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>Order</entry>
                                <entry>Base Class for all Order Types</entry>
                            </row>
                            <row>
                                <entry>OrderStatus</entry>
                                <entry>Order Status changes received back from the Broker (i.e.
                                    PARTIALLY_EXECUTED or CANCELLED) are represented by this class
                                </entry>
                            </row>
                            <row>
                                <entry>Fill</entry>
                                <entry>Filled orders are represented by this Class</entry>
                            </row>
                            <row>
                                <entry>Transaction</entry>
                                <entry>Each Fill is recorded as a transaction in the database using
                                    this entity. In addition the table transaction also carries
                                    transactions like intrest, debit, credit &amp; fees</entry>
                            </row>
                            <row>
                                <entry>SimpleOrder</entry>
                                <entry>An Order that can be sent directly to the market</entry>
                            </row>
                            <row>
                                <entry>MarketOrder</entry>
                                <entry morerows="3"> Predefined SimpleOrder types</entry>
                            </row>
                            <row>
                                <entry>LimitOrder</entry>
                            </row>
                            <row>
                                <entry>StopOrder</entry>
                            </row>
                            <row>
                                <entry>StopLimitOrder</entry>
                            </row>
                            <row>
                                <entry>AlgoOrder</entry>
                                <entry>A composite order that will generate multiple SimpleOrders.
                                    An AlgoOrder cannot be sent directly to the market</entry>
                            </row>
                            <row>
                                <entry>SlicingOrder</entry>
                                <entry>An AlgoOrder, that will split a large trade into multiple "slices". The size of the
                                    slice, time in the market and delay between orders are
                                    randomized within the specified range.</entry>
                            </row>
                            <row>
                                <entry>Incremental Limit Order</entry>
                                <entry>AlgoOrder that will "step through" the spread using
                                    LimitOrders with incremental limits</entry>
                            </row>
                            <row>
                                <entry>TickwiseIncrementalLimitOrder</entry>
                                <entry>Will step through the spread Tick-by-Tick</entry>
                            </row>
                            <row>
                                <entry>VariableIncrementalLimitOrder</entry>
                                <entry>Will step through the spread by a specified percentage of the
                                    spread</entry>
                            </row>
                            <row>
                                <entry>DistributionalOrder</entry>
                                <entry>An order that generates multiple simple orders, each targeted at a different account
                                    according to defined allocation</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>Account</title>
                <para>An Account represents either an actual account, an account group (IB specific)
                    or an allocation profile (IB specific). An account is assigned to a particular
                    OrderServiceType (e.g. IB_NATIVE or IB_FIX). In addition there is the field
                    sessionQualifier which is needed to define the actual session in place
                    (primarily for FIX Connections). With this setup, it is possible to have
                    multiple Sessions (SessionQualifiers) per OrderServiceType and to have multiple
                    Accounts per Session.</para>
                <note>
                    <para>Orders sent to the market will always contain Account related information
                        in an adequate way (e.g. as a FIX Tag 1). Also Transactions which are based
                        on an actual trade will have an association with a particular Account.
                        However Positions do not hold any information regarding Accounts. It is
                        therefore possible that a Position holds aggregated Quantities from several
                        external Accounts. With this setup Strategies do not have to worry about the
                        actual Accounts the funds are located in. This way, a strategy will always
                        only see one Position per Security.</para>
                </note>
            </section>
            <section>
                <title>Position</title>
                <para>For any Strategy holding a particular Security in its portfolio a Position will be created
                    in the database. Even if this position is later on closed (i.e. quantity = 0)
                    the position will still remain in the database, because the associated
                    Transactions still have references to it.</para>
                <para>In general, position values (e.g. marketPrice, marketValue, averagePrice, cost, unrealized
                    / realized PL) are calculated per actual strategy related position and show the
                    price that would need to payed if the position was closed at this moment</para>
                <para>Since some values (e.g. marketValue) depend on whether the position is long or
                    short, aggregated position values for the same security (of different
                    strategies) cannot be retrieved just by adding position values from the
                    corresponding strategies. Example:</para>
                <itemizedlist>
                    <listitem>
                        <para>Security: VIX Dec 2012</para>
                    </listitem>
                    <listitem>
                        <para>Current Bid: 16.50</para>
                    </listitem>
                    <listitem>
                        <para>Current Ask: 16.60</para>
                    </listitem>
                    <listitem>
                        <para>Strategy A: quantity +10 -&gt; marketValue: 10 * 1000 * 16.50 =
                            165'000</para>
                    </listitem>
                    <listitem>
                        <para>Strategy B: quantity -10 -&gt; marketValue: 10 * 1000 * 16.60 =
                            -166'000</para>
                    </listitem>
                </itemizedlist>
                <para>The sum of above marketValues would be -1'000 which is obviously wrong.</para>
                <para>As a consequence the PortfolioDAO provides lookup-methods that aggregate
                    positions from the same security (of different strategies) in the correct manner
                    (e.g. <methodname>findOpenPositionsAggregated</methodname>).</para>
            </section>
            <section>
                <title>Property</title>
                <figure>
                    <title>Properties and PropertyHolders</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/Property.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>The classes Strategy, Position, Subscription and OrderPreference are derived
                    from the abstract class PropertyHolder. Therefore one or more Properties can be
                    assigned to them. A Property can be of type int, double, money, text, date or
                    boolean (but only one at a time).</para>
                <para>Because PropertyHolders use Hibernate Union-Subclass strategy, Id's of
                    different PropertyHolder tables may not overlap. For PropertyHolders created
                    directly in the database, the following range of Id's are reserved:</para>
                <table frame="all" pgwide="1">
                    <title>PropertyHolder Ranges</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>PropertyHolder</entry>
                                <entry>Range</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>Strategy</entry>
                                <entry>0 - 99</entry>
                            </row>
                            <row>
                                <entry>Subscription</entry>
                                <entry>100 - 199</entry>
                            </row>
                            <row>
                                <entry>OrderPreference</entry>
                                <entry>200 - 299</entry>
                            </row>
                            <row>
                                <entry>Position</entry>
                                <entry>300 - 399</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
        </section>
        <section>
            <title>Services</title>
            <para>The system is based on a Service Oriented Architecture (SOA). All operations of
                the system are provided as Spring Services / Beans. The following groups of services
                exist:</para>
            <orderedlist numeration="arabic">
                <listitem>
                    <para>Base Services</para>
                </listitem>
                <listitem>
                    <para>Private Services, which are only used by the Base</para>
                </listitem>
                <listitem>
                    <para>Client Services, which will be instantiated by each Strategy (and the
                        Base itself)</para>
                </listitem>
            </orderedlist>
            <section>
                <title>Base Services</title>
                <table frame="all" pgwide="1">
                    <title>Base Services</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Service</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>MarketDataService</entry>
                                <entry>Responsible for the retrieval of MarketData as well as
                                    Subscription Management. This service is also responsible for
                                    generating simulated ticks in simulation mode (i.e. generate
                                    option ticks based on underlying and volatility ticks)</entry>
                            </row>
                            <row>
                                <entry>OrderService</entry>
                                <entry>Responsible for sending orders to the Market via defined
                                    Broker Interface</entry>
                            </row>
                            <row>
                                <entry>PositionService</entry>
                                <entry>Responsible for management of positions, i.e. close position,
                                    reduce position and set an exit value</entry>
                            </row>
                            <row>
                                <entry>AccountService</entry>
                                <entry>Responsible for checking Order Quantities across several accounts</entry>
                            </row>
                            <row>
                                <entry>HistoricalDataService</entry>
                                <entry>The HistoricalDataService is used to retrieve historical data
                                    of symbols specified</entry>
                            </row>
                            <row>
                                <entry>CombinationService</entry>
                                <entry>The CombinationService is responsible for handling all
                                    Combination / Component related DB-Operations.</entry>
                            </row>
                            <row>
                                <entry>LazyLoaderService</entry>
                                <entry>This service makes the standard Hibernate
                                    Lazy-Loading-Mechanism available to Strategies (that run in a
                                    different process)</entry>
                            </row>
                            <row>
                                <entry>ForexService</entry>
                                <entry>This service is responsible for the FX hedging mechanism
                                </entry>
                            </row>
                            <row>
                                <entry>StockOptionService</entry>
                                <entry morerows="1"> These services are responsible for all option
                                    and future specific operations like expire options, margin
                                    handling as well as creation of dummy (simulated) stock options
                                    in simulation mode</entry>
                            </row>
                            <row>
                                <entry>FutureService</entry>
                            </row>
                            <row>
                                <entry>LookupService</entry>
                                <entry>This service provides general data lookup operations to other
                                    services</entry>
                            </row>
                            <row>
                                <entry>PortfolioService</entry>
                                <entry>This service is responsible for providing actual database
                                    values to the ManagementService</entry>
                            </row>
                            <row>
                                <entry>MeasurementService</entry>
                                <entry>Responsible for persistence and retrieval of Measurements
                                    related to Strategy</entry>
                            </row>
                            <row>
                                <entry>PropertyService</entry>
                                <entry>Responsible for persistence of Properties related to a
                                    PropertyHolder</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>Private Services</title>
                <table frame="all" pgwide="1">
                    <title>Private Services</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Service</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>TransactionService</entry>
                                <entry>This service is responsible for storing transactions in the
                                    database</entry>
                            </row>
                            <row>
                                <entry>CashBalanceService</entry>
                                <entry>This service manages CashBalances</entry>
                            </row>
                            <row>
                                <entry>SimulationService</entry>
                                <entry>Responsible for carrying out simulations and automated
                                    parameter optimizations</entry>
                            </row>
                            <row>
                                <entry>ImportService</entry>
                                <entry>This service enables import of market data from CSV files
                                </entry>
                            </row>
                            <row>
                                <entry>SecurityRetrieverService</entry>
                                <entry>This service downloads current option and future chains using
                                    the broker interface</entry>
                            </row>
                            <row>
                                <entry>BaseManagementService</entry>
                                <entry>This service provides management features of the Base itself
                                    like reconnect to the broker interface, close positions, set
                                    exit value, reduce position and display connection
                                    states.</entry>
                            </row>
                            <row>
                                <entry>TestService</entry>
                                <entry>This service is used for testing purposes only</entry>
                            </row>
                            <row>
                                <entry>ForexService</entry>
                                <entry>Responsible for the FX Hedging functionality</entry>
                            </row>
                            <row>
                                <entry>ResetService</entry>
                                <entry>Responsible for restoring the DB state before the start of a
                                    simulation</entry>
                            </row>
                            <row>
                                <entry>PortfolioPersistenceService</entry>
                                <entry>This service is responsible for operations like rebalancing and persistence of
                                    PortfolioValues</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>Client Services</title>
                <table frame="all" pgwide="1">
                    <title>Client Services</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="3*"/>
                        <thead>
                            <row>
                                <entry>Service</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>ManagementService</entry>
                                <entry>This services provides the JMX Management function of the
                                    system. The ManagementService is therefore tagged as
                                        <parameter>@algoTrader.service.manageable</parameter>. The
                                    ManagementService is provided by each strategy as well as by the
                                    Base itself and displays all relevant financial data at the
                                    current time, i.e. Strategy Name, Cash Balance, Net Liquidation
                                    Value, Leverage, Margin, Positions, Last Ticks, Last
                                    Transactions, FX-Balances.</entry>
                            </row>
                            <row>
                                <entry>SubscriptionService</entry>
                                <entry>This service is used by the strategy for subscription
                                    management. The actual DB related operations are carried out by
                                    the MarketDataService</entry>
                            </row>
                            <row>
                                <entry>StrategyService</entry>
                                <entry>This is the base class for all strategy services which has
                                    references to all necessary services of the Base</entry>
                            </row>
                            <row>
                                <entry>ChartProvidingService</entry>
                                <entry>Base class for all Services that provide charting
                                    functionality (see <xref linkend="Charts"/>)</entry>
                            </row>
                            <row>
                                <entry>PortfolioChartService</entry>
                                <entry>Chart Service for Portfolio Charts (see <xref linkend="Portfolio_Chart"/>)</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>Order Services</title>
                <figure>
                    <title>Order Services</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/OrderServices.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>All OrderServices are derived from the general ExternalOrderService.</para>
            </section>
            <section>
                <title>Market Data Services</title>
                <figure>
                    <title>Market Data Services</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/MarketDataServices.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>For every external Market Data Provider a subclass of MarketDataService
                    has to be implemented</para>
            </section>
            <section>
                <title>Reconciliation Services</title>
                <figure>
                    <title>Reconciliation</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/ReconciliationServices.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>Every BrokerInterface that needs automated reconciliation has to derive a
                    ReconciliationService from the abstract ReconciliationService. For further
                    information see <xref linkend="Reconciliation"/>
                </para>
            </section>
            <section>
                <title>Account Services</title>
                <figure>
                    <title>Account Services</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/AccountServices.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>If AlgoTrader is used in a Managed Account setup, subclasses of the abstract
                    AccountService have to provide methods for checking the order quantity of an
                    order to ensure that an even number of shares is allocated to each account. In
                    addition subclasses of AccountService can implement methods for manipulationg
                    Account Groups, Allocation Profiles or similar Broker specific
                    functionality.</para>
            </section>
            <section>
                <title>IB Services</title>
                <figure>
                    <title>IB Services</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/IBServices.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>The diagram above shows IB implementations of remaining abstract broker
                    interface classes.</para>
            </section>
        </section>
        <section>
            <title>Value Object</title>
            <figure>
                <title>Value Objects</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/ValueObjects.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <figure>
                <title>Private Value Objects</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/PrivateValueObjects.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <figure>
                <title>Chart Value Objects</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/ChartValueObjects.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>Value objects are provided for situations where database persistence is not
                necessary or not available. If a value object corresponds to an entity, this can be
                indicated using an association, which leads to the corresponding mapping methods
                being generated by AndroMDA. Value objects are pure Java Beans and do not contain
                operations.</para>
            <para>The diagrams above show the value objects provided by the system. Private Value
                Objects are in use only by the Base.</para>
        </section>
        <section>
            <title>Enumeration</title>
            <figure>
                <title>Enumerations</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/Enumerations.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>Enumerations are generated into JDK 5 Enumerations.</para>
        </section>
        <section>
            <title>Dependencies</title>
            <figure>
                <title>Dependencies</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/Dependencies.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>Dependencies between services and between services and entities (data access objects) are
                modeled using UML dependencies. At runtime dependencies are automatically injected
                using the Spring Framework.</para>
        </section>
    </chapter>
    <chapter id="Code_Generation">
        <title>Code Generation</title>
        <para>The entire system is developed by means of Model Driven Architecture (MDA) using the
            framework <ulink url="http://www.andromda.org">AndroMDA</ulink>.</para>
        <para>The following links and tutorials give a good overview of Code Generator with
            AndroMDA:</para>
        <itemizedlist>
            <listitem>
                <para>
                    <ulink url="http://www.andromda.org/contrib/birds-eye-view.html">A Bird's
                            Eye view of AndroMDA</ulink>
                </para>
            </listitem>
            <listitem>
                <para>
                    <ulink url="http://www.andromda.org/starting.html">Getting started with
                            AndroMDA</ulink>
                </para>
            </listitem>
            <listitem>
                <para>
                    <ulink url="http://www.andromda.org/andromda-documentation/getting-started-java/index.html"> Getting started Java</ulink>
                </para>
            </listitem>
            <listitem>
                <para>
                    <ulink url="http://www.andromda.org/docs/andromda-cartridges/andromda-spring-cartridge/howto.html">Spring Cartridge HowTo</ulink>
                </para>
            </listitem>
            <listitem>
                <para>
                    <ulink url="http://forum.andromda.org/">AndroMDA's forum</ulink>
                </para>
            </listitem>
        </itemizedlist>
        <para>Much of the system is modeled in UML. It is recommended to use MagicDraw for modelling
            (see <xref linkend="Platform_requirements"/>)</para>
        <para>The actual UML Model is defined in the following xmi file:
                <classname>/algotrader/mda/src/main/uml/algotrader.xml</classname>
        </para>
        <para>The model is transferred into code by means of <ulink url="http://www.andromda.org">
                AndroMDA</ulink> which uses <ulink url="http://maven.apache.org"> Maven</ulink>
            artifacts and <ulink url="http://velocity.apache.org"> Velocity</ulink> templates for
            code generation.</para>
        <para>Generated code is placed under the directory
                <filename>/target/src/main/java</filename>, whereas implementation classes are
            generated into the directory <filename>/src</filename> with only the method
            signatures.</para>
        <para>Configuration of the code generator is placed into the <filename>/mda</filename>
            directory. It is also this directory that contains template modifications as well as
            mappings from UML artifacts to Java / Database objects.</para>
        <note>
            <itemizedlist>
                <listitem>
                    <para>When opening the file algotrader.xml for the first time, the location of
                        the Maven 2 Repository has to be defined. This is usually in
                            <filename>user-home-directory/.m2/repository</filename>.</para>
                </listitem>
                <listitem>
                    <para>In addition the path to the UML-Standard-Profile has to be defined. This
                        file lies in the profiles sub directory of the MagicDraw Installation
                        directory (e.g.,
                            <filename>..\MagicDraw\profiles\UML_Standard_Profile.xml</filename>)
                    </para>
                </listitem>
            </itemizedlist>
        </note>
        <section>
            <title>Tagged Values</title>
            <para>The following custom tagged values are used in the UML Model:</para>
            <variablelist>
                <varlistentry>
                    <term>algoTrader_entity_transient</term>
                    <listitem>
                        <para>an entity that is not persisted to the database (no hbm.xml and table
                            definitions will be generated)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_finder_method_locked</term>
                    <listitem>
                        <para>a finder method that will use table locking (see <xref linkend="Hibernate_Locking"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_finder_method_native_query</term>
                    <listitem>
                        <para>a native sql query (as opposed to a hibernate query)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_finder_method_native_query_entity</term>
                    <listitem>
                        <para>defines the entity (fully qualified class name) that should be mapped
                            through this native query</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_service_client</term>
                    <listitem>
                        <para>a service that will be available locally inside strategies (as opposed
                            to a service that is invoked over RMI from the client)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_service_manageable</term>
                    <listitem>
                        <para>a service that is manageable via JMX</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_service_method_manageable</term>
                    <listitem>
                        <para>a service method that is manageable via JMX</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_service_method_manageable_attribute</term>
                    <listitem>
                        <para>a service method that is displayed as an attribute via JMX</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_service_no_transaction_interceptor</term>
                    <listitem>
                        <para>a service that does not have a transaction interceptor associated (for
                            services that do not contain any CRUD operations)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_service_no_hibernate_interceptor</term>
                    <listitem>
                        <para>a service that does not have a hibernate interceptor associated (for
                            services that do not access the database at all)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_service_profile</term>
                    <listitem>
                        <para>assigns one or more Spring Framework profiles to this service</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_service_alias</term>
                    <listitem>
                        <para>assigns a Spring Framework alias to this service</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algoTrader_value_object_private</term>
                    <listitem>
                        <para>a value object that will not be visible to clients</para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>The following standard AndroMDA tagged values are used in the UML Model:</para>
            <itemizedlist>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_collection_index"> andromda_hibernate_collection_index</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_collection_type"> andromda_hibernate_collection_type</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_ehcache_maxElementsInMemory"> andromda_hibernate_ehcache_maxElementsInMemory</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_entity_cache"> andromda_hibernate_entity_cache</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_generator_class"> andromda_hibernate_generator_class</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_inheritance"> andromda_hibernate_inheritance</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_lazy"> andromda_hibernate_lazy</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_outerjoin"> andromda_hibernate_outerjoin</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_query"> andromda_hibernate_query</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_query_useCache"> andromda_hibernate_query_useCache</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-hibernate-cartridge/profile.html#andromda_hibernate_version"> andromda_hibernate_version</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-spring-cartridge/profile.html#andromda_service_private"> andromda_service_private</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-spring-cartridge/profile.html#andromda_spring_service_config_only"> andromda_spring_service_config_only</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-spring-cartridge/profile.html#andromda_spring_service_remoting_type"> andromda_spring_service_remoting_type</ulink>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <ulink url="http://www.andromda.org/andromda-cartridges/andromda-spring-cartridge/profile.html#andromda_spring_transaction_type"> andromda_spring_transaction_type</ulink>
                    </para>
                </listitem>
            </itemizedlist>
        </section>
    </chapter>
    <chapter id="Java_Environment">
        <title>Java Environment</title>
        <section>
            <title>Eclipse Projects</title>
            <para>The Framework AlgoTrader consists of the following Eclipse Projects:</para>
            <variablelist>
                <varlistentry>
                    <term>algotrader</term>
                    <listitem>
                        <para>the main project</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algotrader/common</term>
                    <listitem>
                        <para>contains java code directly needed by the strategies</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algotrader/core</term>
                    <listitem>
                        <para>contains internal java code only needed by the Base</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algotrader/mda</term>
                    <listitem>
                        <para>UML Model and code generator see <xref linkend="Code_Generation"/>
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algotrader/client</term>
                    <listitem>
                        <para>JMX Client based on JConsole</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algotrader/crud</term>
                    <listitem>
                        <para>DB management application for reference Data based on <ulink url="http://grails.org/"> Grails</ulink>
                        </para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>algotrader/doc</term>
                    <listitem>
                        <para>Documentation based on <ulink url="http://www.docbook.org/">
                                DocBook</ulink>, <ulink url="http://sagehill.net/docbookxsl/index.html"> DocBook XSL</ulink>
                            and <ulink url="http://www.jboss.org/pressgang"> JBoss Pressgang</ulink>
                        </para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <section>
                <title>common project</title>
                <para>the algotrader common project has the following structure:</para>
                <table frame="all" pgwide="1">
                    <title>common project</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Directory</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>
                                    <filename>src/main/java</filename>
                                </entry>
                                <entry>manually created source files</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>target/src/main/java</filename>
                                </entry>
                                <entry>generated source files</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>src/main/resouces</filename>
                                </entry>
                                <entry>configuration files</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>core project</title>
                <para>the algotrader core project has the following structure:</para>
                <table frame="all" pgwide="1">
                    <title>core project</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Directory</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>
                                    <filename>src/main/java </filename>
                                </entry>
                                <entry>manually created source files</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>target/src/main/java</filename>
                                </entry>
                                <entry>generated source files</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>src/main/resouces</filename>
                                </entry>
                                <entry>configuration files</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>bin</filename>
                                </entry>
                                <entry>Launch configuration and shell start scripts</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>files</filename>
                                </entry>
                                <entry>files which are created (i.e. copy of retrieved HTML code) or
                                    imported (i.e. Tick Data) into the system</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>lib</filename>
                                </entry>
                                <entry>jar files not available through maven</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>log</filename>
                                </entry>
                                <entry>contains log files</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>sql</filename>
                                </entry>
                                <entry>SQL scripts</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>mda project</title>
                <para>the algotrader mda project has the following structure:</para>
                <table frame="all" pgwide="1">
                    <title>mda project</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Directory</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>
                                    <filename>bin</filename>
                                </entry>
                                <entry>Launch configuration and shell start scripts</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>src/main/config</filename>
                                </entry>
                                <entry>AndroMDA config files, custom templates and mapping files </entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>src/main/uml</filename>
                                </entry>
                                <entry>Contains the UML Model</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>strategy projects</title>
                <para>The strategy projects algotrader-xxx have the following structure:</para>
                <table frame="all" pgwide="1">
                    <title>strategy projects</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Directory</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>
                                    <filename>src/main/java</filename>
                                </entry>
                                <entry>java code</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>src/main/resources</filename>
                                </entry>
                                <entry>config files</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>bin</filename>
                                </entry>
                                <entry>Launch configuration and shell start scripts</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>lib</filename>
                                </entry>
                                <entry>jar files not available through maven</entry>
                            </row>
                            <row>
                                <entry>
                                    <filename>log</filename>
                                </entry>
                                <entry>log files</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
        </section>
        <section>
            <title>Java Packages</title>
            <para>The following table gives an overview of the provided java packages:</para>
            <table frame="all" pgwide="1">
                <title>Java Packages</title>
                <tgroup cols="2">
                    <colspec colwidth="1.5*"/>
                    <colspec colwidth="2*"/>
                    <thead>
                        <row>
                            <entry>Package</entry>
                            <entry>Description</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>
                                <classname>com.algoTrader</classname>
                            </entry>
                            <entry>ServiceLocators</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.client.*</classname>
                            </entry>
                            <entry>Jconsole client</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.entity.*</classname>
                            </entry>
                            <entry>Entities and corresponding Hibernate DataAccessObjects</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.enumeration</classname>
                            </entry>
                            <entry>Enumerations</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.esper.*</classname>
                            </entry>
                            <entry>Files used for Esper (i.e. aggregation functions, listeners and
                                subscribers)</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.future</classname>
                            </entry>
                            <entry>Contains classes specific to Futures</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.service.*</classname>
                            </entry>
                            <entry>Contains all Spring Services</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.stockOption</classname>
                            </entry>
                            <entry>Contains classes specific to Options, Volatility &amp; SABR
                                Volatility Model</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.starter</classname>
                            </entry>
                            <entry>Startup-Classes as well as a generic ServiceInvoker</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.util.*</classname>
                            </entry>
                            <entry>General Utility methods</entry>
                        </row>
                        <row>
                            <entry>
                                <classname>com.algoTrader.vo</classname>
                            </entry>
                            <entry>ValueObjects</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section id="Maven_Environment">
            <title>Maven Environment</title>
            <para>AlgoTrader uses <ulink url="http://maven.apache.org/"> Maven</ulink> as its build
                management framework. Every project/module therefore has it's own pom.xml (Project
                Object Model) defining its structure and dependencies.</para>
            <para>The entire Release Process of AlgoTrader is based on the <ulink url="http://maven.apache.org/maven-release/maven-release-plugin/"> Maven Release
                    Plugin</ulink>. Releases are deployed to the following repository: <ulink url="https://repo.algotrader.ch/maven">https://repo.algotrader.ch/maven</ulink>
            </para>
            <para>The following parent-child relationships and dependencies exist between the
                individual projects:</para>
            <figure>
                <title>IB Services</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/MavenDependencies.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <section>
                <title>algotrader (dependency management)</title>
                <table frame="all" pgwide="1">
                    <title>algotrader dependencies</title>
                    <tgroup cols="3">
                        <thead>
                            <row>
                                <entry>ArtifactId</entry>
                                <entry>GroupId</entry>
                                <entry>Version</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>commons-beanutils</entry>
                                <entry>commons-beanutils</entry>
                                <entry>1.8.3</entry>
                            </row>
                            <row>
                                <entry>commons-codec</entry>
                                <entry>commons-codec</entry>
                                <entry>1.6</entry>
                            </row>
                            <row>
                                <entry>commons-collections</entry>
                                <entry>commons-collections</entry>
                                <entry>3.2.1</entry>
                            </row>
                            <row>
                                <entry>commons-httpclient</entry>
                                <entry>commons-httpclient</entry>
                                <entry>3.1</entry>
                            </row>
                            <row>
                                <entry>commons-io</entry>
                                <entry>commons-io</entry>
                                <entry>2.1</entry>
                            </row>
                            <row>
                                <entry>commons-lang</entry>
                                <entry>commons-lang</entry>
                                <entry>2.6</entry>
                            </row>
                            <row>
                                <entry>commons-logging</entry>
                                <entry>commons-logging</entry>
                                <entry>1.1.1</entry>
                            </row>
                            <row>
                                <entry>org.apache.commons</entry>
                                <entry>commons-math</entry>
                                <entry>2.2</entry>
                            </row>
                            <row>
                                <entry>junit</entry>
                                <entry>junit</entry>
                                <entry>4.10</entry>
                            </row>
                            <row>
                                <entry>log4j</entry>
                                <entry>log4j</entry>
                                <entry>1.2.16</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>algotrader-common</title>
                <table frame="all" pgwide="1">
                    <title>algotrader-common dependencies</title>
                    <tgroup cols="3">
                        <thead>
                            <row>
                                <entry>ArtifactId</entry>
                                <entry>GroupId</entry>
                                <entry>Version</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>org.apache.activemq</entry>
                                <entry>activemq-core</entry>
                                <entry>5.5.1</entry>
                            </row>
                            <row>
                                <entry>net.sourceforge.collections</entry>
                                <entry>collections-generic</entry>
                                <entry>4.01</entry>
                            </row>
                            <row>
                                <entry>commons-beanutils</entry>
                                <entry>commons-beanutils</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>commons-collections</entry>
                                <entry>commons-collections</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>commons-lang</entry>
                                <entry>commons-lang</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>commons-logging</entry>
                                <entry>commons-logging</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>org.apache.commons</entry>
                                <entry>commons-math</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>com.espertech</entry>
                                <entry>esper</entry>
                                <entry>4.8.0</entry>
                            </row>
                            <row>
                                <entry>com.espertech</entry>
                                <entry>esperee-jmx</entry>
                                <entry>4.8.0</entry>
                            </row>
                            <row>
                                <entry>com.espertech</entry>
                                <entry>esperio-csv</entry>
                                <entry>4.8.0</entry>
                            </row>
                            <row>
                                <entry>com.espertech</entry>
                                <entry>esperio-springjms</entry>
                                <entry>4.8.0</entry>
                            </row>
                            <row>
                                <entry>org.hibernate</entry>
                                <entry>hibernate-core</entry>
                                <entry>3.6.9.Final</entry>
                            </row>
                            <row>
                                <entry>javassist</entry>
                                <entry>javassist</entry>
                                <entry>3.12.1.GA</entry>
                            </row>
                            <row>
                                <entry>javax.mail</entry>
                                <entry>mail</entry>
                                <entry>1.4.1</entry>
                            </row>
                            <row>
                                <entry>org.springframework</entry>
                                <entry>spring-beans</entry>
                                <entry>3.1.0.RELEASE</entry>
                            </row>
                            <row>
                                <entry>org.springframework</entry>
                                <entry>spring-context</entry>
                                <entry>3.1.0.RELEASE</entry>
                            </row>
                            <row>
                                <entry>org.springframework</entry>
                                <entry>spring-core</entry>
                                <entry>3.1.0.RELEASE</entry>
                            </row>
                            <row>
                                <entry>org.ta-lib</entry>
                                <entry>ta-lib</entry>
                                <entry>0.4.0</entry>
                            </row>
                            <row>
                                <entry>org.slf4j</entry>
                                <entry>slf4j-api</entry>
                                <entry>1.6.4</entry>
                            </row>
                            <row>
                                <entry>org.slf4j</entry>
                                <entry>slf4j-log4j12</entry>
                                <entry>1.6.4</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>algotrader core</title>
                <table frame="all" pgwide="1">
                    <title>algotrader-core dependencies</title>
                    <tgroup cols="3">
                        <thead>
                            <row>
                                <entry>ArtifactId</entry>
                                <entry>GroupId</entry>
                                <entry>Version</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>org.apache.ant</entry>
                                <entry>ant</entry>
                                <entry>1.8.2</entry>
                            </row>
                            <row>
                                <entry>commons-httpclient</entry>
                                <entry>commons-httpclient</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>commons-io</entry>
                                <entry>commons-io</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>c3p0</entry>
                                <entry>c3p0</entry>
                                <entry>0.9.1.2</entry>
                            </row>
                            <row>
                                <entry>net.sf.ehcache</entry>
                                <entry>ehcache</entry>
                                <entry>2.5.0</entry>
                            </row>
                            <row>
                                <entry>com.espertech</entry>
                                <entry>esperee</entry>
                                <entry>4.8.0</entry>
                            </row>
                            <row>
                                <entry>org.hibernate</entry>
                                <entry>hibernate-jmx</entry>
                                <entry>3.5.6-Final</entry>
                            </row>
                            <row>
                                <entry>com.interactivebrokers</entry>
                                <entry>ibclient</entry>
                                <entry>9.6.6</entry>
                            </row>
                            <row>
                                <entry>org.hibernate</entry>
                                <entry>jtidy</entry>
                                <entry>r8-21122004</entry>
                            </row>
                            <row>
                                <entry>junit</entry>
                                <entry>junit</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>org.apache.maven.shared</entry>
                                <entry>maven-invoker</entry>
                                <entry>2.0.11</entry>
                            </row>
                            <row>
                                <entry>org.apache.mina</entry>
                                <entry>mina-core</entry>
                                <entry>1.1.7</entry>
                            </row>
                            <row>
                                <entry>org.apache.mina</entry>
                                <entry>mina-filter-ssl</entry>
                                <entry>1.1.7</entry>
                            </row>
                            <row>
                                <entry>mysql</entry>
                                <entry>mysql-connector-java</entry>
                                <entry>5.1.18</entry>
                            </row>
                            <row>
                                <entry>quickfixj</entry>
                                <entry>quickfixj-core</entry>
                                <entry>1.5.2</entry>
                            </row>
                            <row>
                                <entry>quickfixj</entry>
                                <entry>quickfixj-msg-fix42-custom</entry>
                                <entry>1.5.2</entry>
                            </row>
                            <row>
                                <entry>quickfixj</entry>
                                <entry>quickfixj-msg-fix44</entry>
                                <entry>1.5.2</entry>
                            </row>
                            <row>
                                <entry>org.supercsv</entry>
                                <entry>SuperCSV</entry>
                                <entry>1.5.2</entry>
                            </row>
                            <row>
                                <entry>spiffy</entry>
                                <entry>spiffy</entry>
                                <entry>1.0.0</entry>
                            </row>
                            <row>
                                <entry>org.springframework</entry>
                                <entry>spring-context-support</entry>
                                <entry>3.1.0.RELEASE</entry>
                            </row>
                            <row>
                                <entry>org.springframework</entry>
                                <entry>spring-orm</entry>
                                <entry>3.1.0.RELEASE</entry>
                            </row>
                            <row>
                                <entry>org.springframework.integration</entry>
                                <entry>spring-integration-mail</entry>
                                <entry>2.1.3.RELEASE</entry>
                            </row>
                            <row>
                                <entry>org.springframework.integration</entry>
                                <entry>spring-integration-file</entry>
                                <entry>2.1.3.RELEASE</entry>
                            </row>
                            <row>
                                <entry>xalan</entry>
                                <entry>xalan</entry>
                                <entry>2.7.1</entry>
                            </row>
                            <row>
                                <entry>org.apache.xmlbeans</entry>
                                <entry>xmlbeans</entry>
                                <entry>
                                    <para>2.4.0</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>algotrader client</title>
                <table frame="all" pgwide="1">
                    <title>algotrader-client dependencies</title>
                    <tgroup cols="3">
                        <thead>
                            <row>
                                <entry>ArtifactId</entry>
                                <entry>GroupId</entry>
                                <entry>Version</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>commons-lang</entry>
                                <entry>commons-lang</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>commons-beanutils</entry>
                                <entry>commons-beanutils</entry>
                                <entry/>
                            </row>
                            <row>
                                <entry>org.jfree</entry>
                                <entry>jfreechart</entry>
                                <entry>1.0.14</entry>
                            </row>
                            <row>
                                <entry>com.jcraft</entry>
                                <entry>jsch</entry>
                                <entry>0.1.46</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
        </section>
    </chapter>
    <chapter id="Esper_Engine">
        <title>Esper Engine</title>
        <para>The system is built on CEP (Complex Event Processing) using the open source framework
                <ulink url="http://esper.codehaus.org/">Esper</ulink>.</para>
        <para>Individual Esper engines instances are used inside the Base as well as within the
            strategies.</para>
        <para>Each of these engines can contain several modules. Modules specified within the column
            INIT_MODULES and RUN_MODULES of the Table strategy, are loaded automatically on
            start-up.</para>
        <para>Each strategy will load all Esper configuration files named
                <filename>esper-xxx.cfg.xml</filename> in the classpath. This configuration file
            defines settings like:</para>
        <itemizedlist>
            <listitem>
                <para>Event Types</para>
            </listitem>
            <listitem>
                <para>Auto Import Classes &amp; Packages</para>
            </listitem>
            <listitem>
                <para>Custom Aggregation Functions</para>
            </listitem>
            <listitem>
                <para>Variables</para>
            </listitem>
            <listitem>
                <para>General Engine Settings</para>
            </listitem>
        </itemizedlist>
        <section>
            <title>Base Modules</title>
            <para>The Base contains the following modules:</para>
            <table frame="all" pgwide="1">
                <title>Base modules</title>
                <tgroup cols="2">
                    <colspec colwidth="1*"/>
                    <colspec colwidth="2*"/>
                    <thead>
                        <row>
                            <entry>Tag</entry>
                            <entry>Description</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>module-algo-xxx.epl</entry>
                            <entry>Each Execution Algo has its own module</entry>
                        </row>
                        <row>
                            <entry>module-combination.epl</entry>
                            <entry>Combination / Component related functionality (see <xref linkend="Synthetic_Instruments_and_Derivative_Spreads"/>)</entry>
                        </row>
                        <row>
                            <entry>module-current-values.epl</entry>
                            <entry>Store current market data values (last tick, last bid, last ask,
                                last trade, etc.)</entry>
                        </row>
                        <row>
                            <entry>module-ib-market-data.epl</entry>
                            <entry>IB specific statements</entry>
                        </row>
                        <row>
                            <entry>module-market-data.epl</entry>
                            <entry>statements related to market data retrieval</entry>
                        </row>
                        <row>
                            <entry>module-market-data-simulation.epl</entry>
                            <entry>simulation of market data</entry>
                        </row>
                        <row>
                            <entry>module-performance.epl</entry>
                            <entry>evaluation of performance indicators</entry>
                        </row>
                        <row>
                            <entry>module-portfolio.epl</entry>
                            <entry>portfolio management functions like setMargin, expirePosition,
                                closePosition, rebalancePortfolio, etc.</entry>
                        </row>
                        <row>
                            <entry>module-trades.epl</entry>
                            <entry>statements related to orders and executions</entry>
                        </row>
                        <row>
                            <entry>module-metrics.epl</entry>
                            <entry>Statements needed for Engine Metrics</entry>
                        </row>
                        <row>
                            <entry>module-prepared.epl</entry>
                            <entry>Contains Prepared Statements available to strategies</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section>
            <title>Strategy Modules</title>
            <para>Strategies are completely free in the definition of their Esper Statements.
                Examples of Statements used by strategies are:</para>
            <itemizedlist>
                <listitem>
                    <para>Creation of technical indicators (i.e. Moving Average, Stochastic, MACD,
                        etc.)</para>
                </listitem>
                <listitem>
                    <para>Creation of trade signals</para>
                </listitem>
                <listitem>
                    <para>Trend evaluation</para>
                </listitem>
                <listitem>
                    <para>Open / Close / Increase / Reduce Positions</para>
                </listitem>
                <listitem>
                    <para>Set Exit Values</para>
                </listitem>
                <listitem>
                    <para>Roll Positions (i.e. for Options and Futures)</para>
                </listitem>
                <listitem>
                    <para>Pattern recognition</para>
                </listitem>
                <listitem>
                    <para>Order book analysis</para>
                </listitem>
            </itemizedlist>
        </section>
        <section>
            <title>Tags</title>
            <para>In addition to the standard tags provided by Esper the following tags are
                available:</para>
            <table frame="all" pgwide="1">
                <title>Esper tags</title>
                <tgroup cols="2">
                    <colspec colwidth="1.2*"/>
                    <colspec colwidth="2*"/>
                    <thead>
                        <row>
                            <entry>Tag</entry>
                            <entry>Description</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>
                                <parameter>@Condition(key='xxx')</parameter>
                            </entry>
                            <entry>Statement is only deployed if defined configuration parameter is
                                set to "true"</entry>
                        </row>
                        <row>
                            <entry>
                                <parameter>@SimulationOnly</parameter>
                            </entry>
                            <entry>Statement is only deployed in simulation</entry>
                        </row>
                        <row>
                            <entry>
                                <parameter>@RunTimeOnly()</parameter>
                            </entry>
                            <entry>Statement is only deployed in Live-Trading mode</entry>
                        </row>
                        <row>
                            <entry>
                                <parameter>@Listeners(classNames={'...'})</parameter>
                            </entry>
                            <entry>attaches one or multiple listeners to the statement</entry>
                        </row>
                        <row>
                            <entry>
                                <parameter>@Subscriber(className='...')</parameter>
                            </entry>
                            <entry>attaches a subscriber to the statement</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section>
            <title>Subscribers</title>
            <para>The system provides the following Subscribers out-of-the-box:</para>
            <variablelist>
                <varlistentry>
                    <term>IndicatorSubscriber</term>
                    <listitem>
                        <para>Prints all values as a comma-separated-list (CSV) to Log. (Headers are
                            not available)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>LogPortfolioValueSubscriber</term>
                    <listitem>
                        <para>Prints porftolio values like CashBalance, SecuritiesCurrentValue,
                            MaintenanceMargin and Leverage to the Log.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>TestSubscriber</term>
                    <listitem>
                        <para>Prints all values to the Log by using the
                                <methodname>toString</methodname> method of the event object.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>VoidSubscriber</term>
                    <listitem>
                        <para>Do-nothing subscriber, useful when select clauses call static
                            methods</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>ExceptionSubscriber</term>
                    <listitem>
                        <para>Prints a value as an Error to the Log.</para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>The class <classname>com.algoTrader.esper.subscriber.SubscriberCreator</classname>
                can generate Subscriber classes on the fly using <ulink url="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/">javassist</ulink>. Use
                the following syntax to call a spring service method directly:</para>
            <programlisting>@Subscriber(className='com.algoTrader.service.PositionService.setMargins')</programlisting>
        </section>
        <section>
            <title>Listeners</title>
            <para>The system provides the following Listeners out-of-the-box:</para>
            <variablelist>
                <varlistentry>
                    <term>IndicatorListener</term>
                    <listitem><para>Prints all values as a comma-separated-list (CSV) to Log. Headers will be extracted from the
                            supplied Statement.</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term>RendererListener:</term>
                    <listitem><para> Prints all values to the Log in XML format.</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term>TestListener</term>
                    <listitem><para> Prints all values to the Log by using the <methodname>toString</methodname> method of the
                            event object.</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term>StatementAwareTestListener</term>
                    <listitem>
                        <para>Prints all values including the statement name to the Log by using the
                                <methodname>toString</methodname> method of the event object.</para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
        <section>
            <title>Aggregation Functions</title>
            <para>The system provides the following three custom aggregation functions:</para>
            <section>
                <title>GenericTALibFunction</title>
                <para>The <classname>GenericTALibFunction</classname> is a portation of <ulink url="http://ta-lib.org/">http://ta-lib.org/</ulink> to AlgoTrader. It
                    supports all TA-Lib operations.</para>
                <para>To use the <classname>AggregateFunction</classname> the following configuration is added
                    to the esper configuration <filename>esper-common.cfg.xml</filename>:</para>
                <programlisting lang="XML">&lt;plugin-aggregation-function name="talib" factory-class="com.algoTrader.esper.aggregation.GenericTALibFunctionFactory"/></programlisting>
                <para> The <classname>AggregationFunction</classname> can be used in an esper statement like
                    this: </para>
                <programlisting lang="Java">insert into StochF
select talib("stochF", high, low, close, 3, 2, "Sma") as values
from OHLCBar;

select values.fastk, values.fastd
from StochF(values != null);</programlisting>
                <para>The following parameters from the <classname>com.tictactec.ta.lib.Core</classname> methods
                    will be needed: </para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para><parameter>in...</parameter> (i.e. <parameter>inHigh</parameter>,
                                    <parameter>inLow</parameter>, <parameter>inClose</parameter>) </para>
                        </listitem>
                        <listitem>
                            <para><parameter>optIn..</parameter> (i.e. <parameter>optInFastK_Period</parameter>,
                                    <parameter>optInFastD_Period</parameter>,
                                    <parameter>optInFastD_MAType</parameter>) </para>
                        </listitem>
                        <listitem>
                            <para><parameter>startIdx</parameter>, <parameter>endIdx</parameter>,
                                    <parameter>outBegIdx</parameter> &amp;
                                    <parameter>outNBElement</parameter> can be ignored </para>
                        </listitem>
                    </itemizedlist>
                </para>
                <para>If the TA-Lib Function returns just one value, the value is directly exposed by the
                        <classname>AggregationFunction</classname>. </para>
                <para>If the TA-Lib Function returns multiple-values, a dynamic class will be
                    generated on the fly, which gives access to properly typed return-values. All
                    return value names are lower-case! </para>
                <para>Example: the TA-Lib function <methodname>stochF</methodname> has return
                    values: <parameter>outFastK</parameter> and <parameter>outFastD</parameter>. The
                    returned dynamic class will have double typed properties by the name of:
                        <parameter>fastk</parameter> and <parameter>fastd</parameter> (all
                    lowercase).</para>
            </section>
            <section>
                <title>ExponentialMovingAverageFunction</title>
                <para>The <classname>ExponentialMovingAverageFunction</classname> provides an exponential moving
                    average over a defined period of time.</para>
                <para>To use the <classname>AggregateFunction</classname> the following
                    configuration has to be added to the esper configuration :</para>
                <programlisting lang="XML">&lt;plugin-aggregation-function name="ema" factory-class="com.algoTrader.esper.aggregation.ExponentialMovingAverageFunction"/></programlisting>
                <para>The <classname>AggregationFunction</classname> can then be used in an esper
                    statement like this:</para>
                    <programlisting lang="Java">select ema(value, 10)
from Event;</programlisting>
                <note>
                    <para><classname>ExponentialMovingAverage</classname> is also available through
                        the <classname>GenericTALibFunction</classname></para>
                </note>
            </section>
            <section>
                <title>VariableLengthLinestFunction</title>
                <para>The <classname>VariableLengthLinestFunction</classname> calculates the slope of a linear
                    interpolation of a time-series (based on x and y values) over a defined period
                    of time.</para>
                <para>To use the <classname>AggregateFunction</classname> the following
                    configuration has to be added to the esper configuration :</para>
                <programlisting lang="XML">&lt;plugin-aggregation-function name="varLinest" factory-class="com.algoTrader.esper.aggregation.VariableLengthLinestFunction"/></programlisting>
                <para>The <classname>AggregationFunction</classname> can then be used in an esper
                    statement like this:</para>
                <programlisting lang="Java">select varLinest(x, y, 10)
from Event;</programlisting>
            </section>
        </section>
        <section>
            <title>Custom Views</title>
            <section id="OHLCView">
                <title>OHLCView</title>
                <para>The OHLC View is a custom Esper data view that aggregates events in a stream
                    to OHLC Bars and releases them at the end of every specified time interval. The
                    view works similar to a time_batch_window. The view releases the OHLC Bar after
                    the interval as new data to child views. The prior OHLC Bar if not empty is
                    released as old data to child view. The view doesn't release intervals with no
                    old or new data. It also does not collect old data published by a parent view. </para>
                <para>The view accepts 2 parameter combinations: </para>
                <itemizedlist>
                    <listitem>
                        <para>A time interval is supplied with a reference point - based on this
                            point the intervals are set</para>
                    </listitem>
                    <listitem>
                        <para>A time interval is supplied but no reference point - the reference
                            point is set when the first event arrives</para>
                    </listitem>
                </itemizedlist>
                <para>If there are no events in the current and prior batch, the view will not
                    invoke the update method of child views. In that case also, no next callback is
                    scheduled with the scheduling service until the next event arrives. </para>
                <para>To use the Custom View add the following to the esper configuration: </para>
                <programlisting>&lt;plugin-view namespace="custom" name="ohlcbar" factory-class="com.algoTrader.esper.ohlc.OHLCViewFactory"/></programlisting>
                <para>In addition the <classname>OHLCBar</classname> event type needs to be added to
                    the esper configuration:</para>
                <programlisting>&lt;event-type name="OHLCTick" class="com.algoTrader.esper.ohlc.OHLCBar"/></programlisting>
                <para>The Custom View can be used in an esper statement like this:</para>
                <programlisting>select
    open, high, low, close
from
    Tick.custom:ohlcbar(currentValueDouble, 1 days, 0L);</programlisting>
            </section>
        </section>
        <section>
            <title>Callbacks</title>
            <section id="FirstTickCallback">
                <title>FirstTickCallback</title>
                <para>Objects of the abstract class <classname>FirstTickCallback</classname> can be
                    handed to the <classname>RuleService.addFirstTickCallback()</classname>.
                    Whenever at least one Tick of each specified security has arrived the method
                        <classname>FirstTickCallback.onFirstTick()</classname> will be
                    executed.</para>
                <para>A typical use case of a FirstTickCallback looks like this:</para>
                <programlisting language="Java">EsperManager.addFirstTickCallback(strategyName, securities, new TickCallback() {
  @Override
  public void onFirstTick(String strategyName, List&lt;Tick> ticks) {
    placeOrdersBasedOnTicks(ticks);
  }
});

for (Security security : securities) {
  getSubscriptionService().subscribeMarketDataEvent(strategyName, security.getId());
}</programlisting>
            </section>
            <section id="TradeCallback">
                <title>TradeCallback</title>
                <para>Objects of the abstract class <classname>TradeCallback</classname> can be
                    handed to the <classname>RuleService.addTradeCallback()</classname>. Whenever
                    the corresponding trade has been fully executed or cancelled the method
                        <classname>TradeCallback.onTradeCompleted()</classname> will be executed. If
                    the parameter <parameter>expectFullExecution</parameter> is set onto the
                    TradeCallback constructor, there will be an error logged if the order did not
                    execute fully. In addition there is a concrete class FullExecutionTradeCallback
                    that does nothing except check for full execution of the order.</para>
                <para>A typical use case of a TradeCallback looks like this:</para>
                <programlisting language="Java">EsperManager.addTradeCallback(strategyName, orders, new TradeCallback(true) {
  @Override
  public void onTradeCompleted(List&lt;OrderStatus> orderStati) {
    OrderUtil.checkOrderStati(orderStati);
  }
});

getOrderService().sendOrders(orders);</programlisting>
            </section>
            <section>
                <title>OpenPositionCallback</title>
                <para>Objects of the abstract class <classname>OpenPositionCallback</classname> can
                    be handed to the <classname>RuleService.addOpenPositionCallback()</classname>.
                    Whenever a corresponding transaction causes a new position to open method
                        <classname>OpenPositionCallback.onOpenPosition()</classname> will be
                    executed.</para>
                <programlisting language="Java">EsperManager.addOpenPositionCallback(strategyName, securityId, new OpenPositionCallback() {
  @Override
  public void onOpenPosition(OpenPositionVO positionVO) throws Exception {
    setExitValue(positionVO.getId());
  }
});</programlisting>
                <note>
                    <para>It is guaranteed that the position is fully persistent to the database by the time the
                        method <classname>OpenPositionCallback.onOpenPosition()</classname> is
                        called.</para>
                </note>
            </section>
            <section>
                <title>ClosePositionCallback</title>
                <para>Objects of the abstract class <classname>ClosePositionCallback</classname> can
                    be handed to the <classname>RuleService.addClosePositionCallback()</classname>.
                    Whenever a corresponding transaction causes a position to be closed, the method
                        <classname>ClosePositionCallback.onClosePosition()</classname> will be
                    executed.</para>
                <programlisting language="Java">EsperManager.addClosePositionCallback(strategyName, securityId, new ClosePositionCallback() {
  @Override
  public void onClosePosition(ClosePositionVO positionVO) throws Exception {
    // do something
  }
});  </programlisting>
                <note>
                    <para>It is guaranteed that the position is fully removed from the database by
                        the time the method
                            <classname>ClosePositionCallback.onClosePosition()</classname> is
                        called.</para>
                </note>
            </section>
        </section>
    </chapter>
    <chapter id="Database">
        <title>Database</title>
        <para>By default the database <ulink url="http://www.mysql.com/">MySql</ulink> is used by
            the system.</para>
        <para>The directory <filename>algotrader/core/sql</filename> contains the following a
            scripts:</para>
        <itemizedlist>
            <listitem>
                <para>db-structure.sql (create script for the structure of the database)</para>
            </listitem>
            <listitem>
                <para>db-data.sql (default data for the database)</para>
            </listitem>
            <listitem>
                <para>schema-create.sql (create script generated by Hibernate)</para>
            </listitem>
            <listitem>
                <para>backup.sh (shell script for db backup)</para>
            </listitem>
            <listitem>
                <para>dump-db.bat (batch script to dump db structure and data)</para>
            </listitem>
            <listitem>
                <para>several analysis sql statements</para>
            </listitem>
        </itemizedlist>
        <section>
            <title>Entity Relationship Model</title>
            <figure>
                <title>Base Tables</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/SchemaBase.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <figure>
                <title>Security Tables</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/SchemaSecurity.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <figure>
                <title>Security Family Tables</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/SchemaSecurityFamily.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <figure>
                <title>Strategy Tables</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/SchemaStrategy.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>The Entity Relationship Model of the system is displayed above. For a description
                of tables please see <xref linkend="Code_Generation"/>
            </para>
        </section>
        <section>
            <title>Transaction Handling</title>
            <para>Using AndroMDA and Spring, Transaction Boundaries can be declared inside the UML
                model using the tagged value
                    <parameter>@andromda.spring.transaction.type</parameter>. Transaction Boundaries
                will be generated into the file <filename>applicationContext.xml</filename> and
                handled by the
                    <classname>org.springframework.transaction.interceptor.TransactionInterceptor</classname>.</para>
            <para>For additional info see <xref linkend="Hibernate_Locking"/>
            </para>
        </section>
    </chapter>
    <chapter id="Client">
        <title>Client</title>
        <para>AlgoTrader provides three different types of clients all of which are targeting a
            different audience and use case:</para>
        <itemizedlist>
            <listitem>
                <para>JMX Client: Trading related Management Client as well as general JVM
                    Management</para>
            </listitem>
            <listitem>
                <para>EsperHQ Client: Management of Esper CEP Engines</para>
            </listitem>
            <listitem>
                <para>Grails Client: Reference Data Management</para>
            </listitem>
        </itemizedlist>
        <section id="JMX_Client">
            <title>JMX Client</title>
            <para>The JMX Client uses <ulink url="http://docs.oracle.com/javase/tutorial/jmx/index.html"> Java Management
                    Extension</ulink> (JMX) and the generic Java Client<ulink url="http://docs.oracle.com/javase/7/docs/technotes/tools/share/jconsole.html">
                    JConsole</ulink>. </para>
            <para>When starting up the AlgoTraderClient there will be one window per JVM. The
                JConsole provides management functionality for many technical aspects of the JVM
                (i.e. Threads, Classes &amp; Memory) see the <ulink url="http://docs.oracle.com/javase/6/docs/technotes/guides/management/jconsole.html">Java Documentation</ulink> for details. </para>
            <para>The business related features of AlgoTrader are available on the Tab
                    <literal>MBeans</literal> through the
                    <classname>BaseManagementService</classname> and the
                    <classname>ManagementService</classname> under
                    <package>com.algoTrader.service</package>. To open any of the detail sections
                (i.e. Orders, Positions or Transactions) click on the bold section of the
                display.</para>
            <figure>
                <title>AlgoTrader Client</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/Client.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <section>
                <title>AlgoTrader Managed Beans</title>
                <para>Services tagged with <parameter>@algoTrader.service.manageable</parameter> are
                    automatically exposed through JMX by means of the
                        <classname>org.springframework.jmx.export.annotation.AnnotationMBeanExporter</classname>.</para>
                <para>The following AlgoTader Services are exposed as Managed Beans</para>
                <section>
                    <title>Management Service</title>
                    <figure>
                        <title>Management Service Attributes</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/ManagementServiceAttributes.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <para>The Management Service is available for every strategy and for the Base
                        itself. It provides the Attributes and Operations that are not strategy
                        specific.</para>
                    <table frame="all" pgwide="1">
                        <title>Management Service Attributes</title>
                        <tgroup cols="2">
                            <colspec colwidth="1*"/>
                            <colspec colwidth="2*"/>
                            <thead>
                                <row>
                                    <entry>Attribute</entry>
                                    <entry>Description</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry>CurrentTime</entry>
                                    <entry>Current Local Time</entry>
                                </row>
                                <row>
                                    <entry>Balances</entry>
                                    <entry>Balances of each currency, i.e. Cash, Securities and
                                        NetLiqValue as well as exchangeRate (only available in Base)
                                    </entry>
                                </row>
                                <row>
                                    <entry>Orders</entry>
                                    <entry>currently open orders (might contain AlgoOrders and their
                                        associated SimpleOrders)</entry>
                                </row>
                                <row>
                                    <entry>Positions</entry>
                                    <entry>All Positions of the system / of the strategy</entry>
                                </row>
                                <row>
                                    <entry>MarketDataEvents</entry>
                                    <entry>Latest ticks off all subscribed securities of the system
                                        / of the strategy</entry>
                                </row>
                                <row>
                                    <entry>Transactions</entry>
                                    <entry>Last 20 Transactions of the system / of the strategy
                                    </entry>
                                </row>
                                <row>
                                    <entry>Properties</entry>
                                    <entry>All Configuration Values of the system / of the strategy
                                    </entry>
                                </row>
                                <row>
                                    <entry>Allocation</entry>
                                    <entry>Allocation assigned to Base / the strategy</entry>
                                </row>
                                <row>
                                    <entry>Available Funds</entry>
                                    <entry>NetLiqValue - InitialMargin</entry>
                                </row>
                                <row>
                                    <entry>Cash Balance</entry>
                                    <entry>Amount of Cash available to the system / to the strategy
                                    </entry>
                                </row>
                                <row>
                                    <entry>Leverage</entry>
                                    <entry>Current Notional Exposure delta-adjusted of the system /
                                        of the strategy</entry>
                                </row>
                                <row>
                                    <entry>Maintenance Margin</entry>
                                    <entry>Maintenance Margin of the system / of the
                                        strategy</entry>
                                </row>
                                <row>
                                    <entry>Name</entry>
                                    <entry>Name of the strategy or Base</entry>
                                </row>
                                <row>
                                    <entry>NetLiqValue</entry>
                                    <entry>Net Liquidation Value of the system / of the
                                        strategy</entry>
                                </row>
                                <row>
                                    <entry>Performance</entry>
                                    <entry>strategy performance of the current month</entry>
                                </row>
                                <row>
                                    <entry>SecuritiesCurrentValue</entry>
                                    <entry>Current value of all open positions of the system / of
                                        the strategy</entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                    <figure>
                        <title>Management Service Operations</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/ManagementServiceOperations.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <para>In addition the Management Service provides the following
                        Operations</para>
                    <table frame="all" pgwide="1">
                        <title>Management Service Operations</title>
                        <tgroup cols="2">
                            <colspec colwidth="1*"/>
                            <colspec colwidth="2*"/>
                            <thead>
                                <row>
                                    <entry>Operation</entry>
                                    <entry>Description</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry>addProperty</entry>
                                    <entry>add a property to a PropertyHolder</entry>
                                </row>
                                <row>
                                    <entry>cancelOrder</entry>
                                    <entry>cancel an order (AlgoOrder or SimpleOrder)</entry>
                                </row>
                                <row>
                                    <entry>checkIsAlive</entry>
                                    <entry>reachability check (used internally)</entry>
                                </row>
                                <row>
                                    <entry>closePosition</entry>
                                    <entry>closes a specified position (based on
                                        DefaultOrderPreference)</entry>
                                </row>
                                <row>
                                    <entry>deployModule</entry>
                                    <entry>deploys an entire esper module</entry>
                                </row>
                                <row>
                                    <entry>deployStatement</entry>
                                    <entry>deploys an individual statement of an esper
                                        module</entry>
                                </row>
                                <row>
                                    <entry>modifyOrder</entry>
                                    <entry>modifies an existing order (e.g. quantity, limit, etc.)
                                    </entry>
                                </row>
                                <row>
                                    <entry>reduceCombination</entry>
                                    <entry>reduced the specified combination by the defined
                                        ratio</entry>
                                </row>
                                <row>
                                    <entry>reducePositon</entry>
                                    <entry>reduces a position by a specified amount (based on
                                        DefaultOrderPreference)</entry>
                                </row>
                                <row>
                                    <entry>removeComponent</entry>
                                    <entry>removes a component from a combination</entry>
                                </row>
                                <row>
                                    <entry>removeExitValue</entry>
                                    <entry>removes an existing exit value</entry>
                                </row>
                                <row>
                                    <entry>removeProperty</entry>
                                    <entry>removes a property from a PropertyHolder</entry>
                                </row>
                                <row>
                                    <entry>requestCurrentTicks</entry>
                                    <entry>requests latest Ticks for all subscribed
                                        securities</entry>
                                </row>
                                <row>
                                    <entry>sendOrder</entry>
                                    <entry>manually send order of the specified type, either
                                        SimpleOrder or AlgoOrder (defined by the corresponding
                                        OrderPreference)</entry>
                                </row>
                                <row>
                                    <entry>setComponentQuantity</entry>
                                    <entry>sets the quantity of an individual component on a
                                        combination</entry>
                                </row>
                                <row>
                                    <entry>setExitValue</entry>
                                    <entry>adjust an exitValue of a position</entry>
                                </row>
                                <row>
                                    <entry>setVariableValue</entry>
                                    <entry>set the value of an esper variable</entry>
                                </row>
                                <row>
                                    <entry>shutdown</entry>
                                    <entry>gracefully shutdown the corresponding JVM Process</entry>
                                </row>
                                <row>
                                    <entry>subscribe</entry>
                                    <entry>subscribe to the specified security</entry>
                                </row>
                                <row>
                                    <entry>unsubscribe</entry>
                                    <entry>unsubscribe to the specified security</entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                </section>
                <section>
                    <title>Base Management Service</title>
                    <figure>
                        <title>Base Management Service Operations</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/BaseManagementServiceOperations.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <para>The Base Management Service is only available when connected to the
                        Base.</para>
                    <para>The service currently only has the Attributes
                            <emphasis>MarketChannels</emphasis> and
                            <emphasis>DefaultMarketChannel</emphasis>
                    </para>
                    <para>The Base Management Service has the following operations:</para>
                    <table frame="all" pgwide="1">
                        <title>Base Management Service operations</title>
                        <tgroup cols="2">
                            <colspec colwidth="1*"/>
                            <colspec colwidth="2*"/>
                            <thead>
                                <row>
                                    <entry>Operation</entry>
                                    <entry>Description</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry>cancelAllOrders</entry>
                                    <entry>cancel all orders that are currently in the
                                        market</entry>
                                </row>
                                <row>
                                    <entry>emptyOpenOrderWindow</entry>
                                    <entry>should only be called if an order was not accepted by the
                                        broker but is still visible in the openOrderWindow</entry>
                                </row>
                                <row>
                                    <entry>equalizeForex</entry>
                                    <entry>adjusts the current FX Hedge for all non-base currencies
                                    </entry>
                                </row>
                                <row>
                                    <entry>rebalancePortfolio</entry>
                                    <entry>redistribute cash between strategies and Base so that the
                                        target allocation is met</entry>
                                </row>
                                <row>
                                    <entry>recordTransaction</entry>
                                    <entry>manually record a transaction to the database</entry>
                                </row>
                                <row>
                                    <entry>resetComponentWindow</entry>
                                    <entry>has to be called if a direct modification of components
                                        has been made in the database</entry>
                                </row>
                                <row>
                                    <entry>resetPositionsAndCashBalances</entry>
                                    <entry>recalculates all Positions and Cash Balances by iterating
                                        over all Transactions</entry>
                                </row>
                                <row>
                                    <entry>setDefaultMarketChannel</entry>
                                    <entry>changes the default market channel</entry>
                                </row>
                                <row>
                                    <entry>setMargins</entry>
                                    <entry>calculates current maintenance margin for all open
                                        positions </entry>
                                </row>
                                <row>
                                    <entry>transferPosition</entry>
                                    <entry>transfers a position from one strategy to another by
                                        taking its current market value</entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                </section>
                <section>
                    <title id="StrategyServices">StrategyServices</title>
                    <para>Each Strategy can define as many manageable Services as needed. To be
                        manageable the class has to have the following tagged value:</para>
                    <programlisting language="Java">@ManagedResource(objectName = "com.algoTrader.strategy.xyz:name=XYZManagementService")</programlisting>
                    <para>ManagedOperations have to be tagged like this:</para>
                    <programlisting language="Java">@ManagedOperation(description = "send an order")@ManagedOperationParameters({
  @ManagedOperationParameter(name = "securityId", description = "securityId"),
  @ManagedOperationParameter(name = "quantity", description = "quantity"),
  @ManagedOperationParameter(name = "side", description = "BUY or SELL"),
})</programlisting>
                </section>
            </section>
            <section>
                <title id="Charts">Charts</title>
                <para>Every strategy will display a custom JConsole Tab with a Portfolio Chart. In
                    addition Strategies can configure additional Tabs with Custom Charts.</para>
                <para>All Charts are based on <ulink url="http://www.jfree.org/jfreechart/">
                        JFreeChart</ulink> and <ulink url="http://www.jfree.org/orson/">
                        Orson</ulink>.</para>
                <para>Each chart provides several Operations which are available through the context
                    menu (i.e. right mouse click):</para>
                <itemizedlist>
                    <listitem>
                        <para>Copy / Save as / Print</para>
                    </listitem>
                    <listitem>
                        <para>Zoom In / Zoom Out / Autorange</para>
                    </listitem>
                    <listitem>
                        <para>Reset Chart: will reload the entire Chart Data and reset all settings
                        </para>
                    </listitem>
                    <listitem>
                        <para>Update Chart Data: will contact the corresponding ChartService for any
                            new ChartData that is not already displayed</para>
                    </listitem>
                </itemizedlist>
                <section id="Portfolio_Chart">
                    <title>Portfolio Chart</title>
                    <para>The following image shows an example of a Portfolio Chart:</para>
                    <figure>
                        <title>Portfolio Chart</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/PortfolioChart.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <para>The Portfolio Chart displays the following values for each strategy
                        (including Base):</para>
                    <itemizedlist>
                        <listitem>
                            <para>performance (displayed by default)</para>
                        </listitem>
                        <listitem>
                            <para>netLiqValue</para>
                        </listitem>
                        <listitem>
                            <para>securitiesCurrentValue</para>
                        </listitem>
                        <listitem>
                            <para>cashBalance</para>
                        </listitem>
                        <listitem>
                            <para>maintenanceMargin</para>
                        </listitem>
                        <listitem>
                            <para>leverage</para>
                        </listitem>
                        <listitem>
                            <para>allocation</para>
                        </listitem>
                    </itemizedlist>
                </section>
                <section id="Custom_Chart">
                    <title>Custom Chart</title>
                    <para>The following images show some examples of Custom Charts:</para>
                    <figure>
                        <title>Indicator Chart</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/IndicatorChart.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <figure>
                        <title>Bar Chart</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/BarChart.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <figure>
                        <title>Annotation Chart</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/AnnotationChart.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <para>Custom Charts need to be configured inside the file
                            <filename>applicationContext-client-&lt;strategyName&gt;.xml</filename>.
                        A typical configuration looks like this:</para>
                    <programlisting language="XML">&lt;bean id="xyzChartService"
  class="com.algoTrader.strategy.xyz.XYZChartService" autowire="byName">
  &lt;property name="chartDefinition">
    &lt;bean class="com.algoTrader.vo.ChartDefinitionVO" p:timePeriod="SEC" >
      &lt;property name="axisDefinitions">
        &lt;set>
          &lt;bean class="com.algoTrader.vo.AxisDefinitionVO" p:autoRange="true"
            p:autoRangeIncludesZero="false" p:numberFormat="##0.00000">
            &lt;property name="datasetDefinitions">
              &lt;set>
                &lt;bean class="com.algoTrader.vo.DatasetDefinitionVO" p:type="TIME">
                  &lt;property name="seriesDefinitions">
                    &lt;set>
                      &lt;bean class="com.algoTrader.vo.IndicatorDefinitionVO"
                        p:name="currentValue" p:label="Current Value" p:selected="true" />
                      &lt;bean class="com.algoTrader.vo.MarkerDefinitionVO"
                        p:name="upperTarget" p:label="Upper Target" p:selected="true"/>
                      &lt;bean class="com.algoTrader.vo.MarkerDefinitionVO"
                        p:name="upperBuffer" p:label="Upper Buffer" p:selected="true"/>
                      &lt;bean class="com.algoTrader.vo.MarkerDefinitionVO"
                        p:name="box" p:label="Box" p:selected="true"p:interval="true"/>
                      &lt;bean class="com.algoTrader.vo.MarkerDefinitionVO"
                        p:name="lowerBuffer" p:label="Lower Buffer" p:selected="true"/>
                      &lt;bean class="com.algoTrader.vo.MarkerDefinitionVO"
                        p:name="lowerTarget" p:label="Lower Target" p:selected="true"/>
                    &lt;/set>
                  &lt;/property>
                &lt;/bean>
              &lt;/set>
            &lt;/property>
          &lt;/bean>
        &lt;/set>
      &lt;/property>
    &lt;/bean>
  &lt;/property>
&lt;/bean></programlisting>
                    <para>The following class diagram and table show all possible definition options
                        for Custom Chart configuration:</para>
                    <figure>
                        <title>Chart Definition</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata fileref="images/ChartDefinition.png" scalefit="1"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <table frame="all" pgwide="1">
                        <title>Chart Definition Value Objects</title>
                        <tgroup cols="2">
                            <colspec colwidth="1*"/>
                            <colspec colwidth="2*"/>
                            <thead>
                                <row>
                                    <entry>Value Object</entry>
                                    <entry>Description</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry>ChartDefintionVO</entry>
                                    <entry>The top-level entity of each chart. It defines TimePeriod
                                        (e.g. MINUTE) as well as the startTime and endTime (e.g.
                                        14:30 - 22:15) for Intraday Charts.</entry>
                                </row>
                                <row>
                                    <entry>AxisDefinitionVO</entry>
                                    <entry>Each Chart can have multiple Axis, which are defined
                                        through this Value Object. Each Axis has a label (e.g.
                                        Performance). In addition the range being displayed can be
                                        customized through autoRange, autoRangeIncludesZero,
                                        upperBound and lowerBound. Optionally the NumberFormat of
                                        the Axis can be defined according to the class
                                            <classname>java.text.NumberFormat</classname> (e.g.
                                        ##0.00000)</entry>
                                </row>
                                <row>
                                    <entry>DatasetDefinitionVO</entry>
                                    <entry>Each Axis can have multiple Datasets. Datasets are of
                                        type OHLC (for Bar Charts) or TIME (for general Indicator
                                        based Charts)</entry>
                                </row>
                                <row>
                                    <entry>SeriesDefinitionVO</entry>
                                    <entry>This value object defines the actual data series. It
                                        contains a label and a color. In addition the parameter
                                        selected defines if the series is visible by default when
                                        the Client is started. The SeriesDefinitionVO is abstract
                                        and has 3 concrete subclasses </entry>
                                </row>
                                <row>
                                    <entry>BarDefinitionVO</entry>
                                    <entry>Defines a OHLC Bar Series for the specified security
                                    </entry>
                                </row>
                                <row>
                                    <entry>IndicatorDefinitionVO</entry>
                                    <entry>Defines an arbitrary indicator series with a specified
                                        name </entry>
                                </row>
                                <row>
                                    <entry>MarketDefinitionVO</entry>
                                    <entry>Defines a horizontal marker line (= ValueMarker) or
                                        marker band (= IntervalMarker) with a specified
                                        name.</entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                    <para>A Custom Chart is wired to a corresponding
                            <classname>ChartService</classname> (a subclass of
                            <classname>ChartProvidingServiceImpl</classname>) which will provide the
                        Chart with the actual ChartData to display. The following class diagram show
                        a summary of all ChartData Value Objects.</para>
                    <figure>
                        <title>Chart Data</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/ChartData.png"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <para>A ChartProvidingService can optionally overwrite any of the following
                        methods to provide ChartData. Most of these methods contain a dateTime
                        parameter. The Chart will pass the latest Date, that is currently displayed
                        on the Chart. Through this, a ChartService can choose to return only
                        ChartData that is not yet displayed on a Chart. Clicking ResetChart will
                        sent a dateTime of zero and therefore request a full update of all
                        ChartData.</para>
                    <table frame="all" pgwide="1">
                        <title>ChartService</title>
                        <tgroup cols="2">
                            <colspec colwidth="1*"/>
                            <colspec colwidth="2*"/>
                            <thead>
                                <row>
                                    <entry>Method</entry>
                                    <entry>Description</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry>getChartDefinition()</entry>
                                    <entry>The parent class of the ChartService, the class
                                            <classname>ChartProvidingServiceImpl</classname>, will
                                        by default return the Chart Definition according to the file
                                            <filename>applicationContext-client-&lt;strategyName&gt;.xml</filename>.
                                        Strategies may however chose to modify or augment this
                                        definition (e.g. a Futures based Strategy that sets the
                                        securityId of a Bar Series according to the Front Month
                                        Future)</entry>
                                </row>
                                <row>
                                    <entry>getBars()</entry>
                                    <entry>Returns BarVO's (a subclass of MarketDataEventVO). Only
                                        dateTime, open, high, low, close need to be defined.</entry>
                                </row>
                                <row>
                                    <entry>getIndicators()</entry>
                                    <entry>Returns IndicatorVO's, which have a name, a dateTime and
                                        a value property.</entry>
                                </row>
                                <row>
                                    <entry>getMarkers()</entry>
                                    <entry>Return either ValueMarker containing just a value or an
                                        IntervalMarker containing a startValue and an
                                        endValue</entry>
                                </row>
                                <row>
                                    <entry>getAnnotations()</entry>
                                    <entry>A Custom Chart can optionally display any number of
                                        annotations. These are either PointerAnnotations
                                        (represented through an arrow) or BoxAnnotations
                                        (represented by a box). See Annotation Chart example diagram
                                        above.</entry>
                                </row>
                                <row>
                                    <entry>getDescription()</entry>
                                    <entry>Returns an arbitrary text description for the chart (e.g.
                                        current state of the strategy). See Annotation Chart example
                                        diagram above.</entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                    <para>A ChartService has to be exposed via JMX so that the client can retrieve
                        current chart data. This is done by annotating the ChartService like
                        this:</para>
                    <programlisting language="Java">@ManagedResource(objectName = "com.algoTrader.strategy.xyz:name=XYZChart,type=chart")</programlisting>
                    <para>Because of the <parameter>type=chart</parameter> this Service will not be
                        visible as a ManagedBean in the client.</para>
                    <para>A typical ChartService might look like this:</para>
                    <programlisting language="Java">package com.algoTrader.strategy.xyz;

@ManagedResource(objectName = "com.algoTrader.strategy.xyz:name=XYZChart,type=chart")
public class MovChartService extends ChartProvidingServiceImpl {

  @Override
  public Collection&lt;IndicatorVO> getIndicators(long startDateTime) {

    List&lt;MarketDataEventVO> marketDataEvents = EsperManager.executeQuery("MOV",
      "select * from CurrentValueWindow where dateTime.toMillisec() > " + startDateTime);

    Set&lt;IndicatorVO> set = new HashSet&lt;IndicatorVO>();
    for (MarketDataEventVO marketDataEvent : marketDataEvents) {
      set.add(new IndicatorVO("currentValue", marketDataEvent.getDateTime(),
        marketDataEvent.getCurrentValue().doubleValue()));
    }

    return set;
  }

  @Override
  public Collection&lt;MarkerVO> getMarkers() {

    Double target = (Double) EsperManager.getVariableValue("MOV", "target");

    return Collections.singleton(new ValueMarkerVO("target", target))
  }

  @Override
  public String getDescription() {

    Double stop = (Double) EsperManager.getVariableValue("MOV", "stop");

    return String.valueOf(stop);
  }
}</programlisting>
                </section>
            </section>
            <section>
                <title>JMX Access</title>
                <section id="Local-JMX-Access">
                    <title>Local JMX Access</title>
                    <para>On the local machine JMX access can be enabled with the following
                        (non-secure) VM arguments:</para>
                    <screen>-Dcom.sun.management.jmxremote.port=1099
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false</screen>
                    <para>When starting JConsole connect to: <literal>localhost:1099</literal>
                    </para>
                </section>
                <section id="Remote-JMX-Access">
                    <title>Remote JMX Access</title>
                    <para>To enable JMX for remote access the following VM arguments have to be
                        used. This involves usage of a custom JMX agent that will make sure the
                        specified <parameter>serverPort</parameter> is used. By default Java uses a
                        random <parameter>serverPort</parameter>, which will not work when trying to
                        access the system through a firewall.</para>
                    <screen>-Dcom.algoTrarder.rmi.registryPort=1099
-Dcom.algoTrarder.rmi.serverPort=1098
-Djava.rmi.server.hostname=127.0.0.1
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=true
-Dcom.sun.management.jmxremote.ssl.need.client.auth=true
-Dcom.sun.management.jmxremote.registry.ssl=true
-Djavax.net.ssl.keyStore=...
-Djavax.net.ssl.keyStorePassword=...
-Djavax.net.ssl.trustStore=...
-Djavax.net.ssl.trustStorePassword=...
-javaagent:lib/agent.jar</screen>
                    <para>See chapter <xref linkend="VM-Arguments"/> for a description of above
                        VM-Arguments.</para>
                    <para>When accessing the system through a firewall, the two ports 1099 and 1098
                        have to be opened.</para>
                    <para>When starting JConsole connect to <literal>&lt;serverURL>:1099</literal>
                        with the following VM-Arguments pointing to the same keystore and truststore
                        (as well as passwords) used on the server:</para>
                    <screen>-Djavax.net.ssl.keyStore=...
-Djavax.net.ssl.keyStorePassword=...
-Djavax.net.ssl.trustStore=...
-Djavax.net.ssl.trustStorePassword=...</screen>
                </section>
            </section>
            <section>
                <title>Monitoring Functionality</title>
                <para>The AlgoTrader Client will invoke the checkIsAlive method of the
                    ManagementService according to the defined interval (i.e. AlgoTrader program
                    argument "-interval=10"). If the method does not return within the specified
                    interval, a timeout message is displayed and an alarm sound is played. This way
                    the person in charge of monitoring the System is being notified if the system is
                    down or not reachable anymore (e.g. stale JVM).</para>
            </section>
            <section>
                <title>Additional MBeans</title>
                <para>In addition the following system functions can be monitored through JMX as
                    well:</para>
                <table frame="all" pgwide="1">
                    <title>JMX Subsystems</title>
                    <tgroup cols="2">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>JMX Subsystem</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>Esper</entry>
                                <entry>Esper Instance Management (i.e. Esper Runtime, Named Windows
                                    and Statements)</entry>
                            </row>
                            <row>
                                <entry>C3P0</entry>
                                <entry>DataSource Connection Pool Management</entry>
                            </row>
                            <row>
                                <entry>Log4J</entry>
                                <entry>Management of the Log4J Logging System</entry>
                            </row>
                            <row>
                                <entry>EhCache</entry>
                                <entry>Management of the Second Level Cache EhCache. This service
                                    has to be used to clear the cache whenever values are changed
                                    directly in the DB</entry>
                            </row>
                            <row>
                                <entry>Hibernate</entry>
                                <entry>Hibernate Management (i.e. Collection, Entity, Query,
                                    SecondLevelCache and Session statistics)</entry>
                            </row>
                            <row>
                                <entry>QuickFix/J</entry>
                                <entry>QuickFix/J Management (i.e. QuickFix/J Sessions)</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>JConsole Modification</title>
                <para>A separate Eclipse Project AlgoTraderClient contains the following
                    modifications to JConsole:</para>
                <section>
                    <title>Tabular Data</title>
                    <para>TabularData Enhancement to display TabularData using JTable instead of the
                        built-in HTML format. The JTable is editable (F2). This can be used to copy
                        &amp; paste values (Note: modifications are however not stored in the
                        AlgoTrader database)</para>
                </section>
                <section>
                    <title>Attributes / Operations Split Pane</title>
                    <para>For every MBean Attributes and Operations are visible at the same time in
                        a Split Pane</para>
                </section>
                <section>
                    <title>Generated documentation</title>
                    <para>Supplied documentation to fields, operations and parameters will be
                        available in JConsole.</para>
                    <para>Example: "set the value of an esper variable" is added as documentation in
                        UML to the operation setVariableValue</para>
                    <figure>
                        <title>Operation Documentation in UML</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/UMLOperationDocumentation.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <para>This will result in a mouse-over documentation of the corresponding
                        operation in JConsole</para>
                    <figure>
                        <title>Operation Documentation in JConsole</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/JConsoleOperationDocumentation.gif"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                </section>
                <section>
                    <title>Read Only JConsole</title>
                    <para>By specifying the following VM Argument JConsole can be started in
                        Read-Only Mode where all Operations are disabled:</para>
                    <screen>-DreadOnly=true</screen>
                </section>
            </section>
        </section>
        <section id="EsperHQ_Client">
            <title>EsperHQ Client</title>
            <para>The EsperHQ Client is comprised of a rich multi-window GUI, the Esper data
                distribution service and real-time data displays (Eventlets).</para>
            <para> The EsperHQ multi-window user interface allows to manage Esper CEP engines,
                design and deploy Esper Statements as well as create and launch eventlets. In
                addition it has built-in displays include chart, grid, gauge and timeline. </para>
            <para>EsperHQ connects to Esper CEP engine instances via an integrated web application
                server (Jetty) and Esper Data Distribution Service endpoints. </para>
            <para>Esper Eventlets are configurable, interactive and easy to compose into a dashboard
                and present historical and event stream data from multiple distributable sources. </para>
            <para>EsperHQ is built on Adobe (R) Flex technology. The applications comprise of Flex
                modules and libraries that are cached or dynamically obtained by client web browsers
                from the web application server as needed. </para>
            <figure>
                <title>EsperHQ Client</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/EsperHQMainScreen.png" scalefit="1"/>
                    </imageobject>
                </mediaobject>
            </figure>
<section>
    <title>Installation</title>
    <para>To enable the EsperHQ Client the following two directories need to be added to the
                    <filename>algotrader/core</filename> project:</para>
            <itemizedlist>
                <listitem>
                    <para><filename>data</filename></para>
                </listitem>
                <listitem>
                    <para><filename>webapps</filename></para>
                </listitem>
            </itemizedlist>
            <para>In addition the following section of the file<filename>
                    /algotrader/common/src/main/resources/META-INF/esper-common.cfg.xml</filename>
                have to be enabled:</para>
            <programlisting language="XML">&lt;!-- Esper HQ -->
&lt;plugin-loader name="EndpointMgmt"
    class-name="com.espertech.esperdds.client.EndpointMgmtPlugin">
    &lt;init-arg name="esperdds.configuration.file" value="esperdds.cfg.xml" />
&lt;/plugin-loader>

&lt;plugin-loader name="EsperHQ_Webapp_Service"
    class-name="com.espertech.esper.server.webapp.WebAppPlugin">
    &lt;init-arg name="port" value="8400" />
    &lt;init-arg name="webapps" value="esperhq@webapps/esperhq" />
&lt;/plugin-loader>    </programlisting>
            <para>After starting the system, the EsperHQ client is now available via the following
                URL:</para>
            <para>
                <ulink url="http://localhost:8400/esperhq/esperhq/esperhq.html">http://localhost:8400/esperhq/esperhq/esperhq.html</ulink>
            </para></section>
            <section>
                <title>Dialogs</title>
                <para>The following Dialogs are presented by the EsperHQ Client</para>
                <variablelist>
                    <varlistentry>
                        <term>Create Statement Dialog</term>
                        <listitem>
                            <para>This quick-entry screen for creating a new, started statement
                                allows entering a statement name, an optional description and an EPL
                                expression. </para>
                            <para>The checkbox for pattern can be used to create an EPL pattern
                                statement (a statement utilizing only the EPL pattern language).
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Design Statement Dialog</term>
                        <listitem>
                            <para>This dialog allows creating new statements and editing existing
                                statements. </para>
                            <para>On the left side of the screen the dialog presents the forms to
                                add, modify or remove parts of the statement. The right side of the
                                screen shows the EPL statement text up-to-date with the changes made
                                in forms. The synchronization between forms and EPL statement occurs
                                when pressing enter on a form item. </para>
                            <para>The <literal>Templates</literal> button brings up a dialog to
                                choose a statement template. </para>
                            <para>The <literal>Existing</literal> button can be used to select an
                                existing statement for editing. </para>
                            <para>Use <literal>Compile</literal> to validate the statement
                                considering syntax but not considering whether required event types,
                                variables or named windows exist. </para>
                            <para>Use <literal>Create</literal> to create a started EPL statement.
                            </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Map Statements Dialog</term>
                        <listitem>
                            <para>The screen presents a graphical overview of the statements
                                including event types and their dependency as depicted by arrows. </para>
                            <para>Select the statements to be included by means of the <literal>Get
                                    All</literal> button to include all statements or the
                                    <literal>Criteria</literal> button to select a subset of
                                statements. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Event Types Dialog</term>
                        <listitem>
                            <para>The event type dialog shows all registered event types and, for
                                each type, the associated type detail. </para>
                            <para>The filter textbox and button is for quick finding of an event
                                type. </para>
                            <para>For each event type the grid also shows where the event type
                                originates from (named window, application-configured or
                                inserted-into stream), the properties available, the statements
                                referring to that type and the event type's super-types, if any. </para>
                            <para>By selecting an event type in the grid, the client populates the
                                type properties list, the type detail and the referring statements
                                table. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Named Windows Dialog</term>
                        <listitem>
                            <para>The named window dialog lists all named windows including the
                                statement name and EPL for creation of the named window. </para>
                            <para>The filter textbox and button is for quick finding of a named
                                window. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>On-Demand Query Dialog</term>
                        <listitem>
                            <para>You may enter a fire-and-forget, one-time executed query against a
                                named window into the query dialog box and execute the query. The
                                client displays query results in a table. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Statements Dialog</term>
                        <listitem>
                            <para>Use <literal>Get All</literal> to retrieve a list of all
                                statement. Use <literal>Search</literal> to search for statements
                                according to current statement criteria filter expression. Use the
                                    <literal>Criteria</literal> dialog to compose an expression that
                                selects only those statements matching the selected criteria. </para>
                            <para>The <literal>Quick Filter</literal> serves to reduce the list of
                                returned statement to those matching the entered text in statement
                                name or EPL. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Statement Dialog</term>
                        <listitem>
                            <para>The statement dialog shows statement detail including statement
                                name, description, EPL expression and properties of the statement
                                output. </para>
                            <para>Via <literal>Start</literal> (displayed if a statement is not
                                already started), <literal>Stop</literal> (displayed if a statement
                                is not already stopped) and <literal>Destroy</literal> a statement
                                can be started, stopped or destroyed. </para>
                            <para>Use <literal>Iterate</literal> to return current iteration results
                                for a statement. </para>
                            <para>Use <literal>Instant Live Capture</literal> to display an appended
                                grid with real-time results for the statement. </para>
                            <para>Use <literal>Save Live Capture</literal> to save an eventlet
                                configured to show an appended grid with real-time results for the
                                statement. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Statement Iteration Result Dialog</term>
                        <listitem>
                            <para>After you selected a statement for iteration, the
                                    <literal>Refresh</literal> button refreshes iteration results,
                                which are displayed as a table. </para>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Variables Dialog</term>
                        <listitem>
                            <para>The variable list displays all variables and their current values.
                                Select a variable, enter a new value and use
                                    <literal>Apply</literal> to set a new variable value. </para>
                            <para>The filter textbox and button is for quick finding of a variable.
                            </para>
                        </listitem>
                    </varlistentry>
                </variablelist>
                <para>There are a few other dialogs presented by the EsperHQ clients. However these
                    are not used by AlgoTrader:</para>
                <itemizedlist>
                    <listitem>
                        <para>Deployed Modules Dialog </para>
                    </listitem>
                    <listitem>
                        <para>Deployed Module Detail Dialog </para>
                    </listitem>
                    <listitem>
                        <para>Design Module Dialog </para>
                    </listitem>
                    <listitem>
                        <para>Simulation List Dialog </para>
                    </listitem>
                    <listitem>
                        <para>Simulation Status Dialog </para>
                    </listitem>
                    <listitem>
                        <para>Simulation Entry Dialog </para>
                    </listitem>
                    <listitem>
                        <para>Endpoints Dialog </para>
                    </listitem>
                    <listitem>
                        <para>Subscribers Dialog</para>
                    </listitem>
                </itemizedlist>
                <para>Additional Documentation on the EsperHQ client is available open
                    request.</para>
            </section>
        </section>
        <section id="Grails_Client">
            <title>Grails Client</title>
            <para>The Grails Client is located in the Project <filename>AlgoTrader/crud</filename>
                and provides CRUD (Create, Read, Update &amp; Delete) Operations for Management of
                AlgoTrader Reference Data.</para>
            <para>The running application will look like this</para>
            <figure>
                <title>Grails Client</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/GrailsClient.gif" scalefit="1"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>Currently CRUD Operations are available for the following entities:</para>
            <itemizedlist>
                <listitem>
                    <para>Strategy</para>
                </listitem>
                <listitem>
                    <para>Security</para>
                </listitem>
                <listitem>
                    <para>Forex</para>
                </listitem>
                <listitem>
                    <para>Future</para>
                </listitem>
                <listitem>
                    <para>StockOption</para>
                </listitem>
                <listitem>
                    <para>IntrestRate</para>
                </listitem>
                <listitem>
                    <para>SecurityFamily</para>
                </listitem>
                <listitem>
                    <para>Subscription</para>
                </listitem>
            </itemizedlist>
            <para>AlgoTrader CRUD is based on the <ulink url="http://grails.org"> grails</ulink>
                project, which has a feature called scaffolding, that is able to automatically
                create a CRUD application based on hibernate mapping files and Java Domain classes
                (= AndroMDA Entities).</para>
            <para>Please make sure that the <filename>algotrader/code</filename> project is
                available in the local maven repository by issuing the following maven command
                inside algotrader-code:</para>
            <screen>mvn install</screen>
            <section>
                <title>Run using Maven</title>
                <para>To run the application using maven the following two files have to be patched
                    in the local maven repository:</para>
                <itemizedlist>
                    <listitem>
                        <para>
                            <ulink url="http://algo-trader.googlecode.com/files/grails-gorm-1.3.7.jar">
                                grails-gorm-1.3.7.jar</ulink> to
                                <filename>user_home\.m2\repository\org\grails\grails-gorm\1.3.7</filename>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <ulink url="http://algo-trader.googlecode.com/files/grails-web-1.3.7.jar">
                                grails-web-1.3.7.jar</ulink> to
                                <filename>user_home\.m2\repository\org\grails\grails-web\1.3.7</filename>
                        </para>
                    </listitem>
                </itemizedlist>
                <para>To start the AlgoTraderCrud application execute the following maven
                    command:</para>
                <screen>mvn -Ddisable.auto.recompile=true grails:run-app</screen>
                <para>After Tomcat has started up, the AlgoTrader CRUD application can be accessed
                    at the following URL: <ulink url="http://localhost:8080/algotrader-crud/">http://localhost:8080/algotrader-crud/</ulink>
                </para>
            </section>
            <section>
                <title>Run Using Grails</title>
                <para>Alternatively the application can be started using Grails directly:</para>
                <para>Please install version 1.3.7 from <ulink url="http://grails.org/Download">http://grails.org/download</ulink>
                </para>
                <para>Set the environment variable <parameter>GRAILS_HOME</parameter> to the
                    directory where you installed grails and also add the
                        <filename>GRAILS_HOME/bin</filename> directory to the PATH environment
                    variable.</para>
                <para>In addition the following two files have to be patched in the local ivy2
                    repository:</para>
                <itemizedlist>
                    <listitem>
                        <para>
                            <ulink url="http://algo-trader.googlecode.com/files/grails-gorm-1.3.7.jar">
                                grails-gorm-1.3.7.jar</ulink> to
                                <filename>user_home\.ivy2\cache\org.grails\grails-gorm\1.3.7</filename>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <ulink url="http://algo-trader.googlecode.com/files/grails-web-1.3.7.jar">
                                grails-web-1.3.7.jar</ulink> to
                                <filename>user_home\.ivy2\cache\org.grails\grails-web\1.3.7</filename>
                        </para>
                    </listitem>
                </itemizedlist>
                <para>To start the AlgoTraderCrud application execute the following grails
                    command:</para>
                <screen>grails -Ddisable.auto.recompile=true run-app</screen>
                <para>After Tomcat has started up, the AlgoTraderCrud application can be accessed at
                    the following URL: <ulink url="http://localhost:8080/algotrader-crud/">http://localhost:8080/algotrader-crud/</ulink>
                </para>
                <note>
                    <itemizedlist>
                        <listitem>
                            <para>If unexpected results show up, it usually helps to delete
                                everything in the <filename>target</filename> directory inside the
                                AlgoTraderCrud application before starting up</para>
                        </listitem>
                        <listitem>
                            <para>Also it might help to do a "mvn install" on all AlgoTrader maven
                                projects to ensure that the latest version exists in the local
                                repository</para>
                        </listitem>
                    </itemizedlist>
                </note>
            </section>
        </section>
    </chapter>
    <chapter id="Installation">
        <title>Installation</title>
        <section>
            <title>Common Installation Tasks</title>
            <variablelist>
                <varlistentry>
                    <term>Java JDK</term>
                    <listitem>
                        <para>Install the latest Java JDK from <ulink url="http://www.oracle.com/technetwork/java/index.html">Oracle</ulink></para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>Subversion</term>
                    <listitem>
                        <para>Install the latest 1.6 version of <ulink url="http://subversion.apache.org/">Subversion</ulink>. Subversion
                            1.7 and later have a different repository structure and will therefore
                            not work with the current AlgoTrader repository.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>MySql</term>
                    <listitem>
                        <para>Install the latest <ulink url="http://www.mysql.com/downloads/mysql/">
                                MySql Community Server</ulink>
                        </para>
                        <itemizedlist>
                            <listitem>
                                <para>use password: password for the root user</para>
                            </listitem>
                            <listitem>
                                <para>run the script:
                                        <command>algotrader-core/sql/db-structure.sql</command>
                                </para>
                            </listitem>
                            <listitem>
                                <para>run the script:
                                        <command>algotrader-core/sql/db-data.sql</command>
                                </para>
                            </listitem>
                        </itemizedlist>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>Maven</term>
                    <listitem>
                        <para>Install the latest version of <ulink url="http://maven.apache.org">Maven</ulink>.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>ActiveMQ</term>
                    <listitem>
                        <para>Install the latest version of Apache <ulink url="http://activemq.apache.org/">ActiveMQ</ulink></para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
        <section>
        <title>Development Environment Installation</title>
        <section id="Platform_requirements">
            <title>Platform Requirements</title>
            <para>For development of new Strategies the following Platform requirements
                exist:</para>
            <table frame="all" pgwide="1">
                <title>Platform requirements</title>
                <tgroup cols="3">
                    <colspec colwidth="3.5*"/>
                    <colspec colwidth="5.5*"/>
                    <colspec colwidth="1*"/>
                    <thead>
                        <row>
                            <entry>Software</entry>
                            <entry>URL</entry>
                            <entry>Tested Version</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>Java JDK</entry>
                            <entry><ulink url="http://java.sun.com">http://java.sun.com</ulink></entry>
                            <entry>1.7.0</entry>
                        </row>
                        <row>
                            <entry>Eclipse IDE</entry>
                            <entry><ulink url="http://www.eclipse.org">http://www.eclipse.org</ulink></entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>Subversive SVN Team Provider</entry>
                            <entry><ulink url="http://download.eclipse.org/releases/...">http://download.eclipse.org/releases/...</ulink></entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>Subversive SVN Connectors</entry>
                            <entry>via Eclipse Preferences / Team / SVN / SVN Connector</entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>SVNKit</entry>
                            <entry>via Eclipse Preferences / Team / SVN / SVN Connector</entry>
                            <entry>1.3.7</entry>
                        </row>
                        <row>
                            <entry>m2e</entry>
                            <entry><ulink url="http://download.eclipse.org/releases/...">http://download.eclipse.org/releases/...</ulink></entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>m2e connector for build-helper-maven-plugin</entry>
                            <entry>via Eclipse Preferences / Maven / Discovery</entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>Eclipse XML Tools</entry>
                            <entry><ulink url="http://download.eclipse.org/releases/...">http://download.eclipse.org/releases/...</ulink></entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>Hibernate Tools</entry>
                            <entry><ulink url="http://download.jboss.org/jbosstools/updates/development/xxx">http://download.jboss.org/jbosstools/updates/development/...</ulink>
                                </entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>Spring IDE Core</entry>
                            <entry><ulink url="http://springide.org/updatesite">http://springide.org/updatesite</ulink></entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>Spring IDE Autowire Extension</entry>
                            <entry><ulink url="http://springide.org/updatesite">http://springide.org/updatesite</ulink></entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>Veloeclipse</entry>
                            <entry><ulink url="http://veloeclipse.googlecode.com">http://veloeclipse.googlecode.com</ulink></entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>JDT Decompiler Feature</entry>
                            <entry><ulink url="http://jadclipse.sf.net/update">http://jadclipse.sf.net/update</ulink></entry>
                            <entry>newest</entry>
                        </row>
                            <row>
                                <entry>JD-Eclipse Plug-in</entry>
                                <entry><ulink url="http://java.decompiler.free.fr/jd-eclipse/update">http://java.decompiler.free.fr/jd-eclipse/update</ulink></entry>
                                <entry>newest</entry>
                            </row>
                            <row>
                                <entry>Eclipse Colorer</entry>
                                <entry><ulink url="http://colorer.sf.net/eclipsecolorer/">http://colorer.sf.net/eclipsecolorer/</ulink></entry>
                                <entry>newest</entry>
                            </row>
                        <row>
                            <entry>MagicDraw UML</entry>
                            <entry><ulink url="http://www.magicdraw.com">http://www.magicdraw.com</ulink></entry>
                            <entry>16.5</entry>
                        </row>
                        <row>
                            <entry>MySql Database</entry>
                            <entry><ulink url="http://www.mysql.com">http://www.mysql.com</ulink></entry>
                            <entry>newest</entry>
                        </row>
                        <row>
                            <entry>TOAD for MySql</entry>
                            <entry><ulink url="http://www.quest.com/toad-for-mysql">http://www.quest.com/toad-for-mysql</ulink></entry>
                            <entry>newest</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
                <section>
                    <title>Esper Colorer</title>
                    <para>AlgoTrader provides a custom  Esper EPL Syntax Highlighter based on the <ulink url="http://colorer.sourceforge.net/">Colorer</ulink> Library.</para>
                    <para>Together with the <ulink url="http://colorer.sourceforge.net/eclipsecolorer/index.html">Eclipse Colorer Plugin</ulink> it provides the following
                        features:</para>
                        <itemizedlist>
                            <listitem>
                                <para>Automatic Code Outlining</para>
                            </listitem>
                            <listitem>
                                <para>Pairs/Brace Matching</para>
                            </listitem>
                            <listitem>
                                <para>Automatic Code Folding</para>
                            </listitem>
                            <listitem>
                                <para>Present different colors for:</para>
                                <itemizedlist>
                                    <listitem>
                                        <para>Reserved Keywords</para>
                                    </listitem>
                                    <listitem>
                                        <para>Symbols</para>
                                    </listitem>
                                    <listitem>
                                        <para>Comments</para>
                                    </listitem>
                                    <listitem>
                                        <para>Literals</para>
                                    </listitem>
                                    <listitem>
                                        <para>Numbers</para>
                                    </listitem>
                                </itemizedlist>
                            </listitem>
                        </itemizedlist>
                    <figure>
                        <title>Syntax Highlighter</title>
                        <mediaobject>
                            <imageobject>
                                <imagedata scalefit="1" fileref="images/SyntaxHighlighter.png"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <para>Please follow these steps to install the custom EPL Syntax
                        Highlighter:</para>
                    <orderedlist>

                                <listitem>
                                    <para>Install the <ulink url="http://colorer.sourceforge.net/eclipsecolorer/index.html">Eclipse Colorer Plugin</ulink></para>
                                </listitem>
                                <listitem>
                                    <para>Copy the file <filename>/algotrader-core/src/main/resources/esper.hrc</filename> to
                                    <filename>eclipse\plugins\net.sf.colorer_x.x.x\colorer\hrc\</filename></para>
                                </listitem>
                                <listitem>
                                    <para>Add the following lines to
                                    <filename>eclipse\plugins\net.sf.colorer_x.x.x\colorer\hrc\proto.hrc</filename></para>
                                </listitem>
                    </orderedlist>
                    <programlisting language="XML">&lt;prototype name="esper" group="database" description="Esper">
    &lt;location link="esper.hrc"/>
    &lt;filename>/\.epl$/i&lt;/filename>
&lt;/prototype></programlisting>
                    <note>
                        <para>The Syntax Highlighter does not provide Code Completion or Syntax
                            Checking!</para>
                    </note>

                </section>
        </section>
        <section>
            <title>Subversion Checkout</title>
            <para>It is recommended to use the Plugin m2e for the initial checkout (Import / Maven /
                Check out Maven Projects from SCM).</para>
            <important>
                <para>Note: AndroMDA does not allow any special characters (i.e. spaces or
                    exclamation marks) in the project path.</para>
            </important>
            <para>Select the following SVN Location:</para>
            <screen>https://repo.algotrader.ch/svn/trunk/AlgoTrader</screen>
            <para>This will create the following projects in Eclipse:</para>
            <itemizedlist>
                <listitem>
                    <para>
                        <filename>algotrader </filename>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <filename>algotrader/common</filename>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <filename>algotrader/core</filename>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <filename>algotrader/client</filename>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <filename>algotrader/crud</filename>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <filename> algotrader/mda</filename>
                    </para>
                </listitem>
            </itemizedlist>
        </section>
        <section>
            <title>Generate the code</title>
            <para>Right click on the project <filename>algotrader-mda</filename> / Run As / Maven
                install. This will generate all necessary code into
                    <filename>algotrader-core</filename> and<filename> algotrader-common</filename>
                target directory.</para>
        </section>
        <section>
            <title>Compile</title>
            <para>Now refresh all projects. Eclipse will compile all java code automatically.</para>
            <important>
                <para>Before this is done, please check the Java Build Path of
                        <filename>algotrader-code</filename> project. There are two sources
                    configured. The source folder<filename> target/src/main/java</filename> might
                    have an Exclude defined (Star-Star), which needs to be removed.</para>
            </important>
        </section>
        <section id="Starting_a_Strategy">
            <title>Starting a Strategy</title>
            <para>Before running a strategy check the database table
                <parameter>strategy</parameter>. Only the records <literal>BASE</literal> and the
                record <parameter>strategyName</parameter> should be set to
                    <parameter>AUTO_ACTIVATE</parameter>. In addition the strategy should have an
                allocation amount greater than 0.0 and the total of all allocations needs to be 1.0
                (e.g. <literal>BASE</literal> = 0.0 and <parameter>strategyName</parameter> = 1.0).</para>
            <section id="Simulation_Mode">
                <title>Simulation Mode</title>
                <para>To run a strategy in Simulation Mode the class
                        <classname>com.algoTrader.starter.SimulationStarter</classname> inside the
                    core project <filename>algotrader/core</filename> has to be invoked.</para>
                <para>If using Eclipse specify the following in the Launch Configuration:</para>
                <variablelist>
                    <varlistentry>
                        <term>Main-Tab</term>
                        <listitem>
                            <itemizedlist>
                                <listitem>
                                    <para>Project: algotrader-core</para>
                                </listitem>
                                <listitem>
                                    <para>Main Class:
                                            <classname>com.algoTrader.starter.SimulationStarter</classname>
                                    </para>
                                </listitem>
                            </itemizedlist>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Arguments-Tab / Programm-Arguments</term>
                        <listitem>
                            <screen>simulateWithCurrentParams </screen>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Arguments-Tab / VM-Arguments</term>
                        <listitem>
                            <screen>-Dsimulation=true
-DstrategyName=XXX
-DdataSource.dataSet=yyy
-Dspring.profiles.active=simulation,server</screen>
                        </listitem>
                    </varlistentry>
                    <varlistentry>
                        <term>Classpath / User Entries</term>
                        <listitem>
                            <itemizedlist>
                                <listitem>
                                    <para>add project algotrader-xxx (the strategy project)</para>
                                </listitem>
                            </itemizedlist>
                        </listitem>
                    </varlistentry>
                </variablelist>
            </section>
            <section id="Live_Trading_Mode">
                <title>Live Trading Mode</title>
                <para>To run the Strategy in Live Trading Mode the corresponding Broker Interface
                    (e.g. local Client, local Gateway or VPN Connection) needs to be up and
                    running.</para>
                <para>If using InteractiveBrokers the Trader Workstation or the IB Gateway have to
                    be running with the following configurations under API/Settings:</para>
                <itemizedlist>
                    <listitem>
                        <para>Enable ActiveX and Socket Clients</para>
                    </listitem>
                    <listitem>
                        <para>Socket Port: 4001</para>
                    </listitem>
                    <listitem>
                        <para>Trusted IP Addresses: 127.0.0.1</para>
                    </listitem>
                </itemizedlist>
                <para>In Live Trading Mode the Base and the strategy run in separate JVM's and have
                    to be started separately.</para>
                <section>
                    <title>Starting the Base</title>
                    <para>If using Eclipse specify the following in the Launch Configuration to
                        start the Base:</para>
                    <variablelist>
                        <varlistentry>
                            <term>Main-Tab</term>
                            <listitem>
                                <itemizedlist>
                                    <listitem>
                                        <para>Project: algotrader-core</para>
                                    </listitem>
                                    <listitem>
                                        <para>Main Class:
                                                <classname>com.algoTrader.starter.MarketDataStarter</classname>
                                        </para>
                                    </listitem>
                                </itemizedlist>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Arguments-Tab / VM-Arguments</term>
                            <listitem>
                                <screen>-Dsimulation=false
-Dspring.profiles.active=server,trading,&lt;brokerProfile> </screen>
                                <para>
                                    <parameter>brokerProfile</parameter>: the SpringProfile
                                    corresponding to the broker interface in use (e.g. iBNative or
                                    iBFix)</para>
                            </listitem>
                        </varlistentry>
                    </variablelist>
                </section>
                <section>
                    <title>Starting the Strategy</title>
                    <para>If using Eclipse specify the following in the Launch Configuration to
                        start the Strategy:</para>
                    <variablelist>
                        <varlistentry>
                            <term>Main-Tab</term>
                            <listitem>
                                <itemizedlist>
                                    <listitem>
                                        <para>Project: strategy project</para>
                                    </listitem>
                                    <listitem>
                                        <para>Main Class:
                                                <classname>com.algoTrader.starter.XXXStarter</classname>
                                            (the starter class of the Strategy)</para>
                                    </listitem>
                                </itemizedlist>
                            </listitem>
                        </varlistentry>
                        <varlistentry>
                            <term>Arguments-Tab / VM-Arguments</term>
                            <listitem>
                                <screen>-Dsimulation=false</screen>
                            </listitem>
                        </varlistentry>
                    </variablelist>
                </section>
            </section>
        </section>
    </section>
        <section>
            <title>Server Environment Installation</title>
            <para>Typically Server Installations are based on the latest Maven Release and not on
                Source Code from Subversion. The file
                    <filename>algotrader/core/bin/pom.xml</filename> contains a single dependency to
                the <filename>algotrader/core/pom.xml</filename>. By having a copy of this file the
                Maven Dependency Mechanism will make sure that all necessary Maven Modules
                (algotrader-common, algotrader-core and 3rd party libraries) are downloaded
                automatically.</para>
            <para>The installation process in a Server Environment would typically involve the
                following steps</para>
            <para>
                <orderedlist>
                    <listitem>
                        <para> create a directory <filename>AlgoTrader</filename>
                        </para>
                    </listitem>
                    <listitem>
                        <para> checkout the following directory via SVN, which contains the
                                <filename>pom.xml</filename> and different shell scripts:
                                <literal>https://repo.algotrader.ch/svn/trunk/AlgoTrader/core/bin</literal>
                        </para>
                    </listitem>
                    <listitem>
                        <para> create directories <filename>data</filename>,
                                <filename>log</filename> and <filename>data</filename> underneath
                                <filename>AlgoTrader</filename></para>
                    </listitem>
                    <listitem>
                        <para> run <filename>AlgoTrader/bin/update.sh</filename> which will resolve
                            all Maven Dependencies</para>
                    </listitem>
                    <listitem>
                        <para> if necessary modify <filename>AlgoTrader/bin/run-base.sh</filename>
                            (i.e. add custom VM-Arguments) </para>
                    </listitem>
                    <listitem>
                        <para> copy files <filename>keystore</filename> and
                                <filename>truststore</filename> to
                                <filename>AlgoTrader/bin</filename> (see <xref linkend="JMX"/>)</para>
                    </listitem>
                </orderedlist>
            </para>
            <para>The Base can now be started via by calling the following shell script:</para>
            <screen><filename>AlgoTrader/bin/run-base.sh</filename></screen>
            <para>Depending on the actual requirements for the Server Environment (Operation System,
                external Broker used, etc.) actual Configurations will vary substantially. </para>
            <note>
                <para>It is recommended to work with AlgoTrader Professional Services to plan an
                    roll-out Server Environments</para>
            </note>
        </section>
        <section id="VM-Arguments">
            <title>VM-Arguments</title>
            <para>Many of the characteristics of the System can be customized with VM-Arguments, the
                following list provides an overview of commonly used settings. In addition any of
                the Configuration parameters can also be modified via VM argument <xref linkend="Configuration"/>.</para>
            <variablelist>
                <varlistentry>
                    <term>-DlogLevel</term>
                    <listitem>
                        <para>log4j log level (<literal>ERROR</literal>, <literal>WARN</literal>,
                                <literal>INFO</literal> or <literal>DEBUG</literal>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dspring.profiles.active</term>
                    <listitem>
                        <para>list of Spring Profiles to activate (see <xref linkend="Spring-Profiles"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dcom.algoTrarder.rmi.registryPort</term>
                    <listitem>
                        <para>the RMI registry Port, e.g. 1099 (for <xref linkend="Remote-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dcom.algoTrarder.rmi.serverPort</term>
                    <listitem>
                        <para>the RMI server Port, e.g. 1098 (for <xref linkend="Remote-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Djava.rmi.server.hostname</term>
                    <listitem>
                        <para>the hostname of the system, e.g. localhost (for <xref linkend="Remote-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dcom.sun.management.jmxremote.port</term>
                    <listitem>
                        <para>the RMI registry Port, e.g. 1099 (for <xref linkend="Local-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dcom.sun.management.jmxremote.authenticate</term>
                    <listitem>
                        <para>use RMI authentication (true for <xref linkend="Remote-JMX-Access"/>;
                            false for <xref linkend="Local-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dcom.sun.management.jmxremote.ssl</term>
                    <listitem>
                        <para>use SSL encryption (true for <xref linkend="Remote-JMX-Access"/>;
                            false for <xref linkend="Local-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dcom.sun.management.jmxremote.ssl.need.client.auth</term>
                    <listitem>
                        <para>use SSL client authentication (true for <xref linkend="Remote-JMX-Access"/>; false for <xref linkend="Local-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dcom.sun.management.jmxremote.registry.ssl</term>
                    <listitem>
                        <para>use SSL encryption for the RMI registry (true for <xref linkend="Remote-JMX-Access"/>; false for <xref linkend="Local-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Djavax.net.ssl.keyStore</term>
                    <listitem>
                        <para>the keystore file (for <xref linkend="Remote-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Djavax.net.ssl.keyStorePassword</term>
                    <listitem>
                        <para>the keystore password (for <xref linkend="Remote-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Djavax.net.ssl.trustStore</term>
                    <listitem>
                        <para>the truststore file (for <xref linkend="Remote-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Djavax.net.ssl.trustStorePassword</term>
                    <listitem>
                        <para>the truststore password (for <xref linkend="Remote-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-javaagent:lib/agent.jar</term>
                    <listitem>
                        <para>the custom JMX agent (for <xref linkend="Remote-JMX-Access"/>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Xmx</term>
                    <listitem>
                        <para>increase the Java Heap Size to specified amount (e.g.
                                <literal>2048M</literal>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-XX:MaxPermSize</term>
                    <listitem>
                        <para>increase the Java Perm Size to specified amount (e.g.
                                <literal>1024M</literal>)</para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
    </chapter>
    <chapter id="Strategy_Development">
        <title>Strategy Development</title>
        <para>It is recommended to do a thorough Back Testing of a newly developed strategy. After
            that the strategy should be tested with a Paper Trading Account. At the end of a
            thorough test procedure, the new strategy can be put into production. The following
            diagram shows the general procedure for developing new strategies:</para>
        <figure>
            <title>Strategy Development Process</title>
            <mediaobject>
                <imageobject>
                    <imagedata scalefit="1" fileref="images/StrategyDevelopmentProcess.gif"/>
                </imageobject>
            </mediaobject>
        </figure>
        <section>
            <title>Setting up a new Strategy</title>
            <para>The following paragraph will give a short example based on a simple moving average
                strategy (with the Short Name MOV).</para>
            <para>A strategy is based on the following minimum artifacts:</para>
            <variablelist>
                <varlistentry>
                    <term>
                        <filename>/src/main/java/com/algoTrader/strategy/MovServiceImpl.java</filename>
                    </term>
                    <listitem>
                        <para>the strategy service class</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/java/com/algoTrader/strategy/MovStarter.java</filename>
                    </term>
                    <listitem>
                        <para>The class containing the main method to start the strategy in its own JVM in Live
                            Trading Mode</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/module-mov-init.epl</filename>
                    </term>
                    <listitem>
                        <para>Esper Module containing statements related to indicators or signal
                            generation</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/module-mov-run.epl</filename>
                    </term>
                    <listitem>
                        <para>Esper Module containing statements that invoke actions on the Java
                            side (e.g. send orders). These statements will only be active in Live
                            Trading but not in Prefeeding Mode.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/META-INF/conf-mov.properties</filename>
                    </term>
                    <listitem>
                        <para>Contains parameters used by the strategy (i.e. Moving average
                            durations etc.)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/META-INF/esper-mov.cfg.xml</filename>
                    </term>
                    <listitem>
                        <para>Contains event-types, imports, variables and general Esper
                            settings</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/META-INF/applicationContext-client-mov.xml</filename>
                    </term>
                    <listitem>
                        <para>Application Context File for the strategy, mainly containing autowire
                            instructions</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename> /log </filename>
                    </term>
                    <listitem>
                        <para>log files</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename> /lib </filename>
                    </term>
                    <listitem>
                        <para>Jar Files not available through maven</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>DB table strategy</term>
                    <listitem>
                        <para>A record for the strategy</para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <section>
                <title>MovService.java</title>
                <para>This is the main Java-class containing the Business Logic.</para>
                <para>The references to the Services provided by the Base (e.g. OrderService, PositionService,
                    etc.) will be auto injected on startup by the Spring Framework</para>
                <para>The following example shows how to instruct the Base to open a new
                    position:</para>
                <programlisting language="Java">public class MovService {

  public void openPosition(String strategyName, int securityId, BigDecimal price) {

   Strategy strategy = getLookupService().getStrategyByNameFetched(strategyName);<co id="movService-getStrategy"/>
   Security security = getLookupService().getSecurity(securityId);

   int qty = (int) (strategy.getAvailableFundsDouble() / price.doubleValue());<co id="movService-getQuantity"/>

   if (qty &lt;= 0) { return; }

   Order order = new MarketOrder.Factory.newInstance();<co id="movService-createOrder"/>
   order.setSecurity(security);
   order.setStrategy(strategy);
   order.setQuantity(qty);
   order.setSide(Side.BUY);

   getOrderService().sendOrder(order); <co id="movService-sendOrder"/>
  }
}</programlisting>
                <para>The openPosition method contains the following steps:</para>
                <calloutlist>
                    <callout arearefs="movService-getStrategy">
                        <para>Get a reference to the Strategy Entity by the LookupService.</para>
                    </callout>
                    <callout arearefs="movService-getQuantity">
                        <para>Evaluate the quantity to purchase (in this case by the available
                            funds).</para>
                    </callout>
                    <callout arearefs="movService-createOrder">
                        <para>Construct an Order Object (simple POJO object) containing the
                            strategy, the security, the quantity and the transaction type.</para>
                    </callout>
                    <callout arearefs="movService-sendOrder">
                        <para>Send the Order to the market via the OrderService</para>
                    </callout>
                </calloutlist>
            </section>
            <section id="MovStarter">
                <title>MovStarter</title>
                <programlisting language="Java">public class BoxStarter {

  public static void main(String[] args) throws Exception {

    ServiceLocator.instance().init(ServiceLocator.CLIENT_BEAN_REFERENCE_LOCATION); <co id="movStarter-initServiceLocator"/>
    MovService movService = ServiceLocator.instance().
      getService("movService", MovService.class); <co id="movStarter-getMovService"/>

    String strategyName = movService.getStrategyName();

    EsperManager.initServiceProvider(strategyName); <co id="movStarter-initEsper"/>

    EsperManager.deployInitModules(strategyName); <co id="movStarter-initModules"/>

    movService.prefeedTicks(); <co id="movStarter-prefeed"/>

    EsperManager.setInternalClock(strategyName, true); <co id="movStarter-internalClock"/>

    EsperManager.deployRunModules(strategyName); <co id="movStarter-runModules"/>

    SubscriptionService subscriptionService = ServiceLocator.instance().getSubscriptionService();
    subscriptionService.initMarketDataEventSubscriptions(); <co id="movStarter-subscriptions"/>
  }
}</programlisting>
                <para>The main method contains the following steps:</para>
                <calloutlist>
                    <callout arearefs="movStarter-initServiceLocator">
                        <para>initialize the ServiceLocator to let the Spring Environment know that it is in Live
                            Trading Mode on the strategy side</para>
                    </callout>
                    <callout arearefs="movStarter-getMovService">
                        <para>get a reference to the MovService</para>
                    </callout>
                    <callout arearefs="movStarter-initEsper">
                        <para>initialize the Esper Engine for the MOV Strategy</para>
                    </callout>
                    <callout arearefs="movStarter-initModules">
                        <para>deploy all init-modules</para>
                    </callout>
                    <callout arearefs="movStarter-prefeed">
                        <para>start feeding historical market data events (of a certain time period)
                            to initialize the moving average indicators. The Esper Engine is set to
                            externalClock, which means that it's time is advanced according to
                            prefeeded market data events</para>
                    </callout>
                    <callout arearefs="movStarter-internalClock">
                        <para>switch to internalClock. After this, the Esper Engine's time is
                            advanced according to the Wall Clock.</para>
                    </callout>
                    <callout arearefs="movStarter-runModules">
                        <para>deploy the run modules.</para>
                    </callout>
                    <callout arearefs="movStarter-subscriptions">
                        <para>init marketDataSubscriptions so that the strategy receives live market
                            data events for the securities that it is subscribed to</para>
                    </callout>
                </calloutlist>
            </section>
            <section>
                <title>module-mov-init.epl</title>
                <para>This Esper module contains the statements that generate signals by using a
                    moving average indicator by using the <ulink url="http://www.ta-lib.org/"> talib
                        library</ulink>.</para>
                <programlisting>@Name('MOVING_AVERAGE')
insert into
  Indicator
select
  talib("movingAverage", currentValueDouble, movLengthFast, "Sma")
  - talib("movingAverage", currentValueDouble, movLengthSlow, "Sma") as value
from
  Tick(security.isin = underlyingIsin);</programlisting>
            </section>
            <section>
                <title>module-mov-run.epl</title>
                <para>This Esper module contains the statement that calls the
                        <methodname>MovService.openPosition()</methodname> whenever there is a
                    moving average crossover on the indicators. The Tag
                        <parameter>@Subscriber</parameter> is used to instruct the EsperManager to
                    attach the Subscriber to this statement.</para>
                <programlisting>@Name('OPEN_POSITION')
@Subscriber(className='com.algoTrader.strategy.MovService.openPosition')
select
  engineStrategy.name as strategyName,
  indexTick.security.id as underlyingid,
  indexTick.currentValue as underlyingSpot
from
  pattern [every (indexTick=Tick(security.isin=underlyingIsin)
    -> indicator=Indicator)]
where
  indicator.value > 0
and
  prior(1, indicator.value) &lt;= 0;</programlisting>
            </section>
            <section>
                <title>conf-mov.properties</title>
                <para>In addition there is the configuration file, which contains the necessary
                    parameters for the strategy:</para>
                <screen>underlyingIsin = US38259P5089
movLengthFast = 1000
movLengthSlow = 2000</screen>
                <para>In this case Ticks with <literal>security.isin = underlyingIsin</literal> are used. In
                    addition the fast/slow lengths to create the two moving average lines are
                    specified.</para>
            </section>
            <section>
                <title>esper-mov.cfg.xml</title>
                <para>The esper configuration file consists of the following main parts:</para>
                <programlisting language="XML">&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;esper-configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.espertech.com/schema/esper"
  xsi:schemaLocation="http://www.espertech.com/schema/esper
  http://www.espertech.com/schema/esper/esper-configuration-4-0.xsd">

  &lt;variable name="underlyingIsin" type="String"/>
  &lt;variable name="movLengthFast" type="int"/>
  &lt;variable name="movLengthSlow" type="int"/>

  &lt;plugin-loader name="EsperJMS"
    class-name="com.algoTrader.esper.io.jms.SpringContextLoader">
    &lt;init-arg name="inputAdapterBeanName" value="jmsInputAdapter"
  &lt;/plugin-loader>

&lt;/esper-configuration></programlisting>
                <para>The above file configures the required variables along with their type. The
                    actual values for the variables are taken from conf-mov.properties.</para>
            </section>
            <section>
                <title>applicationContext-client-mov.xml</title>
                <para>A typical Spring Configuration File looks like this:</para>
                <programlisting language="XML">&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:p="http://www.springframework.org/schema/p"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

  &lt;bean id="movService" class="com.algoTrader.strategy.MovService" autowire="byName" />

  &lt;bean id="strategyQueue" class="org.apache.activemq.command.ActiveMQQueue">
    &lt;constructor-arg value="MOV.QUEUE" />
  &lt;/bean>
&lt;/beans></programlisting>
                <para>The most important part is the configuration of the movService through AutoWiring. In
                    additional the JMS Queue <parameter>MOV.QUEUE</parameter> gets configured, see
                        <xref linkend="Messaging"/>
                </para>
            </section>
            <section>
                <title>DB table strategy</title>
                <para>For this new Strategy there also needs to be an entry in the DB table strategy
                    with the following values:</para>
                <table frame="all" pgwide="1">
                    <title>DB table strategy</title>
                    <tgroup cols="5">
                        <tbody>
                            <row>
                                <entry>NAME</entry>
                                <entry>AUTO_ACTIVATE</entry>
                                <entry>ALLOCATION</entry>
                                <entry>INIT_MODULES</entry>
                                <entry>RUN_MODULES</entry>
                            </row>
                            <row>
                                <entry>MOV</entry>
                                <entry>true</entry>
                                <entry>1.00</entry>
                                <entry>mov-init</entry>
                                <entry>mov-run</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
                <para>AUTO_ACTIVATE means that the strategy will be automatically run in simulation
                    mode. By using this field, several strategies can be run in parallel to see how
                    they interact.</para>
                <para>ALLOCATION is the percentage of total assets that will be allocated to this
                    strategy.</para>
                <note>
                    <itemizedlist>
                        <listitem>
                            <para>The total of all allocations need to add up to 100%</para>
                        </listitem>
                        <listitem>
                            <para>If only 50% is allocated to our Strategy MOV, the reminder of
                                50% needs to be allocated to the "BASE" strategy, which
                                represents the Base itself</para>
                        </listitem>
                        <listitem>
                            <para>It is possible to allocate more than 100% to one or more
                                strategies. In this case, the allocation of the Base will need
                                be negative in order for the total to be 100%</para>
                        </listitem>
                    </itemizedlist>
                </note>
            </section>
        </section>
        <section>
            <title>Hints for Strategy Development</title>
            <para>It is generally recommended to do Time-based Market Data Analysis and Signal
                Generation inside Esper Statements. On the other hand procedural actions like
                placing an order or subscribing to a Security are predominantly is done inside Java
                Code.</para>
            <section>
                <title>Print Statement Selects</title>
                <para>By means of the TestSubscriber, selected values of a Statement can be printed
                    to the Console.</para>
                <programlisting>@Name('TEST')
@Subscriber(className='com.algoTrader.esper.subscriber.TestSubscriber')
@SimulationOnly
  valueA,
  valueB
  valueC
from
  TestEvent;</programlisting>
            </section>
            <section>
                <title>Log the values of an Indicator to a log file</title>
                <para>Often strategies are based on a technical indicator. During simulation it is
                    often desirable to log the values of such an indicator to a log file. This can
                    be done with the following statement:</para>
                <programlisting>@Name('INSERT_INTO_INDICATOR')
@Listeners(classNames={'com.algoTrader.esper.listener.IndicatorListener'})
select
  dateTime.toDate() as dateTime,
  valueA,
  valueB
  valueC
from
  Indicator;</programlisting>
            </section>
            <section>
                <title>Access to Esper Variables</title>
                <para>Esper has a very sophisticated variable management functionality. It is
                    possible to access those variables from the Java side through the following
                    methods:</para>
                <programlisting language="Java">// set variable value
EsperManager.setVariableValue(strategyName, "target", target);

// retrieve variable value
Double target = (Double) EsperManager.getVariableValue(strategyName, "target");    </programlisting>
            </section>
            <section>
                <title>Esper Utility classes</title>
                <para>If a computation is too complex, it is not advisable to do it inside an Esper Statement.
                    For this purpose, it is often easier to create a small Utility class and use its
                    methods inside the statement. Example:</para>
                <programlisting language="Java">package com.algoTrader.strategy;

public class MovUtil {

  public static BigDecimal getExitValue(Direction direction, BigDecimal currentValue) {

    double exitValue = Direction.LONG.equals(direction) ?
      currentValue.doubleValue() * 0.98 :
      currentValue.doubleValue() * 1.02;

    return new BigDecimal(exitValue);
  }
}</programlisting>
                <para>This Utility class also needs to be declared in the file
                        <filename>esper-mov.xml</filename>:</para>
                <programlisting language="XML">&lt;auto-import import-name="com.algoTrader.strategy.MovUtil"/&gt;</programlisting>
                <para>Now, the Utility class can be used in an Esper Statement like this to adjust a
                    trailing stop loss:</para>
                <programlisting>@Name('ADJUST_EXIT_VALUE_FUTURES')
@Subscriber(className='com.algoTrader.service.PositionService.setExitValue')
select
  position.id as positionId,
  exitValue as value,
  false as force
from
  Tick as tick,
  method:LookupUtil.getPositionBySecurityAndStrategy(
    tick.security.id, engineStrategy.name) as position,
  method:MovUtil.getExitValue(position.direction, tick.currentValue) as exitValue
where
  ((position.direction = Direction.SHORT and exitValue.val &lt; position.exitValue)
  or
  (position.direction = Direction.LONG and exitValue.val > position.exitValue))
and
  position.quantity!= 0
and
  position.exitValue is not null
output
  first every 1 minutes;</programlisting>
            </section>
            <section>
                <title>Storing the latest Market Data Events</title>
                <para>For many parts of the strategy it is necessary to keep the last Market Data Event of each
                    subscribed Security. The following statement will do exactly this and save the
                    latest market data event per security for up to one week.</para>
                <programlisting>@Name('CURRENT_MARKET_DATA_EVENT')
select
  marketDataEvent.security.id as securityId,
  marketDataEvent.* as marketDataEvent
from
  MarketDataEvent.std:groupwin(security.id).win:length(1) as marketDataEvent
where
  marketDataEvent.dateTime.time >
  (current_timestamp - DateUtil.getDuration('WEEK_1'));</programlisting>
                <para>If all market data events over a certain period need to be kept (e.g. for
                    display in a chart), it is recommended to use a named window in the following
                    fashion:</para>
                <programlisting>@Name('MARKET_DATA_WINDOW')
@RunTimeOnly()
create window
  MarketDataWindow.win:time(1 hour)
    .std:firstunique(cast(Math.floor(current_timestamp / 1000),int))
as
  MarketDataEvent;</programlisting>
                <para>The above statement will save the first market data event per minute for a
                    total time of up to one hour. Because named windows do not store corresponding
                    events automatically, they have to be inserted with a statement like
                    this:</para>
                <programlisting>@Name('INSERT_INTO_CURRENT_VALUE_WINDOW')
@RunTimeOnly()
insert into
  MarketDataWindow
select
  *
from
  MarketDataEvent;</programlisting>
            </section>
            <section>
                <title>Prioritizing Statements</title>
                <para>If two statements are based on the same Event, it is necessary to set a
                    priority for each statement to make sure, the system behaves
                    deterministic:</para>
                <programlisting>@Name('STATEMENT_1')
@Priority(2)
select * from A;

@Name('STATEMENT_2')
@Priority(1)
select * from A;</programlisting>
            </section>
            <section>
                <title>Market Data Event Prefeeding</title>
                <para>When starting up a strategy in Live Trading Mode, it is often necessary to
                    initialize technical indicators that have a look-back period (see <xref linkend="MovStarter"/> for further details). This initialization is done by
                    feeding historical market data to the Esper Engine.</para>
                <para>A typical prefeed method will look like this:</para>
                <programlisting language="Java">public void prefeedTicks() throws Exception {

  Date date = DateUtils.addHours(new Date(), -1);
  Collection&lt;Tick> ticks = getLookupService().getTicksByMinDate(securityId, date);

  EsperManager.initCoordination(strategyName);
  EsperManager.coordinate(strategyName, ticks, "dateTime");
  EsperManager.startCoordination(strategyName);
}</programlisting>
                <para>This method will load all ticks for the security (defined by securityId) for
                    the last two hours. It will then feed all of them sequentially to the local
                    EsperEngine.</para>
            </section>
            <section>
                <title>Creation of Bars based on Ticks</title>
                <para>Often strategies rely on indicators that are based on OHLC Bars. Since Live
                    Market Data (i.e. Ticks) are not delivered in the format of Bars, it is often
                    necessary to create Bars from arriving Ticks. The chapter <xref linkend="Creation_of_Bars_based_on_Ticks"/> explains how to do this.</para>
            </section>
            <section>
                <title>Reacting upon a newly subscribed security</title>
                <para>Especially for Option and Future based strategies it is often not possible to
                    subscribe to the entire Option or Futures Chain in advance. Therefore that
                    actual Security that the strategy is interested in, is evaluated and subscribed
                    to at runtime. There are often steps that should take place immediately after
                    the first market data event has arrived for such a security.</para>
                <para>The chapter <xref linkend="FirstTickCallback"/> explains how to use a
                    FirstTickCallback for exactly this purpose</para>
            </section>
            <section>
                <title>Reacting upon an order</title>
                <para>A common use case is to wait for the full execution or cancellation of an
                    order and then take some additional action.</para>
                <para>The chapter <xref linkend="TradeCallback"/> explains how to use a
                    TradeCallback for exactly this purpose</para>
            </section>
            <section>
                <title>Expose a strategy specific method through the client</title>
                <para>Some strategies might need manual interventions. For this purpose a
                    StrategyService can expose any type of method through JMX. For further details
                    see <xref linkend="StrategyServices"/>
                </para>
            </section>
            <section>
                <title>Prevent <classname>LazyInitializationException</classname></title>
                <para>Since Strategies run in different JVM's their entire operation (Esper
                    Statements and Java Code) run outside of a Hibernate Session. Traversal along
                    the Object Tree (beyond <classname>Security</classname>,
                        <classname>SecurityFamily</classname>, Underlying
                        <classname>Security</classname>, <classname>Subscriptions</classname> and
                        <classname>Positions</classname> which get initialized when Market Data
                    Events are sent to the Strategy) would  throw a
                        <classname>LazyInitializationException</classname>. </para>
                <para>However each Entity contains custom getter methods (e.g.
                        <methodname>Transaction.getSecurityInitialized()</methodname> or
                        <methodname>Security.getPositionsInitialized()</methodname>) that check if
                    the requested association is already initialized. If not the
                        <classname>LazyLoaderService</classname> is called, which loads the
                    requested association (e.g. <classname>Security</classname> or
                        <classname>Positions</classname>). Subsequent calls to the same association
                    will then get access to the already initialized Entity or Collection. For
                    further details see <xref linkend="HibernateSession_Handling"/>.</para>
            </section>
            <section>
                <title>Prevent an action from happening multiple times</title>
                <para>Often a Java Action is triggered multiple times by a certain situation,
                    because the underlying cause takes a finite amount of time to be
                    resolved.</para>
                <para>Example: The current market level exceeds a defined stop, therefore a closing
                    order is placed. However during the time that the order is being executed at the
                    market, another market data event is received. Because the position is not yet
                    closed by that time, another closing order is placed, which is not
                    desired.</para>
                <para>To prevent this, the following Output Limit Clause should be appended to the
                    statement:</para>
                <programlisting>output first every 1 minutes; </programlisting>
                <para>the output first clause starts as soon as the first event arrives and then does not
                    process any more events for 1 minute. However it is still possible that two
                    events are processed, that are less than one minute apart from each other. See
                    the following example:</para>
                <itemizedlist>
                    <listitem>
                        <para>Tick 1 arrives at 18:00:00 and is processed</para>
                    </listitem>
                    <listitem>
                        <para>Tick 2 arrives at 18:00:30 and is ignored </para>
                    </listitem>
                    <listitem>
                        <para>Tick 3 arrives at 18:01:55 and is processed </para>
                    </listitem>
                    <listitem>
                        <para>Tick 4 arrives at 18:02:05 and is processed</para>
                    </listitem>
                </itemizedlist>
                <para>Tick 3 and Tick 4 are only 10 seconds apart, but they are still both processed!</para>
            </section>
            <section>
                <title>Execute an action once a day at a certain time</title>
                <programlisting>@Subscriber(className='com.algoTrader.service.PositionService.closePosition')
select
  position.id as positionId,
  false as unsubscribe
from
  pattern [every (timer:at(0, 18, *, *, 1:5) -> tick=Tick)],
  method:LookupUtil.getPositionBySecurityAndStrategy(
    tick.security.id, engineStrategy.name) as position
where
  position.quantity!= 0;</programlisting>
                <para>The above statement will close an eventual open position at 18:00:00 Mo-Fri.</para>
            </section>
            <section>
                <title>Rolling of Futures and Options</title>
                <para>Due to the expiring nature of Futures and Options, corresponding Positions
                    have to be rolled prior to the Expiration Date. Typically, this would involve
                    the following steps:</para>
                <orderedlist>
                    <listitem>
                        <para>Close the Front-Month Position</para>
                    </listitem>
                    <listitem>
                        <para>Unsubscribe the Front-Month Future/Option</para>
                    </listitem>
                    <listitem>
                        <para>Subscribe the Back-Month Future/Option</para>
                    </listitem>
                    <listitem>
                        <para>OnFirstTick (see <xref linkend="FirstTickCallback"/>) Open a new
                            Position</para>
                    </listitem>
                </orderedlist>
            </section>
            <section>
                <title>Handle Constant Maturity Futures</title>
                <para>Since Future have an expiration date and are therefore not continuous, it is often not
                    possible to base indicators on them. With the following statements it is however
                    possible to calculate a constant maturity market value:</para>
                <programlisting>@Name('INSERT_INTO_FRONT_FUTURE_TICK')
insert into
  FrontFutureTick
select
  tick.*
from
  Tick as tick
where
  cast(securityInitialized.duration?, int) = 1;</programlisting>
                <programlisting>@Name('INSERT_INTO_BACK_FUTURE_TICK')
insert into
  BackFutureTick
select
  tick.*
from
  Tick as tick
where
  cast(securityInitialized.duration?, int) = 2;</programlisting>
                <programlisting>@Name('CONSTANT_MATURITY')
select
  ConstantMaturityUtil.getConstantMaturityValue(front, back) as value
from
  pattern [every(
    (front=FrontFutureTick -> (back=BackFutureTick where timer:within(1 hour)))
      or
    (back=BackFutureTick -> (front=FrontFutureTick where timer:within(1 hour)))
  )];</programlisting>
                <para>The actual static method to calculate the constant maturity value looks like
                    this:</para>
                <programlisting language="Java">public static double getInterpolationValue(Tick frontTick, Tick backTick) {

  Future frontFuture = (Future) frontTick.getSecurityInitialized();
  Future backFuture = (Future) backTick.getSecurityInitialized();

  double weight = Math.max(0.0, Math.min(1.0,
    ((double) (backFuture.getExpiration().getTime()
      - DateUtil.getCurrentEPTime().getTime() - Duration.MONTH_1.getValue()))
      / ((double) (backFuture.getExpiration().getTime()
      - frontFuture.getExpiration().getTime()))));

  return weight * frontTick.getCurrentValueDouble()
    + (1 - weight) * backTick.getCurrentValueDouble();
}</programlisting>
            </section>
            <section>
                <title>State based Strategy</title>
                <para>Often a strategy has several states that it runs through during execution
                    (e.g. WAITING_FOR_SIGNAL, LONG_POSITION, SHORT_POSITION, etc.). For these
                    situations it is advisable to use a Java Enum, eg:</para>
                <programlisting language="Java">package com.algoTrader.strategy;

public enum State {
  WAITING_FOR_SIGNAL, LONG_POSITION, SHORT_POSITION;
}</programlisting>
                <para>In addition a corresponding Esper Variable has to be configured:</para>
                <programlisting language="XML">&lt;variable name="state" type="com.algoTrader.strategy.State"/&gt;</programlisting>
                <para>If the variable needs to have an initial value, the variable has to be
                    declared with a statement.</para>
                <programlisting>@Name('CREATE_VAR_STATE')
create variable com.algoTrader.enumeration.State state =
  State.WAITING_FOR_SIGNAL;        </programlisting>
                <para>It is then possible to query current state inside Esper statements like
                    this:</para>
                <programlisting>select * from ... where state = State.WAITING_FOR_SIGNAL;</programlisting>
            </section>
        </section>
    </chapter>
    <chapter id="Strategy_Backtesting">
        <title>Strategy Backtesting</title>
        <para>In simulation mode the Base as well as all strategies marked as autoActivate (in the
            database table <literal>strategy</literal>) are started inside the same JVM.</para>
        <para>All Esper engine instances are set to use external timing, meaning that Esper time
            will advance according to supplied market data files. The AdapterCoordinator is
            responsible for creating the necessary CurrentTimeEvents and send them to the Esper
            engine instances.</para>
        <para>Securities specified within the table subscription are fed to the corresponding Esper
            engine instances. The field <parameter>persistent</parameter> has the following meaning:</para>
        <itemizedlist>
            <listitem>
                <para>
                    <parameter>persistent = true</parameter>: these securities will always be
                        delivered to the strategy (i.e. for S&amp;P500)</para>
            </listitem>
            <listitem>
                <para>
                    <parameter>persistent = false</parameter>: these are securities requested by
                        a strategy for a specific duration of time (i.e. Options on S&amp;P500).
                        When restarting the simulation, these have to be requested again.</para>
            </listitem>
        </itemizedlist>
        <para>The CSV-File containing the market data has to be named and stored according to <xref linkend="Market_Data_File_Format"/>
        </para>
        <section>
            <title>Exchange Simulator</title>
            <para>In Simulation Mode, the system provides an Exchange Simulator Functionality, where
                the OrderService itself creates Fills based on the placed Order. Currently all
                orders get filled. MarketOrders get filled at the actual market prices supplied by
                market data events, whereas LimitOrders get filled at their LimitPrice.</para>
        </section>
        <section>
            <title>Simulation Process</title>
            <para>During a simulation process the following steps are executed sequentially:</para>
            <orderedlist>
                <listitem>
                    <para>The database is reset to its original state via the
                            <classname>ResetService</classname>
                    </para>
                </listitem>
                <listitem>
                    <para>Esper Engines are initialized for the Base as well as all strategies
                        marked as <parameter>autoActivate</parameter>.</para>
                </listitem>
                <listitem>
                    <para>All Esper Modules defined in column <literal>initModules</literal> and
                            <literal>runModules</literal> of the table strategy are deployed
                    </para>
                </listitem>
                <listitem>
                    <para>A Portfolio Rebalance is executed to distribute the initial CREDIT (of
                        1'000'000 USD) to strategies according to their allocation</para>
                </listitem>
                <listitem>
                    <para>For every <classname>StrategyService</classname> the method
                            <methodname>initSimulation</methodname> is invoked to execute any
                        initialization tasks if necessary</para>
                </listitem>
                <listitem>
                    <para>At that time the actual simulation starts and market data events are
                        starting to be sent into the Esper Engines</para>
                </listitem>
                <listitem>
                    <para>At the end of each simulation run, metrics are printed to the console
                        (if enabled), see <xref linkend="Metrics"/>
                    </para>
                </listitem>
                <listitem>
                    <para>All open positions are closed</para>
                </listitem>
                <listitem>
                    <para>General Performance statistics as well as strategy specific performance statistics
                        (gathered through
                            <classname>StrategyService.getSimulationResults</classname>) are printed
                        to the console, see <xref linkend="Performance_Statistics"/>
                    </para>
                </listitem>
                <listitem>
                    <para>Esper Engines are destroyed</para>
                </listitem>
                <listitem>
                    <para>The second-level cache is cleared</para>
                </listitem>
                <listitem>
                    <para>A Garbage Collection is performed</para>
                </listitem>
            </orderedlist>
        </section>
        <section>
            <title>Single Run Simulation</title>
            <para>To run a strategy in Simulation Mode with the currently defined parameters use the
                procedure defined in <xref linkend="Starting_a_Strategy"/>.</para>
        </section>
        <section>
            <title>Automated Parameter Optimization</title>
            <para>The system allows to run many simulations in parallel. Using cloud based servers
                thousands of simulation runs can be carried out in a matter of a few hours. Using
                Numerical Optimization functions (i.e. Brent &amp; Newton) optimal parameter ranges
                can be determined in an automated fashion.</para>
            <para>The following options exist:</para>
            <para>
                <emphasis role="bold">simulateBySingleParam</emphasis>
            </para>
            <para>One Simulation run with a parameter set to the defined value. The example below
                will do one run with paramter a set to 0.8</para>
            <screen>simulateBySingleParam a:0.8</screen>
            <para>
                <emphasis role="bold">simulateByMultiParam</emphasis>
            </para>
            <para>One Simulation run with multiple parameters set to defined values. The example
                below will do one run with paramter a set to 0.8 and b set to 12.0</para>
            <screen>simulateByMultiParam a:0.8,b:12.0</screen>
            <para>
                <emphasis role="bold">optimizeSingleParamLinear</emphasis>
            </para>
            <para>Multiple Simulation runs by incrementing the value of one parameter within a
                defined interval. The example below will increment the value of parameter a starting
                at 0.1 to 0.9, incrementing by 0.1 for each run</para>
            <screen>optimizeSingleParamLinear a:0.1:0.9:0.1</screen>
            <para>
                <emphasis role="bold">optimizeSingleParamByValues</emphasis>
            </para>
            <para>Multiple Simulation runs by iterating the value of one parameter according to
                defined list. The example below will iterate the value of parameter a through the
                following list: 0.2, 0.8, 0.9 and 1.2</para>
            <screen>optimizeSingleParamByValues a:0.2:0.8:0.9:1.2</screen>
            <para>
                <emphasis role="bold">optimizeSingleParam</emphasis>
            </para>
            <para>Multiple Simulation runs by setting the value of one parameter within the defined
                range and trying to find the maximum ShareRatio. The optimizer being used is
                    <classname>UnivariateRealOptimizer</classname>. The example below will set the
                value of parameter a between 0.1 and 1.0 (accuracy 0.01).</para>
            <screen>optimizeSingleParam a:0.1:1.0:0.01</screen>
            <para>
                <emphasis role="bold">optimizeMultiParamLinear</emphasis>
            </para>
            <para>Multiple Simulation runs by doing a matrix Optimization of 2 or 3 parameters by
                incrementing their values within a defined intervals. The example below will iterate
                through all possible combinations by incrementing the value of parameter a starting
                at 0.1 to 0.9 (increment: 0.1), and incrementing the value of parameter b starting
                at 10.0 to 100.0 (increment: 5.0)</para>
            <screen>optimizeMultiParamLinear a:0.1:0.9:0.1 b:10.0:100.0:5.0</screen>
            <para>
                <emphasis role="bold">optimizeMultiParam</emphasis>
            </para>
            <para>Multiple Simulation runs by adjusting the value of multiple parameters around their start
                values and trying to find the maximum ShareRatio. The example below will start the
                optimization by setting the value of parameter a to 85.0 and parameter b to
                150.0</para>
            <screen>optimizeMultiParam SMI a:85.0 b:150.0</screen>
            <para>In order to process parameters with the correct decimal scale the following VM
                argument has to be set:</para>
            <screen>-Dsimulation.roundDigits=4</screen>
        </section>
        <section id="Performance_Statistics">
            <title>Performance Statistics</title>
            <para>At the end of each simulation, performance statistics are displayed. When doing a
                single simulation run, the statistics will be displayed in the following detailed
                format:</para>
            <screen>execution time (min): 1.78dataSet: ux-1day-200801-201301netLiqValue=3'993'712.00
month-year:          Jan-08  Feb-08  Mrz-08  Apr-08  Mai-08  Jun-08  Jul-08  ...
monthlyPerformance:  -0.25%   0.56%   2.77%   3.22%   9.73%  -6.88%  -3.66%  ...
year:                  2008    2009    2010    2011    2012    2012
yearlyPerformance:   46.28%  20.40%  32.41%  30.83%  34.26%  -2.50%
posMonths=38 negMonths=23 avgY=31.31% stdY=18.85%  sharpRatio=1.65
maxMDrawDown=6.88% bestMPerf=21.72% maxDrawDown=13.05% colmar=2.4
WinTrds: cnt=1066(49.8%) avgPrft=13'872.31 avgPrftPct=6.65% avgAge=9.3
LoTrds: cnt=1073(50.1%) avgPrft=-11'158.63 avgPrftPct=-4.90% avgAge=8.9
AllTrds: cnt=2139 avgPrft=1'315.89 avgPrftPct=0.86% avgAge=9.14</screen>
            <para>When doing several simulations runs in a row, the statistics will be displayed in
                the following summary format showing the current parameter values as well as
                corresponding perforamnce statistics of one run on one single line:</para>
            <screen>a=90 avgY=39.86% stdY=20.16% sharpe=1.97 maxDDM=11.29% bestMP=8.35% ...
a=105 avgY=34.60% stdY=20.33% sharpe=1.69 maxDDM=11.56% bestMP=8.39% ... </screen>
            <para>In addition to above General Performance statistics, strategy specific performance
                statistics are printed to the console. These are retrieved by calling the method
                    <classname>StrategyService.getSimulationResults</classname> of the strategy.  </para>
            <para>After the simulation the database modifications (mainly transactions and
                positions) are kept in order to be able to perform further DB based analysis.
            </para>
            <para>The amount of output during the simulation can be adjusted by setting the Log Level
                according to <xref linkend="Logging"/>.</para>
        </section>
    </chapter>
    <chapter id="Performance_Measurement">
        <title>Performance Measurement</title>
        <para>AlgoTrader provides a sophisticated Performance Measurement functionality that
            consists of the following components:</para>
        <itemizedlist>
            <listitem>
                <para>PortfolioValue logging to the database in Live-Trading Mode</para>
            </listitem>
            <listitem>
                <para>PortfolioValue logging to a csv file in Simulation Mode</para>
            </listitem>
            <listitem>
                <para>PortfolioChart display in the client (see <xref linkend="Portfolio_Chart"/>)</para>
            </listitem>
            <listitem>
                <para>Performance statistics display at the end of a simulation run (see <xref linkend="Performance_Statistics"/>)</para>
            </listitem>
            <listitem>
                <para>PortfolioValue Restoration Feature</para>
            </listitem>
        </itemizedlist>
        <para>All Performance Measurement features depend mainly on the Entity
            PorfolioValue which has the following attributes</para>
        <itemizedlist>
            <listitem>
                <para>dateTime</para>
            </listitem>
            <listitem>
                <para>netLiqValue</para>
            </listitem>
            <listitem>
                <para>securitiesCurrentValue</para>
            </listitem>
            <listitem>
                <para>cashBalance</para>
            </listitem>
            <listitem>
                <para>maintenanceMargin</para>
            </listitem>
            <listitem>
                <para>leverage</para>
            </listitem>
            <listitem>
                <para>allocation</para>
            </listitem>
            <listitem>
                <para>cashFlow (optional)</para>
            </listitem>
        </itemizedlist>
        <section>
            <title>PortfolioValue Logging</title>
            <para>In Live-Trading Mode PortfolioValues are recorded to the database for all running
                strategies on an hourly basis. In addition PortfolioValues are recorded every time a
                transaction occurs that actually influences performance. For the Base these are
                Credits and Debits and for strategies, these are Rebalances. The corresponding value
                of the transaction is recorded in the optional attribute cashFlow of the
                PortfolioValue.</para>
            <para>In Simulation Mode PortfolioValues are recorded to the file portfolio.csv through
                the <classname>LogPortfolioValueSubscriber</classname> on a daily-basis. This file
                contains the following columns:</para>
            <itemizedlist>
                <listitem>
                    <para>dateTime</para>
                </listitem>
                <listitem>
                    <para>cashBalance</para>
                </listitem>
                <listitem>
                    <para>securitiesCurrentValue</para>
                </listitem>
                <listitem>
                    <para>maintenanceMargin</para>
                </listitem>
                <listitem>
                    <para>leverage</para>
                </listitem>
            </itemizedlist>
        </section>
        <section>
            <title>PortfolioValue Restoration Feature</title>
            <para>In case a transaction (that actually influences performance) needs to be recorded
                for a prior period in time, all PortfolioValues since that time period are invalid
                and need to be restored. Usage of this feature is quite common in Reconciliation
                where a CashTransaction has to be recorded for the last trading day as soon as the
                external reconciliation file arrives.</para>
            <para>Through the class <classname>RestorePortfolioValueStarter</classname> which uses
                    <classname>PortfolioPersistenceService.RestorePortfolioValues</classname>
                PortfolioValues can be restored for the specified strategy and time period. For the
                restoration of each PortfolioValue all corresponding transactions up to that time
                have to be evaluated. For that reason PortfolioValue Restoration takes a
                considerable amount of time.</para>
        </section>
    </chapter>
    <chapter id="Risk_Management">
        <title>Risk Management</title>
        <para>Using the provided functionality of the system, the following risk metrics can be
            enforced by the Base:</para>
        <itemizedlist>
            <listitem>
                <para>Maximum Margin of the Portfolio</para>
            </listitem>
            <listitem>
                <para>Fixed and/or Trailing Stop-Loss Limit for each Position</para>
            </listitem>
            <listitem>
                <para>Maximum Redemption Value / Cash-Balance</para>
            </listitem>
            <listitem>
                <para>Maximum Loss per Position</para>
            </listitem>
            <listitem>
                <para>Maximum Overnight Value-at-Risk (VaR or CVaR)</para>
            </listitem>
            <listitem>
                <para>Maximum Leverage of the Portfolio</para>
            </listitem>
            <listitem>
                <para>Maximum monthly Draw-Down (after this threshold has been reached, the
                        strategy is temporarily paused)</para>
            </listitem>
        </itemizedlist>
    </chapter>
    <chapter id="Forex_Handling">
        <title>Forex Handling</title>
        <para>The System provides full Forex Management. FX Rates can be retrieved in real-time. All
            portfolio figures are calculated based on up-to-date FX-Rates.</para>
        <section>
            <title>Currency Handling</title>
            <para>In most cases securities are attributed in their currency (as defined by
                SecurityFamily). Their market value is attributed towards Securities (e.g.
                SecuritiesCurrentValue).</para>
            <para>There are however the following exceptions.</para>
            <section>
                <title>Futures</title>
                <itemizedlist>
                    <listitem>
                        <para>Futures are fully margined, that's why buying a Future does not
                            actually influence cash but only the margin requirement.</para>
                    </listitem>
                    <listitem>
                        <para>IB displays Future Unrealized P/L under Cash.</para>
                    </listitem>
                    <listitem>
                        <para>AlgoTrader however treats Futures as regular Securities (i.e. add
                            MarketValue to Securities and deduct TransactionPrice from cash)</para>
                    </listitem>
                    <listitem>
                        <para>To compare AlgoTrader Balances to IB Balances (if there are Future
                            Positions), one has to compare the NetLiqValue and not Cash / Securities
                            individually</para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <title>Forex</title>
                <itemizedlist>
                    <listitem>
                        <para>Forex (e.g. EUR.USD) consists of the BaseCurrency (e.g. EUR) and
                            TransactionCurrency (e.g. USD)</para>
                    </listitem>
                    <listitem>
                        <para>In Balances Forex are attributed towards Cash (and not Securities) in
                            the BaseCurrency</para>
                    </listitem>
                    <listitem>
                        <para>The gross value of a transaction is booked in the TransactionCurrency, whereas the
                            commission is booked in the BaseCurrency. However </para>
                    </listitem>
                </itemizedlist>
                <note>
                    <para>The TWS Trades Window displays commissions in Trade Currency, but IB Flex Reports
                        displays commissions correctly in the BaseCurrency.</para>
                </note>
            </section>
            <section>
                <title>ForexFutures</title>
                <itemizedlist>
                    <listitem>
                        <para>Like Forex, ForexFutures (e.g. EUR.USD) consist of the BaseCurrency (e.g. EUR) and
                            TransactionCurrency(e.g. USD)</para>
                    </listitem>
                    <listitem>
                        <para>In Balances Forex are attributed towards Securities (and not Cash like
                            Forex) in the BaseCurrency</para>
                    </listitem>
                    <listitem>
                        <para>The entire transaction value (price + commission) is booked in the
                            TransactionCurrency</para>
                    </listitem>
                </itemizedlist>
                <note>
                    <para>IB treats ForexFutures like regular Futures and displays their
                        value under Cash in the TransactionCurrency. This way even if a
                        Non-Base-Currency Exposure is hedged, the NetLiqValue will be none
                        zero</para>
                </note>
            </section>
            <section>
                <title>Currency Attribution</title>
                <para>The following table describes Currency Attribution of Positions. The logic is
                    implemented by Position.getAttribution()</para>
                <table frame="all" pgwide="1">
                    <title>Position Currency Attribution</title>
                    <tgroup cols="4">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry/>
                                <entry>General Security</entry>
                                <entry>Forex</entry>
                                <entry>ForexFuture</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>attributed to</entry>
                                <entry>Securities</entry>
                                <entry>Cash</entry>
                                <entry>Securities</entry>
                            </row>
                            <row>
                                <entry>Currency</entry>
                                <entry>Currency of Security</entry>
                                <entry>Portfolio Currency</entry>
                                <entry>Portfolio Currency</entry>
                            </row>
                            <row>
                                <entry>Amount</entry>
                                <entry>quantity * contract size * price</entry>
                                <entry>quantity</entry>
                                <entry>quantity * contract size</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
                <para>The following table describes Currency Attribution of Transactions. The logic
                    is implemented by Transaction.getAttributions()</para>
                <table frame="all" pgwide="1">
                    <title>Transaction Currency Attribution</title>
                    <tgroup cols="3">
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry/>
                                <entry>General Security</entry>
                                <entry>Forex</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>Gross Value</entry>
                                <entry>Transaction Currency</entry>
                                <entry>Transaction Currency</entry>
                            </row>
                            <row>
                                <entry>Execution Commission</entry>
                                <entry>Transaction Currency</entry>
                                <entry>Portfolio Currency</entry>
                            </row>
                            <row>
                                <entry>Clearing Commission</entry>
                                <entry>Transaction Currency</entry>
                                <entry>Transaction Currency</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
        </section>
        <section>
            <title>Forex-Hedging</title>
            <para>In addition, automatic Forex-Hedging is provided by the Service
                    <classname>com.algoTrader.service.ForexService</classname>. This service will
                maintain multiple virtual FX Positions to hedge all non base currency balances. For
                actual Forex-Hedging the following two options exist</para>
            <section>
                <title>Virtual FX Positions (IB only)</title>
                <para>InteractiveBrokers offer virtual FX Positions, which are very convenient for Hedging
                    purposes. Depending on the current exposure, a corresponding virtual FX spot
                    position is maintained.</para>
            </section>
            <section>
                <title>FX Future</title>
                <para>The second option for FX Hedging is by means of FX Futures which is a subclass of
                    Future.</para>
                <para>In case of EUR.USD there are three FX FutureFamilies available with different contract
                    sizes of 12'500, 62'500 and 125'000 USD. Because of this the hedgingFamily has
                    to be defined as a Property on the EUR.USD subscription.</para>
                <para>Since FX Futures expire, the Hedging Position has to be rolled before Expiration, which is
                    also done automatically based on configured parameters.</para>
            </section>
        </section>
    </chapter>
    <chapter id="Options_Futures">
        <title>Options &amp; Futures</title>
        <section>
            <title>Expiration</title>
            <para>Both Options and Futures implement the interface <classname>ExpirableI</classname> which
                has a property <parameter>expiration</parameter> that represents the expiration
                date. </para>
            <para>If a strategy wishes to hold Options or Futures up to the expiration date, the statement
                    <literal>EXPIRE_POSITION</literal> has to be enabled by the following vm
                argument:</para>
            <screen>-Dstatement.expirePosition=true</screen>
            <para>Once the current date advances past the expiration date of a Option or Future, a
                corresponding <literal>EXPIRATION</literal> Transaction will be created in the
                database which will take into account the current intrinsic value of the
                position.</para>
        </section>
        <section>
            <title>Margining </title>
            <para>Both Options and Futures are fully margined securities. The actual margin required by a
                broker will vary, however they normally mirror the margin requirements defined by
                the corresponding market. </para>
            <para>For strategies that run a high leverage, it might be necessary to simulate margins. The
                system therefore provides the method <methodname>getMargin</methodname> for both
                Futures and Options. For Option margins the calculation is based on the Eurex Risk
                based Margining. To have the system set the margin internally, the statement
                    <literal>SET_MARGINS</literal> has to be enabled by the following vm
                argument:</para>
            <screen>-Dstatement.setMargins=true</screen>
        </section>
        <section>
            <title>Leverage &amp; Exposure</title>
            <para>AlgoTrader uses the following definitions for Leverage &amp; Exposure:</para>
            <figure>
                <title>Leverage &amp; Exposure</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/Leverage.gif" scale="" scalefit="1"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <variablelist>
                <varlistentry>
                    <term>CS</term>
                    <listitem>
                        <para>Contract Size</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>CV</term>
                    <listitem>
                        <para>Current Value</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>S</term>
                    <listitem>
                        <para>Underlying Spot price</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>D</term>
                    <listitem>
                        <para>Delta</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>Q</term>
                    <listitem>
                        <para>Quantity</para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <note>
                <para> AlgoTrader uses the Delta-adjusted Option Leverage as Option Leverage.
                </para>
            </note>
        </section>
        <section>
            <title>Symbol, ISIN &amp; RIC</title>
            <para>The two classes <classname>FutureSymbol</classname> and
                    <classname>StockOptionSymbole</classname> provide static methods for generating
                the Symbol, ISIN and RIC for Futures and Options. Both Symbol and ISIN use the
                property <parameter>baseSymbol</parameter> of the
                    <classname>SecurityFamly</classname>. The RIC on the other side uses the
                property <parameter>ricRoot</parameter>.</para>
        </section>
        <section>
            <title>Option &amp; Future Chain Download</title>
            <para>Any strategy that uses Options and/or Futures in Live-Trading mode, needs to have the
                currently traded Options and/or Futures available in the database. </para>
            <para>For this purpose the <classname>SecurityRetrieverService</classname> provides a
                the method <methodname>retrieve</methodname> which takes a
                    <parameter>securityFamilyId</parameter> parameter. To download missing Options
                and/or Futures use the following command:</para>
            <screen>SecurityRetrievalStarter securityFamilyId1 securityFamilyId2 ...</screen>
            <para>It is recommended to run this Service in the interval of Option / Future
                Expirations to make sure that the entire chain is available to strategies.</para>
        </section>
        <section>
            <title>Options &amp; Futures Price Simulation</title>
            <para>In Live-Trading Mode current Option and/or Future chains can be downloaded using the
                    <classname>SecurityRetrieverService</classname>. In simulation Mode this is
                unfortunately not possible. </para>
            <para>For this purpose the <classname>StockOptionService</classname> contains the method
                    <methodname>createDummyStockOption</methodname> which will create an Option
                nearest to the specified <parameter>targetExpirationDate</parameter> (based on
                    <parameter>StockOptionFamily.expirationType</parameter>) and
                    <parameter>targetStrike</parameter> (based on
                    <parameter>StockOptionFamily.strikeDistance</parameter>). </para>
            <para>In addition the <classname>FutureService</classname> contains a method
                    <methodname>createDummyFutures</methodname> which will create the missing
                portion of a Future chain in simulation.</para>
            <para>Both methods <methodname>createDummyStockOption</methodname> and
                    <methodname>createDummyFutures</methodname> will be invoked by the
                    <classname>LookupService</classname> in simulations if a matching Option or
                Future cannot be found in the database (if
                    <parameter>simulateStockOptions</parameter> is enabled). </para>
            <para>With above steps required Options and/or Futures will now be available in the
                database during simulation. To produce simulated market data for the Option and/or
                Future several methods exist, all of which are provided by the Esper Module
                    <filename>module-market-data-simulation.epl</filename> which can be enabled via
                the following VM-arguments:</para>
            <variablelist>
                <varlistentry>
                    <term>-Dstatement.simulateStockOptions=true</term>
                    <listitem>
                        <para>Enables simulation of stockOption prices through market data of the
                            underlying and the corresponding volatility</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dstatement.loadStockOptionsFromDB=true</term>
                    <listitem>
                        <para>Enables retrieval of stockOption prices from the database</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dstatement.simulateFuturesByUnderlying=true</term>
                    <listitem>
                        <para>Enables simulation of future prices by the underlying and the
                            corresponding time-to-expiration</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>-Dstatement.simulateFuturesByGenericFutures=true</term>
                    <listitem>
                        <para>Enables retrieval of future prices from market data of their
                            corresponding generic futures</para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
        <section>
            <title>Option Greeks</title>
            <para>The following Option Greeks are available through the Class
                    <classname>StockOptionUtil</classname>:</para>
            <itemizedlist>
                <listitem>
                    <para>option price (through Black-and-Schooles)</para>
                </listitem>
                <listitem>
                    <para>implied volatility (through Black-and-Schooles, Newton Rapson Method and
                        SABR Surface) </para>
                </listitem>
                <listitem>
                    <para>intrinsic value</para>
                </listitem>
                <listitem>
                    <para>delta</para>
                </listitem>
                <listitem>
                    <para>vega</para>
                </listitem>
                <listitem>
                    <para>theta</para>
                </listitem>
                <listitem>
                    <para>forward price</para>
                </listitem>
                <listitem>
                    <para>moneyness</para>
                </listitem>
                <listitem>
                    <para>strike by delta</para>
                </listitem>
            </itemizedlist>
        </section>
        <section id="Option_Pricing_Engine">
            <title>Option Pricing Engine</title>
            <para>The system provides a sophisticated option pricing engine which is developed
                around the SABR volatility Model.</para>
            <para>Based on historical Volatility at different Moneyness levels (e.g. ATM, ATM +10%,
                ATM +20%, ATM -10% &amp; ATM-20%) or Delta levels (e.g. 50%, 35%, 75%) volatility
                parameters are calculated (=calibration) and used for option pricing.</para>
            <section>
                <title>SABR Calibration</title>
                <para>The <classname>StockOptionService</classname> is responsible for SABR
                    calibration. The calibration process happens for one specific expiration and
                    takes an array of strikes with their corresponding array of volatilities. the
                    calibration process returns a <classname>SABRSmile</classname>
                    <classname>ValueObject</classname>, which basically contains the three
                    parameters <parameter>rho</parameter>, <parameter>volVol</parameter> and
                        <parameter>alpha</parameter> (in addition to the time-to-expiration and
                    at-the-money volatility). The actual calibration happens through the class
                        <classname>SABR</classname>.</para>
                <para>SABR Calibration can be done either by actual Option Prices or directly by the
                    Implied Volatility. Also there are methods to do a SABR Calibration just for one
                    expiration (returning one SABRSmile ValueObject) or for an entire Volatility
                    Surface (returning a <classname>SABRSurface</classname>
                    <classname>ValueObject</classname> which consist of multiple
                        <classname>SABRSmile</classname>
                    <classname>ValueObjects</classname>)</para>
                <para>The SABR Calibration depends on different ImpliedVolatilties (a subclass of
                    Security) being defined in the database. A ImpliedVolatility needs to define
                    either a moneyness or a delta (in addition to Duration and OptionType).</para>
            </section>
            <section>
                <title>Option Pricing</title>
                <para>Based on the SABR Calibration the actual option pricing takes place. This is
                    handled through the class <classname>StockOptionUtil</classname> with the method
                        <methodname>getImpliedVolatilitySABR</methodname>. This method takes
                    SABRSurface parameter. The actual option pricing happens in two steps:</para>
                <orderedlist numeration="arabic">
                    <listitem>
                        <para>For all available expirations a volatility is calculated for the
                            requested strike </para>
                    </listitem>
                    <listitem>
                        <para>Using spline interpolation the volatility for the requested expiration
                            is calculated</para>
                    </listitem>
                </orderedlist>
            </section>
            <section>
                <title>References</title>
                <itemizedlist>
                    <listitem>
                        <para>
                            <ulink
                                url="http://www.lesniewski.us/papers/published/HedgingUnderSABRModel.pdf"
                                > Hedging under SABR Model, Refined risk management under the SABR
                                model.</ulink>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <ulink url="http://www.riskworx.com/insights/sabr/sabr.html"> A summary
                                of the approaches to the SABR model for equity derivative
                                smiles</ulink>
                        </para>
                    </listitem>
                </itemizedlist>
            </section>
        </section>
        <section>
            <title>OTC Options</title>
            <para>Since OTC Options do not have a predefined chain definition, the
                    <classname>StockOptionService</classname> contains a  method
                    <methodname>createOTCStockOption</methodname> to create an OTC option based on
                the specified <parameter>expirationDate</parameter>, <parameter>strike</parameter>
                and <parameter>type</parameter>.</para>
        </section>
        <section>
            <title>iVolatility.com Download &amp; Import</title>
            <para>The online service <ulink url="http://www.iVolatility.com">iVolatility.com</ulink> provides
                historical option data for download. There are two classes involved in downloading
                option market data from iVolatility.com:</para>
            <variablelist>
                <varlistentry>
                    <term>IVolatilityDownloader</term>
                    <listitem>
                        <para>Since iVolatility.com has a file size limit of 5MB, this utility class
                            allows downloading of market data files in batches.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>ImportService</term>
                    <listitem>
                        <para>Provides the method <methodname>importIVolTicks</methodname> to import
                            iVolatility files into the database.</para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
    </chapter>
    <chapter id="Reconciliation">
        <title>Reconciliation</title>
        <section>
            <title>Partner Systems</title>
            <para>Reconciliation is the automated process for comparing the status of the system
                with external partner systems (e.g. executed trades, current positions, cash
                transactions).</para>
            <para>Currently Reconciliation is available for the following partners:</para>
            <table frame="all" pgwide="1">
                <title>Reconciliation</title>
                <tgroup cols="5">
                    <colspec colwidth="3*"/>
                    <colspec colwidth="1*"/>
                    <colspec colwidth="1*"/>
                    <colspec colwidth="1*"/>
                    <colspec colwidth="2*"/>
                    <thead>
                        <row>
                            <entry>Partner</entry>
                            <entry>Trades</entry>
                            <entry>Positions</entry>
                            <entry>Cash Transactions</entry>
                            <entry>File Format</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>InteractiveBrokers</entry>
                            <entry>x</entry>
                            <entry>x</entry>
                            <entry>x</entry>
                            <entry>xml</entry>
                        </row>
                        <row>
                            <entry>RBS</entry>
                            <entry>x</entry>
                            <entry>x</entry>
                            <entry/>
                            <entry>csv</entry>
                        </row>
                        <row>
                            <entry>Universal Invest</entry>
                            <entry/>
                            <entry>x</entry>
                            <entry>x</entry>
                            <entry>proprietary</entry>
                        </row>
                        <row>
                            <entry>JP Morgan</entry>
                            <entry>x</entry>
                            <entry/>
                            <entry/>
                            <entry>csv</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
            <para>Reconciliation is based on files received via email. For every partner a sub class
                of <classname>ReconciliationService</classname> has to be created. This class has to
                contain at least the method <methodname>reconcile()</methodname> which gets the
                fileName of the file received and the actual content of the file as a byte array.
                Depending on the file format used by the partner different mechanisms for parsing
                the files are available:</para>
            <itemizedlist>
                <listitem>
                    <para>xml: <ulink url="http://xml.apache.org/xalan-j/">Xalan</ulink> (using
                        XPath )</para>
                </listitem>
                <listitem>
                    <para>csv: <ulink url="http://supercsv.sourceforge.net/">SuperCSV</ulink>
                    </para>
                </listitem>
            </itemizedlist>
        </section>
        <section>
            <title>File Handling</title>
            <para>The actual process of receiving files via email, storing them in a directory and
                passing them along to the <classname>ReconcilicationServices</classname> is
                implemented through <ulink url="http://www.springsource.org/spring-integration">Spring Integration</ulink>. The entire process is configured inside the file
                    <filename>applicationContext-server.xml</filename> (section MAIL) and consists
                of the following components:</para>
            <itemizedlist>
                <listitem>
                    <para>
                        <classname>ImapIdleChannelAdapter</classname>: receives email messages in an
                        asynchronous fashion via IMAP Idle and sends them to the
                            <classname>InputChannel</classname>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <classname>Disposition</classname>: a Set of Rules (email-from,
                        email-subject) and their corresponding
                            <classname>ReconciliationService</classname> and directory (where the
                        files should be stored)</para>
                </listitem>
                <listitem>
                    <para>
                        <classname>InputChannel</classname>: a <classname>DirectChannel</classname>
                        for received email messages</para>
                </listitem>
                <listitem>
                    <para>
                        <classname>InputChain</classname>: a <classname>HandlerChain</classname>
                        invoking the following components sequentially and sending the final
                        messages to the OutputChannel</para>
                    <itemizedlist>
                        <listitem>
                            <para>
                                <classname>EmailDispatcher</classname>: adds directory and
                                    reconciliationService header based on defined Dispositions
                                </para>
                        </listitem>
                        <listitem>
                            <para>
                                <classname>Filter</classname>: will only process email messages
                                    that contain above assigned directory header</para>
                        </listitem>
                        <listitem>
                            <para>
                                <classname>EmailTransfomer</classname>: Parses the email message
                                    and converts contained attachment into a List of
                                        <classname>EmailFragments</classname>
                            </para>
                        </listitem>
                        <listitem>
                            <para>
                                <classname>EmailSplitter</classname>: Splits messages with List
                                    of <classname>EmailFragments</classname> into individual
                                        <classname>EmailFragment</classname> messages</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>
                        <classname>OutputChannel</classname>: a
                            <classname>PublishSubscribeChannel</classname> for
                            <classname>EmailFragment</classname> messages</para>
                </listitem>
                <listitem>
                    <para>
                        <classname>FileOutputChannelAdapter</classname>: saves the actual file
                        content of <classname>EmailFragments</classname> into the assigned
                        directory</para>
                </listitem>
                <listitem>
                    <para>
                        <classname>ServiceActivator</classname>: invokes the assigned
                            <classname>ReconcilationService</classname> with the actual file
                        content</para>
                </listitem>
            </itemizedlist>
        </section>
    </chapter>
    <chapter id="Broker_Interfaces">
        <title>Broker Interfaces</title>
        <para>The System provides generic interface functions to connect AlgoTrader to different
            broker systems.</para>
        <para>The following broker specific interfaces are currently available:</para>
        <itemizedlist>
            <listitem>
                <para>InteractiveBrokers via Native &amp; Fix API</para>
            </listitem>
            <listitem>
                <para>InteractiveBrokers via Fix</para>
            </listitem>
            <listitem>
                <para>JP Morgan via Fix</para>
            </listitem>
            <listitem>
                <para>DukasCopy via Fix</para>
            </listitem>
        </itemizedlist>
        <para>AlgoTrader uses <ulink url="http://www.quickfixj.org/"> QuickFix/J</ulink> for all fix
            interfaces.</para>
        <para>The generic broker interface consists of the two abstract services
            ExternalOrderService and MarketDataService. Every broker specific implementation has to
            subclass these services e.g. IBNativeOrderService or FixOrderService (with corresponding
            subclasses like Fix42OrderService or IBFixOrderService).</para>
        <section>
            <title>Orders &amp; Fills</title>
            <para>The UML Activity Diagram on the right explains a typical order/execution
                process.</para>
            <figure>
                <title>Order Execution Process</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/OrderExecutionProcess.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>The diagram below shows all currently implemented Order Services:</para>
            <figure>
                <title>Order Services</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/OrderServices.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <section>
                <title>Place Order</title>
                <para>Before sending an Order, it is advised to call the
                        <methodname>validate</methodname> method on the order. This will validate
                    the order regarding limits, amount, quantity, etc. In case validation fails, the
                    order can be modified. Note: the validate method will be called (again) inside
                    the sendOrder method, in case the validation fails, this time an Exception will
                    be thrown.</para>
                <para>The method <methodname>sendOrder</methodname> of the <classname>OrderService</classname>
                    is responsible for placing Orders. This method takes an
                        <classname>Order</classname> object as parameter. If the second parameter
                    named <parameter>suggest</parameter> is set to true, there will not be an actual
                    Order going to the Broker but instead an Email with a Order Suggestion is sent
                    to the registered Email addresses. This allows for manual confirmation of
                    automatically generated Signals.</para>
                <para>The <methodname>sendOrder</methodname> method is responsible for invoking the
                    broker specific method <methodname>sendOrder</methodname> of the
                        <classname>ExternalOrderService</classname>. The method
                        <methodname>sendOrder</methodname> is contained within the generic
                        <classname>ExternalOrderService</classname>, where it is marked abstract, so
                    it will have to be implemented by every broker specific subclass.</para>
                <para>The broker specific <classname>ExternalOrderService</classname> will assign an
                        <parameter>intId</parameter> (i.e. <parameter>orderNumber</parameter>),
                    create and place the broker specific Order.</para>
                <para>After sending the Order to the broker, the order object is propagated (by the
                        <classname>EsperManager</classname>) to the BASE Esper service instance
                    (running inside the Base) as well as to the Esper service instance of the
                    corresponding strategy (where potential actions like <emphasis>cancel
                        order</emphasis> or <emphasis>modify order</emphasis> can be
                    executed).</para>
                <para>In addition Open Orders are stored in the
                        <classname>OpenOrderWindow</classname> until their full execution or
                    cancellation.</para>
            </section>
            <section>
                <title>Receive Fills</title>
                <para>Whenever order status events and fills are received back from the broker,
                        <classname>OrderStatus</classname> and <classname>Fill</classname> objects /
                    events are created and propagated to the BASE Esper service Instance.</para>
                <para>The Fill events trigger the <methodname>createTransaction</methodname> method
                    of the <classname>TransactionService</classname> which will create a
                        <classname>Transaction</classname> object (a persistent Record in the
                    database) based on the Fill. In addition the Fill and corresponding Transactions
                    are also propagated to the strategy, where actions can be taken upon.</para>
                <note>
                    <para>Fills and Transactions are separated from each other for the following
                        reason. A Fill contains all the information received from the broker (and a
                        reference to the Order). Whereas a Transaction contains all the information
                        related to accounting (i.e. references to position and strategy). In
                        addition to Transactions related to Fills, there are Transactions that are
                        independent of Fills (i.e. Deposits, Withdrawls, Intrest, etc.).</para>
                </note>
                <para>Like Fills and Transactions the generic <classname>OrderStatus</classname>
                    will also be propagated to the corresponding strategy.</para>
                <para>The statement LOG_TRANSACTION_SUMMARY of the <filename>module-trades.epl</filename> is
                    responsible for collecting all OrderStatus events for an order and produce one
                    combined log statement.</para>
                <para>The <classname>OpenOrderWindow</classname> is updated based on every
                    OrderStatus event (e.g. increase filledQuantity &amp; reduce remainingQuantity).
                    Once the Order is fully executed, it will be removed from the
                        <classname>OpenOrderWindow</classname> (after a delay of 1 sec).</para>
                <para>If an order does not receive either an Acknowledgment or Fill 1 sec after
                    sending the Order, an Exception is thrown, as there might be a problem with the
                    broker connection.</para>
            </section>
            <section>
                <title>Fix Interface</title>
                <para>AlgoTrader uses <ulink url="http://www.quickfixj.org/"> QuickFix/J</ulink> for it's Fix
                    connections and currently supports FIX 4.2 and 4.4. Because FIX messages are not
                    compatible between different version, the two distinct services
                        <classname>Fix42OrderService</classname> and
                        <classname>Fix44OrderService</classname> exist. Incoming messages are
                    handled by their corresponding <classname>Fix42MessageHandler</classname> and
                    Fix44MessageHandler, which are responsible for creating OrderStatus and Fill
                    events.</para>
                <para>The Fix infrastructure consists of the following classes:</para>
                <table frame="all" pgwide="1">
                    <title>Fix Infrastructure</title>
                    <tgroup cols="2">
                        <colspec colwidth="1.2*"/>
                        <colspec colwidth="2*"/>
                        <thead>
                            <row>
                                <entry>Class</entry>
                                <entry>Description</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>
                                    <classname>FixClient</classname>
                                </entry>
                                <entry>the main entry point into the Fix environment. It is
                                    responsible for starting up the QuickFix/J engine, creating
                                    dynamic sessions, sending Messages and managing
                                    OrderIds.</entry>
                            </row>
                            <row>
                                <entry>
                                    <classname>FixApplication</classname>
                                </entry>
                                <entry>for each session a <classname>FixApplication</classname>
                                    object is created. It will forward incoming messages to the
                                    corresponding <classname>MessageHandler</classname>
                                </entry>
                            </row>
                            <row>
                                <entry>
                                    <classname>FixApplicationFactory</classname>
                                </entry>
                                <entry>custom <classname>FixApplicationFactory</classname> needed to
                                    create one <classname>FixApplication</classname> per
                                    session</entry>
                            </row>
                            <row>
                                <entry>
                                    <classname>FixMultiApplicationSessionFactory</classname>
                                </entry>
                                <entry>custom <classname>SessionFactory</classname> needed to
                                    created one <classname>FixApplication</classname> per
                                    session</entry>
                            </row>
                            <row>
                                <entry>
                                    <classname>FixCodeGenerator</classname>
                                </entry>
                                <entry>Used to generate Custom Fix Messages and Fields based on XML
                                    QuickFix/J definition files.</entry>
                            </row>
                            <row>
                                <entry>
                                    <classname>FixUtil</classname>
                                </entry>
                                <entry>Contains utility methods for parsing incoming Fix messages
                                    (e.g. getStatus)</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
                <note>
                    <para>QuickFix/J currently supports daily sessions (with a daily session 7 times
                        a week) and weekly sessions (with one weekly session). However some brokers
                        (e.g. JP Morgan) use daily sessions but only during workdays. To accomplish
                        this scenario, the FixClient allows creation of a weekly logon/logoff event
                        (e.g. Mo 08:00:00 and Fr 18:00:00) using two Esper Statements per Fix
                        Session</para>
                </note>
            </section>
            <section>
                <title>OrderId Format</title>
                <para>The Order Entity is marked as <emphasis>transient</emphasis>, therefore its
                    local id property is always 0. However the order has two additional properties
                    intId and extId. intId is the internally (by the Base) assigned OrderId whereas
                    extId is the externally (by the broker) assigned OrderId.</para>
                <para>In general the intId has the following format:</para>
                <literallayout>&lt;session_qualifier&gt;&lt;id&gt;.&lt;version&gt;</literallayout>
                <itemizedlist>
                    <listitem>
                        <para>session_qualifier: each session (i.e. FIX session) has a unique
                            session qualifier</para>
                    </listitem>
                    <listitem>
                        <para>id: an integer which is auto-incremented per session. For Fix, the
                            last id is retrieved from the Fix-Log during start up</para>
                    </listitem>
                    <listitem>
                        <para>version: The number of modifications that took place on the Order,
                            starting with 0 when the order is first submitted.</para>
                    </listitem>
                </itemizedlist>
            </section>
        </section>
        <section>
            <title>Broker specific implementations</title>
            <section>
                <title>IB Native Interface</title>
                <para>The native IB Interface connects to the local TWS or IB Gateway instance and
                    uses methods supplied by the IB client. The interface is fully capable of
                    handling IB's Financial Advisor functionality like Sub Accounts, Account Groups
                    and Allocation Profiles.</para>
                <para>Currently the IB interface is the only option for receiving incoming Market
                    Data.</para>
            </section>
            <section>
                <title>IB Fix Interface</title>
                <para>The IB Fix Interface provides the same Order Management features as the IB
                    Native Interface. However Market Data is not available through this
                    interface.</para>
                <para>The interface is fully capable of handling IB's Financial Advisor
                    functionality like Sub Accounts, Account Groups and Allocation Profiles.</para>
            </section>
            <section>
                <title>JP Morgan Fix Interface</title>
                <para>As the JP Morgan Fix Implementation is well conforming with the Fix Standard no
                    customizations had to be made</para>
            </section>
            <section>
                <title>DukasCopy Fix Interface</title>
                <para>The DukasCopy Fix Implementation does not follow the Fix Standard very well,
                    so quite a few customizations had to be made including a fully independent
                        <classname>MessageHandler</classname> (not subclassing any of the existing
                        <classname>FixMessageHandler</classname> classes)</para>
                <itemizedlist>
                    <listitem>
                        <para>usage of StopLimit for Limit orders</para>
                    </listitem>
                    <listitem>
                        <para>usage of Price for Stop orders instead of StopPx</para>
                    </listitem>
                    <listitem>
                        <para>does not support Securitytype</para>
                    </listitem>
                    <listitem>
                        <para>does not use ExecType instead it uses only OrdStatus</para>
                    </listitem>
                    <listitem>
                        <para>requires OrderID (tag 37) for order modifications</para>
                    </listitem>
                    <listitem>
                        <para>does not return OrigClOrdID</para>
                    </listitem>
                    <listitem>
                        <para>does not use OrderStatus PARTIALLY_FILLED</para>
                    </listitem>
                    <listitem>
                        <para>does not use LastPx but only AvgPx</para>
                    </listitem>
                </itemizedlist>
            </section>
        </section>
    </chapter>
    <chapter id="Market_Data">
        <title>Market Data</title>
        <para>Market Data exists in three different types:</para>
        <itemizedlist>
            <listitem>
                <para>Bars (Open-High-Low-Close Price Bars, also containing adjusted close and
                        volumes)</para>
            </listitem>
            <listitem>
                <para>Ticks (Snapshot of the market at a particular point in time, containing
                        information like last price, last time, bid, ask, volume, etc.)</para>
            </listitem>
            <listitem>
                <para>PriceEvent (with its subclasses Trade, Quote, Bid and Ask representing a
                        single atomic event in the market)</para>
            </listitem>
        </itemizedlist>
        <para>As the following diagram shows, Broker Interfaces can provide Price Events (Bid, Ask
            &amp; Trade) or Ticks. In Simulation Ticks or Bars can be provided through
            CSV-Files.</para>
        <figure>
            <title>Market Data Event Types</title>
            <mediaobject>
                <imageobject>
                    <imagedata fileref="images/MarketDataEvents.gif"/>
                </imageobject>
            </mediaobject>
        </figure>
        <para>Processing of MarketData is handled through the
                <classname>MarketDataService</classname>, which is marked abstract and will have to
            be subclassed by broker specific implementations (i.e.
                <classname>IBMarketDataService</classname>).</para>
        <para>The most important methods provided by the <classname>MarketDataService</classname>
            are <methodname>subscribe</methodname> and <methodname>unsubscribe</methodname>. Through
            the use of these methods new MarketData can be subscribed and unsubscribed. Subscribed
            securities are persisted within the DB-table <parameter>subscription</parameter>. The
            actual subscription of securities to the external broker is done through the broker
            specific MarketDataService.</para>
        <para>Broker Interfaces are responsible for receiving Broker specific Market Data and
            sending them into the Esper Service Instance Base. The Esper Service Instance Base will
            then convert these Events into generic MarketDataEvents (i.e. Ticks or Bars) which will
            be propagated to subscribed Strategies.</para>
        <figure>
            <title>Market Data Propagation</title>
            <mediaobject>
                <imageobject>
                    <imagedata fileref="images/MarketDataPropagation.gif"/>
                </imageobject>
            </mediaobject>
        </figure>
        <section id="Creation_of_Bars_based_on_Ticks">
            <title>Creation of Bars based on Ticks</title>
            <para>In both Simulation and Live Trading, Bars can be generated from Ticks or Price
                Events through the use of Esper Statements: use the time_batch to create
                bars:</para>
            <programlisting>select
  first(currentValueDouble) as open,
  max(currentValueDouble) as high,
  min(currentValueDouble) as low,
  last(currentValueDouble) as close
from
  Tick.win:time_batch(1 min)
group by
  security.id;</programlisting>
            <para>and expr_batch for constant volume bars:</para>
            <programlisting>select
  max(currentValueDouble) as high,
  min(currentValueDouble) as low,
  first(currentValueDouble) as open,
  last(currentValueDouble) as close
from
  Tick.win:expr_batch(sum(volume) > 1000)
group by
  security.id;</programlisting>
            <para>In addition there is a custom view (see <xref linkend="OHLCView"/>) that can be used to
                create Bars from Ticks with an explicit definition of a cutoff time:</para>
            <programlisting>select
  open,
  high,
  low,
  close
from
  Tick.custom:ohlcbar(currentValueDouble, 1 days, 0L);</programlisting>
        </section>
        <section id="Market_Data_File_Format">
            <title>Market Data File Format</title>
            <para>All market data files are placed inside the following directory structure:</para>
            <literallayout>/&lt;baseDir&gt;/&lt;eventType&gt;/&lt;dataSet&gt;/&lt;filename&gt;.csv</literallayout>
            <itemizedlist>
                <listitem>
                    <para>
                        <parameter>baseDir</parameter> is the parent directory where all market data
                        files are stored. This is either the <filename>files/</filename> directory
                        under <filename>algotrader/core</filename> or an arbitrary directory defined
                        via the VM argument:</para>
                    <screen>-DdataSource.dataSetLocation</screen>
                </listitem>
                <listitem>
                    <para>
                        <parameter>eventType</parameter> is either <parameter>tickData</parameter>,
                            <parameter>barData</parameter> or <parameter>genericData</parameter>
                        (see <xref linkend="Generic_Events"/>). </para>
                </listitem>
                <listitem>
                    <para>
                        <parameter>dataSet</parameter> is the name of the dataset used for the
                        simulation run. This can be defined via the VM argument:</para>
                    <screen>-DdataSource.dataSet</screen>
                </listitem>
                <listitem>
                    <para>
                        <parameter>filename</parameter> has to be according to the defined isin in
                        the table security: <filename>CH0008616382.csv</filename>. <emphasis>'Note:
                            the filename for <xref linkend="Generic_Events"/> follows a different
                            logic</emphasis>
                    </para>
                </listitem>
            </itemizedlist>
            <para>The first line within the file is the header row.</para>
            <para>If externally provided Tickdata uses other time formats (i.e. DDMMYYY-hhmmss),
                these should be converted to milliseconds before using with AlgoTrader.</para>
            <section>
                <title>Tick Data Files</title>
                <para>The Format of the Tick Data Files is based on a standard CSV Structure:</para>
                <itemizedlist>
                    <listitem>
                        <para>dateTime</para>
                    </listitem>
                    <listitem>
                        <para>last</para>
                    </listitem>
                    <listitem>
                        <para>lastDateTime</para>
                    </listitem>
                    <listitem>
                        <para>volBid</para>
                    </listitem>
                    <listitem>
                        <para>volAsk</para>
                    </listitem>
                    <listitem>
                        <para>bid</para>
                    </listitem>
                    <listitem>
                        <para>ask</para>
                    </listitem>
                    <listitem>
                        <para>vol</para>
                    </listitem>
                    <listitem>
                        <para>openIntrest</para>
                    </listitem>
                    <listitem>
                        <para>settlement</para>
                    </listitem>
                </itemizedlist>
                <para>DateTime and LastDateTime are of type long and represent milliseconds since
                    1970.</para>
                <para>Example:</para>
                <table frame="all" pgwide="1">
                    <title>Tick Data Format</title>
                    <tgroup cols="10">
                        <colspec colwidth="2*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="2*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1.5*"/>
                        <colspec colwidth="1.5*"/>
                        <thead>
                            <row>
                                <entry>dateTime</entry>
                                <entry>last</entry>
                                <entry>lastDateTime</entry>
                                <entry>volBid</entry>
                                <entry>volAsk</entry>
                                <entry>bid</entry>
                                <entry>ask</entry>
                                <entry>vol</entry>
                                <entry>openIntrest</entry>
                                <entry>settlement</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>1299493621002</entry>
                                <entry>188</entry>
                                <entry>1299491709000</entry>
                                <entry>47</entry>
                                <entry>52</entry>
                                <entry>178.1</entry>
                                <entry>183.2</entry>
                                <entry>20</entry>
                                <entry>868</entry>
                                <entry>187</entry>
                            </row>
                            <row>
                                <entry>1299493680524</entry>
                                <entry>188</entry>
                                <entry>1299491709000</entry>
                                <entry>47</entry>
                                <entry>52</entry>
                                <entry>177.2</entry>
                                <entry>182.9</entry>
                                <entry>20</entry>
                                <entry>868</entry>
                                <entry>187</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section>
                <title>Bar Data Files</title>
                <para>The Format of the Bar Data Files is based on a standard CSV Structure:</para>
                <itemizedlist>
                    <listitem>
                        <para>dateTime</para>
                    </listitem>
                    <listitem>
                        <para>open</para>
                    </listitem>
                    <listitem>
                        <para>high</para>
                    </listitem>
                    <listitem>
                        <para>low</para>
                    </listitem>
                    <listitem>
                        <para>close</para>
                    </listitem>
                    <listitem>
                        <para>vol</para>
                    </listitem>
                    <listitem>
                        <para>openIntrest</para>
                    </listitem>
                    <listitem>
                        <para>settlement</para>
                    </listitem>
                </itemizedlist>
                <para>DateTime is of type long and represent milliseconds since 1970.</para>
                <para>Example:</para>
                <table frame="all" pgwide="1">
                    <title>Bar Data Format</title>
                    <tgroup cols="8">
                        <colspec colwidth="2*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1*"/>
                        <colspec colwidth="1.5*"/>
                        <colspec colwidth="1.5*"/>
                        <thead>
                            <row>
                                <entry>dateTime</entry>
                                <entry>open</entry>
                                <entry>high</entry>
                                <entry>low</entry>
                                <entry>close</entry>
                                <entry>vol</entry>
                                <entry>openIntrest</entry>
                                <entry>settlement</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>1299493621002</entry>
                                <entry>1.29366</entry>
                                <entry>1.29369</entry>
                                <entry>1.29360</entry>
                                <entry>1.29369</entry>
                                <entry>2000</entry>
                                <entry>12000</entry>
                                <entry>1.29360</entry>
                            </row>
                            <row>
                                <entry>1299493680524</entry>
                                <entry>1.29367</entry>
                                <entry>1.29389</entry>
                                <entry>1.29367</entry>
                                <entry>1.29378</entry>
                                <entry>2500</entry>
                                <entry>12500</entry>
                                <entry>1.29378</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
        </section>
        <section id="Generic_Events">
            <title>Generic Events</title>
            <para>In addition to MarketDataEvents (i.e. Ticks and Bars) there are general purpose
                Generic Events that can contain any type of information (e.g. virtual market data,
                signals, exposure values, etc.). In contrary to MarketDataEvents, which are sent
                from the Base to the subscribed strategies, these Generic Events are sent from one
                strategy to one or more receiving strategies. A Generic Event class has to subclass
                    <classname>GenericEventVO</classname>. Subscription to Generic Events is based
                on the class of the Generic Event.</para>
            <para>Example: To subscribe to a Generic Event of type Signal (which is a subclass of
                    <classname>GenericEventVO</classname>), the following needs to be done:</para>
            <programlisting language="Java">Class&lt;?&gt;[] genericEvents = new Class[] { Signal.class };
subscriptionService.subscribeGenericEvents(genericEvents);</programlisting>
            <para>To send a GenericEvent, use the following method:</para>
            <programlisting language="Java">EsperManager.sendGenericEvent(signal);</programlisting>
            <para>It is also possible to feed Generic Events via CSV Files in Simulation Mode. To
                enable this, the following VM argument has to be set:</para>
            <screen>-DdataSource.feedGenericEvents = true</screen>
            <para>The filename of the CSV File has to be according to this schema:</para>
            <literallayout>&lt;className&gt;.&lt;rank&gt;.csv</literallayout>
            <itemizedlist>
                <listitem>
                    <para>
                        <parameter>className</parameter> is the fully qualified classname (e.g.
                            <classname>com.algoTrader.event.Signal</classname>)</para>
                </listitem>
                <listitem>
                    <para>
                        <parameter>rank</parameter> is the sort order for situations where there are
                        multiple GenericEvent types for the same timestamp (e.g. a Signal and an
                        Exposure)</para>
                </listitem>
            </itemizedlist>
        </section>
        <section>
            <title>Numeric Precision</title>
            <para>In General different Securities are traded with different numeric precision (e.g.
                S&amp;P Futures prices ahve two digits, whereas FX prices are usually 5-6 digits).
                To accommodate different numeric precisions, AlgoTrader provides the following two
                Fields inside the class <classname>SecurityFamily</classname>:</para>
            <itemizedlist>
                <listitem>
                    <para><parameter>scale</parameter>: which represents the number of
                        digits</para>
                </listitem>
                <listitem>
                    <para><parameter>tickSizePattern</parameter>: A
                        <classname>java.text.ChoiceFormat.ChoiceFormat</classname>
                        representing a pattern that defines the TickSize at different Price
                        Levels. For example the pattern "<literal>0&lt;0.05 |
                            3&lt;0.1</literal>" says, that the TickSize is 0.05 for prices from 0 to
                        (but not including) 3 and 0.1 for prices above 3 </para>
                </listitem>
            </itemizedlist>

        </section>
        <section>
            <title>Market Data Gap Checking</title>
            <para>Since a continuous data feed of market data is essential for most trading
                strategies, AlgoTrader contains a feature that automatically warns if no market data
                has been received for a prolonged period of time. For this purpose the class
                    <classname>SecurityFamily</classname> has a property
                    <parameter>maxGap</parameter>, that defines the maximum number of minutes
                allowed without any market data updates.</para>
        </section>
    </chapter>
    <chapter id="Execution_Algos">
        <title>Execution Algos</title>
        <section>
            <title>Existing Execution Algos</title>
            <para>AlgoTrader provides several built-in Execution Algos.</para>
            <variablelist>
                <varlistentry>
                    <term>SlicingOrder</term>
                    <listitem>
                        <para>Splits an order into several slices, where the quantity of each slice
                            is randomized between <parameter>minVolPct</parameter> and
                                <parameter>maxVolPct</parameter> of the current volume offered at
                            the market. Each order will stay in the market for
                                <parameter>minDuration</parameter> to
                                <parameter>maxDuration</parameter> seconds (if it is not filled
                            before that). Between each slice there will be a random delay of
                                <parameter>minDelay</parameter> to <parameter>maxDelay</parameter>
                            seconds. In addition, the <classname>SlicingOrder</classname> has a
                            sophisticated pricing logic. The first order/slice starts out 1 tick
                            above the market. Depending on whether a slice gets filled, the price of
                            the next slice is adjusted. If a slice get filled, the price of the next
                            slice will be reduced by one tick (for BUY orders). If the slice does
                            not get filled, the price of the next slice is increased by one tick
                            (for BUY orders)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>TickwiseIncrementalOrder</term>
                    <listitem>
                        <para>Sends the entire Order as one Slice. The price of the order is set
                            according to the current market price. The order is first set at
                                <parameter>startOffsetTick</parameter> ticks above the market (for
                            BUY orders). If the order is not filled within a defined period of time,
                            the price of the order is increased by one tick up to a maximum of
                                <parameter>endOffsetTick</parameter> ticks below the other side of
                            the market</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>VariableIncrementalOrder</term>
                    <listitem>
                        <para>Sends the entire Order as one Slice. The price of the order is set
                            according to the current market price. The order is first set at
                                <parameter>startOffsetPct</parameter> (% of the spread) above the
                            market (for BUY orders). If the order is not filled within a defined
                            period of time, the price of the order is increased by
                                <parameter>increment</parameter> (%of the spread) up to a maximum of
                                <parameter>endOffsetPct</parameter> (% of the spread) below the
                            other side of the market</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>DistributingOrder</term>
                    <listitem>
                        <para>Distributes an order according to defined Allocations (AlgoOrder has a
                            one-to-many relation to Allocation) to different accounts / brokers. The
                            individual orders are sent as market orders. Optionally, the individual
                            orders could again be AlgoOrders</para>
                    </listitem>
                </varlistentry>
            </variablelist>
        </section>
        <section>
            <title>Development of Execution Algos</title>
            <para>Additional Execution Algos can be added to the system without much effort.
                Execution Algos consist of the following two artifacts</para>
            <itemizedlist>
                <listitem>
                    <para>a subclass of AlgoOrder. See chapter <xref linkend="Order"/>. An
                            AlgoOrder has to implement the method
                                <methodname>validate()</methodname> to validate the order parameters
                            and the method<methodname>getInitialOrders()</methodname> to return one
                            or more child orders (subclass of <classname>SimpleOrder</classname>)
                            that need to be sent to the market right away when the AlgoOrder is
                            created (and sent to the <classname>OrderService</classname>). In
                            addition the class can implement any additional logic needed in
                            conjunction with custom esper statements. AlgoOrders also provide a
                            reporting functionality (e.g. on the success of the AlgoOrder), to use
                            it the method <methodname>done()</methodname> has to be overridden. This
                            method will be invoked after the AlgoOrder has been fully executed or
                            cancelled</para>
                </listitem>
                <listitem>
                    <para>an esper module (optional). This module can optionally provide
                            statements to cancel a child order, modify a child order, send the next
                            child order, etc.</para>
                </listitem>
            </itemizedlist>
            <para>To enable AlgoOrders, the system provides the following supporting
                functionality:</para>
            <itemizedlist>
                <listitem>
                    <para>As soon as an AlgoOrder is sent via
                                <methodname>OrderService.sendOrder()</methodname> the method
                                <methodname>getInitialOrders()</methodname> of the AlgoOrder is
                            invoked</para>
                </listitem>
                <listitem>
                    <para>Each time an OrderStatus event is received for a child order (subclass
                            of SimpleOrder) an OrderStatus event is also generated for the
                            AlgoOrder</para>
                </listitem>
                <listitem>
                    <para>Each time a child order is filled, the
                                <parameter>filledQuantity</parameter>,
                                <parameter>remainingQuantity</parameter> as well as the
                                <parameter>status</parameter> (if necessary) of the AlgoOrder is
                            adjusted</para>
                </listitem>
                <listitem>
                    <para>Whenever the AlgoOrder is either fully executed or cancelled the
                            method <methodname>done()</methodname> of the AlgoOrder is invoked
                        </para>
                </listitem>
                <listitem>
                    <para>In the client both the AlgoOrder and its child orders will be visible
                            separately</para>
                </listitem>
                <listitem>
                    <para>If an AlgoOrder is cancelled all child orders will be cancelled
                            immediately</para>
                </listitem>
            </itemizedlist>
        </section>
    </chapter>
    <chapter id="Synthetic_Instruments_and_Derivative_Spreads">
        <title>Synthetic Instruments and Derivative Spreads</title>
        <figure>
            <title>Combinations and Components</title>
            <mediaobject>
                <imageobject>
                    <imagedata scalefit="1" fileref="images/Combination.png"/>
                </imageobject>
            </mediaobject>
        </figure>
        <para>AlgoTrader provides a feature to create Synthetic Instruments &amp; Derivative Spreads
            based on the two Entities Combination and Component.</para>
        <para>Combinations are handled like every other Security except that they cannot be traded
            externally. A Combination consists of one or many Components. Each component has a
            quantity.</para>
        <para>It is possible to create non-tradeable Positions based on Combinations. It is also
            possible to assign exit-values to these combination-positions, which will initiate
            closing trades to the corresponding securities if the marketPrice of the combination
            reaches the exitValue.</para>
        <para>The Base generates Ticks based on the size of the components of the combination and
            the current marketValues of the associated securities. This calculation is handled by
            the module <filename>module-combination.epl</filename> which provides the
            ComponentWindow.</para>
        <para>A Combination is available to all strategies and can be subscribed/unsubscribed in the
            usual manner.</para>
        <section>
            <title>Combination Example</title>
            <figure>
                <title>Combination Example</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/CombinationExample.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>The example above shows a Combination based on 39 VIX April 2013 Futures and 5 VIX
                May 2013 Futures. There is a non-tradeable position with quantity -1 based on that
                Combination. Also there are two physical Positions in the portfolio, that mirror the
                Components of the Combination (-39 VIX April 2013 Futures and -5 VIX May 2013
                Futures). Also the example shows that the marketPrice of the combination is based on
                a weighted average of the prices of both combinations, i.e.:</para>
            <screen>(39 * 14.90 + 5 * 15.95 ) / 44 = 15.02</screen>
        </section>
        <section>
            <title>CombinationService</title>
            <para>The <classname>CombinationService</classname> is responsible for handling all
                Combination / Component related DB-Operations.</para>
            <section>
                <title>Create Combination</title>
                <para>The following code example shows how to create a combination, add components
                    to it, create a non-tradeable position based on it and subscribe to it:</para>
                <programlisting language="Java">Combination combination = getCombinationService().createCombination(
  CombinationType.RATIO_SPREAD, securityFamilyId);

for (Security security : securities) {
  getCombinationService().addComponentQuantity(
    combination.getId(), security.getId(), quantity);
}

getPositionService().createNonTradeablePosition(strategyName, combination.getId(), 1);

getSubscriptionService().subscribeMarketDataEvent(strategyName, combination.getId());</programlisting>
            </section>
            <section>
                <title>Update Component Quantity</title>
                <para>The quantity of a Component can be set like this:</para>
                <programlisting language="Java">getCombinationService().setComponentQuantity(
  combinationSecurityId, componentSecurityId, quantity);</programlisting>
                <para>To add an amount to the current quantity of a Component:</para>
                <programlisting language="Java">getCombinationService().addComponentQuantity(
  combinationSecurityId, componentSecurityId, quantity);</programlisting>
            </section>
            <section>
                <title>Remove a Component</title>
                <programlisting language="Java">getCombinationService().removeComponent(combinationSecurityId, componentSecurityId);</programlisting>
            </section>
            <section>
                <title>Closing Combination Positions</title>
                <para>The following method closes a Combination Position:</para>
                <programlisting language="Java">getCombinationService().closeCombination(combinationSecurityId, strategyname);</programlisting>
                <para>This method will do the following:</para>
                <orderedlist numeration="arabic">
                    <listitem>
                        <para>reduce all associated physical positions by the amount specified by
                            the component</para>
                    </listitem>
                    <listitem>
                        <para>delete the non-tradeable position based on the combination</para>
                    </listitem>
                    <listitem>
                        <para>delete the combination</para>
                    </listitem>
                </orderedlist>
            </section>
            <section>
                <title>Reducing Combination Positions</title>
                <para>The following method reduces a Combination Position:</para>
                <programlisting language="Java">getCombinationService().reduceCombination(combinationSecurityId, strategyname, ratio);</programlisting>
                <para>This method will do the following:</para>
                <orderedlist numeration="arabic">
                    <listitem>
                        <para>reduce the quantity of all components by the specified ratio</para>
                    </listitem>
                    <listitem>
                        <para>reduce all associated physical positions by the amount defined by the
                            current component quantity and the ratio</para>
                    </listitem>
                </orderedlist>
            </section>
            <section>
                <title>Create / Modify / Delete a non-tradeable Position</title>
                <para>The PositionServices provides methods for managing non-tradeable
                    Positions:</para>
                <programlisting language="Java">getPositionService().createNonTradeablePosition(strategyName, securityId, quantity);

getPositionService().modifyNonTradeablePosition(positionId, quantity);

getPositionService().deleteNonTradeablePosition(positionId, unsubscribe);</programlisting>
                <important>
                    <para>If Components are modified directly in the database, it is necessary to
                        clear the cache as well as to call the method
                            <methodname>BaseManagementService.resetComponentWindow</methodname>
                        immediately afterwards. If this is not done within a short period of time
                        this might lead to miss-pricing of the corresponding
                            <classname>Cominbation</classname>. It is therefore preferable to modify
                        Components via the Client directly.</para>
                </important>
            </section>
        </section>
    </chapter>
    <chapter id="Spring_Services">
        <title>Spring Services</title>
        <para>AlgoTrader is built on top of the Spring Framework, which uses
                <classname>BeanFactory</classname> and <classname>ApplicationContext</classname> to
            locate Spring Beans (= AlgoTrader-Services).</para>
        <para>The <ulink url="http://www.springsource.org/"> SpringSource</ulink> web site provides
                <ulink url="http://www.springsource.org/documentation"> documentation</ulink> such
            as <ulink url="http://static.springsource.org/spring/docs/3.0.x/reference/html/beans.html">
                'The IoC container'</ulink> as an introduction.</para>
        <para>AlgoTrader provides the class <classname>com.algoTrader.ServiceLocator</classname>
            which will instantiate the adequate BeanFactories &amp; ApplicationContexts for a given
            operational mode depending on the specified
                <parameter>BEAN_REFERENCE_LOCATION</parameter>.</para>
        <para>In Simulation mode the Base as well as the Strategy run inside the same JVM.</para>
        <para>In Live-Trading mode the Base and the strategy are running in different JVM's. Through
            the use of <classname>RmiServiceExporters</classname> and
                <classname>RmiProxyFactoryBean</classname>, Strategies can call Services from the
            Base. Behind the scenes this is done transparently through RMI.</para>
        <para>Please see <ulink url="http://static.springsource.org/spring/docs/3.0.x/reference/html/remoting.html">
                Remoting and web services using Spring</ulink> for further details.</para>
        <section>
            <title>BeanRefFactories</title>
            <para>AlgoTrader provides the following beanRefFactory XML-Files, which are instantiated
                by the ServiceLocators:</para>
            <table frame="all" pgwide="1">
                <title>Bean Reference Factories</title>
                <tgroup cols="3">
                    <colspec colwidth="0.8*"/>
                    <colspec colwidth="1*"/>
                    <colspec colwidth="1*"/>
                    <thead>
                        <row>
                            <entry>BeanRefFactoriy</entry>
                            <entry>BEAN_REFERENCE_LOCATION</entry>
                            <entry>Description</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>beanRefFactoryLocal.xml</entry>
                            <entry>LOCAL</entry>
                            <entry>used when no remoting or strategy related functionality is needed
                                (i.e. HistoricalDataStarter)</entry>
                        </row>
                        <row>
                            <entry>beanRefFactoryServer.xml</entry>
                            <entry>SERVER</entry>
                            <entry>used to export Services through RMI</entry>
                        </row>
                        <row>
                            <entry>beanRefFactoryClient.xml</entry>
                            <entry>CLIENT</entry>
                            <entry>used by the Strategies in Live Trading Mode to connect to Base
                                Services through RMI</entry>
                        </row>
                        <row>
                            <entry>beanRefFactorySimulation</entry>
                            <entry>SIMULATION</entry>
                            <entry>used in simulation</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section>
            <title>ApplicationContext</title>
            <para>AlgoTrader provides the following ApplicationContext XML-Files :</para>
            <table frame="all" pgwide="1">
                <title>Application Context Files</title>
                <tgroup cols="4">
                    <colspec colwidth="2*"/>
                    <colspec colwidth="2*"/>
                    <colspec colwidth="0.8*"/>
                    <colspec colwidth="2*"/>
                    <thead>
                        <row>
                            <entry>ApplicationContext</entry>
                            <entry>Description</entry>
                            <entry>Generated</entry>
                            <entry>Examples</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>applicationContext.xml</entry>
                            <entry>contains all Services and DAO's (generated by AndroMDA)</entry>
                            <entry>x</entry>
                            <entry>Services and DAO's</entry>
                        </row>
                        <row>
                            <entry>applicationContext-export-remoteServices.xml</entry>
                            <entry>contains all RmiServiceExporters to make Services remotely
                                available (generated by AndroMDA)</entry>
                            <entry>x</entry>
                            <entry/>
                        </row>
                        <row>
                            <entry>applicationContext-import-remoteServices.xml</entry>
                            <entry>contains all RmiProxyFactoryBean to call remote Base Services
                                from the Strategies through RMI (generated by AndroMDA)</entry>
                            <entry>x</entry>
                            <entry/>
                        </row>
                        <row>
                            <entry>applicationContext-common.xml</entry>
                            <entry>contains common Beans</entry>
                            <entry/>
                            <entry>Configuration and JMX Management</entry>
                        </row>
                        <row>
                            <entry>applicationContext-server.xml</entry>
                            <entry>contains beans used by the core project</entry>
                            <entry/>
                            <entry>DataSource, Broker Interfaces, JMX Exporters, Server JMS </entry>
                        </row>
                        <row>
                            <entry>applicationContext-remote.xml</entry>
                            <entry>contains beans used by strategies when run in remote mode</entry>
                            <entry/>
                            <entry>Diagrams, Remote JMS</entry>
                        </row>
                        <row>
                            <entry>applicationContext-client.xml</entry>
                            <entry>has to be provided by the Strategies</entry>
                            <entry/>
                            <entry>Defined Services, Diagrams, JMS Queues</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
            <para>The following table shows which ApplicationContext is referenced by which
                BeanRefFactory:</para>
            <table frame="all" pgwide="1">
                <title>Application Context References</title>
                <tgroup cols="5">
                    <colspec colwidth="3*"/>
                    <colspec colwidth="0.5*"/>
                    <colspec colwidth="0.5*"/>
                    <colspec colwidth="0.5*"/>
                    <colspec colwidth="0.5*"/>
                    <thead>
                        <row>
                            <entry>ApplicationContext</entry>
                            <entry>Local</entry>
                            <entry>Server</entry>
                            <entry>Client</entry>
                            <entry>Simulation</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>applicationContext</entry>
                            <entry>x</entry>
                            <entry>x</entry>
                            <entry/>
                            <entry>x</entry>
                        </row>
                        <row>
                            <entry>applicationContext-export-remoteServices</entry>
                            <entry/>
                            <entry>x</entry>
                            <entry/>
                            <entry/>
                        </row>
                        <row>
                            <entry>applicationContext-import-remoteServices</entry>
                            <entry/>
                            <entry/>
                            <entry>x</entry>
                            <entry/>
                        </row>
                        <row>
                            <entry>applicationContext-common</entry>
                            <entry>x</entry>
                            <entry>x</entry>
                            <entry>x</entry>
                            <entry>x</entry>
                        </row>
                        <row>
                            <entry>applicationContext-server</entry>
                            <entry>x</entry>
                            <entry>x</entry>
                            <entry/>
                            <entry>x</entry>
                        </row>
                        <row>
                            <entry>applicationContext-remote</entry>
                            <entry/>
                            <entry/>
                            <entry>x</entry>
                            <entry/>
                        </row>
                        <row>
                            <entry>applicationContext-client</entry>
                            <entry/>
                            <entry/>
                            <entry>x</entry>
                            <entry>x</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section id="Spring-Profiles">
            <title>Spring Profiles</title>
            <para>In addition to BeanRefFactories which define the different operational modes there are
                Profiles which can be enabled on top for different Use Cases or left disabled if
                they are not needed (e.g. SecurityRetrieval in Live-Trading-Mode)</para>
            <figure>
                <title>Spring Profiles</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/SpringProfiles.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>All other services not mentioned above are active in all profiles.</para>
            <para>To enable a Profile on start-up, the following vm argument has to be used:</para>
            <screen>-Dspring.profiles.active=server,trading,iBNative</screen>
        </section>
        <section>
            <title>Abstract Services</title>
            <para>For many use cases abstract services are in place which can be extended for
                different market channels.</para>
            <para>For abstract services where there will only be one concrete implementation active
                (through profiles), an alias can be defined for the concrete service (e.g.
                    <classname>iBAccountService</classname>,
                    <classname>iBMarketDataService</classname>). A typical Profile configuration
                inside <filename>applicationContext-xxx.xml</filename> looks like this:</para>
            <screen language="XML">&lt;alias name="iBOrderService" alias="orderService"/>
&lt;alias name="iBMarketDataService" alias="marketDataService"/>  </screen>
            <para>At runtime this service can now be accessed through its alias (e.g.
                    <parameter>accountService</parameter>,
                <parameter>marketDataService</parameter>)</para>
            <para>For abstract services where there will potentially be more than one concrete
                implementation active (through profiles), aliases are not available. In this case
                the following method can be used to look up all available concrete services that
                extend the abstract service (see OrderService for an example):</para>
            <programlisting language="Java">ServiceLocator.instance().getServices(ExternalOrderService.class)</programlisting>
        </section>
    </chapter>
    <chapter id="Messaging">
        <title>Messaging</title>
        <para>In Live Trading Mode strategies run in separate JVM and communicate with Base through
            the following two methods:</para>
        <itemizedlist>
            <listitem>
                <para>Method Invocation on Base Services takes place via RMI see <xref linkend="RMI"/>
                </para>
            </listitem>
            <listitem>
                <para>Event Propagation from Base to the strategies (and between strategies)
                        happens via JMS &amp; <ulink url="http://activemq.apache.org/">
                            ActiveMQ</ulink>
                </para>
            </listitem>
        </itemizedlist>
        <section>
            <title>JMS Destinations</title>
            <para>The following JMS Destinations are defined by the system</para>
            <itemizedlist>
                <listitem>
                    <para>one marketDataTopic (<literal>MARKETDATA.TOPIC</literal>): A Topic where all market data
                        events are pushed into. On every event the <parameter>securityId</parameter>
                        is set as a property, which can be used by the strategies to select market
                        data events for securities subscribed to. Events are sent via
                            <methodname>EsperManager.sendEvent()</methodname>
                    </para>
                </listitem>
                <listitem>
                    <para>one strategyQueue per strategy (<literal>XXX.QUEUE</literal>): A
                            strategy specific Queue for messages like OrderStatus, Fills &amp;
                            Transactions. As JMS queues are persistent, messages will be delivered,
                            even if a strategy was down, at the time of message creation. Events are
                            sent via <methodname>EsperManager.sendMarketDataEvent()</methodname>
                    </para>
                </listitem>
                <listitem>
                    <para>one genericTopic (<literal>GENERIC.TOPIC</literal>): A Topic for Generic Messages. Any
                        strategy can send messages into this Topic. On every event the
                            <parameter>className</parameter> of the event is set as a property,
                        which can be used by the strategy to select event types that it is
                        subscribed to. Events are sent via
                            <methodname>EsperManager.sendGenericEvent()</methodname>
                    </para>
                </listitem>
            </itemizedlist>
        </section>
        <section>
            <title>JMS Configuration</title>
            <para>The entire JMS subsystem is configured through the following Spring Configuration
                files.</para>
            <para>
                <filename>applicationContext-server.xml</filename>:</para>
            <itemizedlist>
                <listitem>
                    <para>JMS <classname>ConnectionFactory</classname> (with fail over)</para>
                </listitem>
                <listitem>
                    <para>JMS Market Data and Generic Topic</para>
                </listitem>
                <listitem>
                    <para>JMS <classname>Templates</classname>
                    </para>
                </listitem>
                <listitem>
                    <para>custom <classname>MessageConverter</classname> that will prevent
                            Collections in Java Object Trees from being serialized</para>
                </listitem>
            </itemizedlist>
            <para>
                <filename>applicationContext-remote.xml</filename>:</para>
            <itemizedlist>
                <listitem>
                    <para>JMS <classname>ConnectionFactory</classname> (with failover)</para>
                </listitem>
                <listitem>
                    <para>JMS <classname>Template</classname> &amp; JMS
                                <classname>MessageUnmarshaller</classname> for receiving messages
                        </para>
                </listitem>
                <listitem>
                    <para>Esper based <classname>JMSTemplateInputAdapter</classname> that will
                            forward received messages into the local Esper Engine</para>
                </listitem>
                <listitem>
                    <para>JMS Market Data and a JMS Generic Topic as well as corresponding
                                <classname>MessageListenerContainer</classname>. Its selector
                            property is used for message selection</para>
                </listitem>
            </itemizedlist>
            <para>
                <filename>applicationContext-client-xxx.xml</filename>:</para>
            <itemizedlist>
                <listitem>
                    <para>JMS Strategy Queue</para>
                </listitem>
            </itemizedlist>
            <para>Since market data events and generic events are pushed into two
                topics that are available to all strategies, strategies have to select appropriate
                messages on their own. This is the job of the
                    <classname>SubscriptionService</classname>. It will modify the selectors on
                    <classname>MessageListenerContainer</classname> accordingly and invoke the
                corresponding methods on the (server-side) <classname>MarketDataService</classname>
                (e.g. to request market data for additional securities).</para>
        </section>
    </chapter>
    <chapter id="Configuration">
        <title>Configuration</title>
        <section>
            <title>Configuration Files</title>
            <para>For the Base as well as for each strategy one or multiple configuration files exist in the
                directory <filename>/src/main/resources/META-INF</filename>.</para>
            <para>The Base contains the following two main configuration files.</para>
            <para>conf.properties (the main public configuration file). It contains settings related to:</para>
            <itemizedlist>
                <listitem>
                    <para>Dataset Configuration</para>
                </listitem>
                <listitem>
                    <para>Simulation Parameters</para>
                </listitem>
                <listitem>
                    <para>Order / Execution Parameters</para>
                </listitem>
                <listitem>
                    <para>RMI Remoting</para>
                </listitem>
            </itemizedlist>
            <para>
                <filename>conf-core.properties</filename> (contains settings that are only used by the core project):</para>
            <itemizedlist>
                <listitem>
                    <para>DataSource Configuration</para>
                </listitem>
                <listitem>
                    <para>Esper Statements</para>
                </listitem>
                <listitem>
                    <para>Http Parameters</para>
                </listitem>
            </itemizedlist>
            <para>In addition each Broker Interface has its own settings file. e.g.<filename> conf-ib.properties</filename> for IB.</para>
            <para>Configuration parameters can also be provided as a VM argument when starting up
                the system, they will overwrite existing parameters.</para>
            <para>Most configuration parameters are prefixed with a namespace (i.e. dataSource,
                simulation, statement, misc, etc.)</para>
            <important>
                <para>Settings of the main config file conf.properties can be overwritten by any
                    strategy related property file (i.e. order parameters). However only these
                    settings can be overwritten. Settings defined within a Strategy cannot be
                    overwritten by a Sub-Strategy (because the load order of individual strategy
                    jars is arbitrary). Therefore if different Sub-Strategy want to define different
                    values to the same variable, all Sub-Strategies have to define the setting in
                    their .properties file.</para>
            </important>
        </section>
        <section>
            <title>Esper Variables</title>
            <para>The configuration files are also used to define values for Esper variables.
                Because the Esper Variable system is strong typed, variables with their type have to
                be configured within the corresponding Esper configuration files. i.e.</para>
            <programlisting language="XML">&lt;variable name="simulation_eventsPerDay" type="long"/&gt;    </programlisting>
            <para>Namespaces have to be specified using an underscore instead of a period. i.e.
                    <parameter>simulation_eventsPerDay</parameter> corresponds to
                    <parameter>simulation.eventsPerDay</parameter> in the property file. It is not
                mandatory to specify a namespace however. If a namespace is left out, the variable
                value is searched in the main config file of the corresponding strategy.</para>
        </section>
        <section>
            <title>Access to Configuration Values</title>
            <para>The following five Spring Services are used to gain access to Configuration
                Values:</para>
            <variablelist>
                <varlistentry>
                    <term>
                        <classname>org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor</classname>
                    </term>
                    <listitem>
                        <para>uses Java Annotations to assign configuration values to Service
                            fields</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <classname>com.algoTrader.util.spring.SystemPropertiesFactoryBean</classname>
                    </term>
                    <listitem>
                        <para>loads configuration values from the conf.properties files</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <classname>org.springframework.beans.factory.config.PropertyPlaceholderConfigurer</classname>
                    </term>
                    <listitem>
                        <para>overwrites configuration values from values specified as Java System
                            Properties (i.e. -DalgoTrader...)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <classname>com.algoTrader.util.spring.Configuration</classname>
                    </term>
                    <listitem>
                        <para>Service containing commonly used configuration values as well as
                            strong typed getters to arbitrary configuration values</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <classname>com.algoTrader.util.spring.EntityAnnotationSetter</classname>
                    </term>
                    <listitem>
                        <para>uses Java Annotations to assign configuration values to static Entity
                            fields</para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para>Using <classname>AutowiredAnnotationBeanPostProcessor</classname> and
                    <classname>EntityAnnotationSetter</classname> configuration values can be
                assigned to Spring Services and Entities using the <ulink url="http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/expressions.html"> Spring Expression Language (SpEL)</ulink>. Examples:</para>
            <programlisting language="Java">private @Value("${simulation}") boolean simulation;
private @Value("${order.initialMarginMarkup}") double initialMarginMarkup;
private @Value("#{T(com.algoTrader.enumeration.Currency)
  .fromString('${misc.portfolioBaseCurrency}')}") Currency portfolioBaseCurrency;</programlisting>
        </section>
    </chapter>
    <chapter id="Remoting">
        <title>Remoting</title>
        <section id="RMI">
            <title>RMI</title>
            <para>The following RMI services are defined by the system:</para>
            <itemizedlist>
                <listitem>
                    <para>Spring Remoting (RMI Registry 1199):
                            <classname>RmiServiceExporter</classname> (defined in
                            <filename>applicationContext-export-remoteServices.xml</filename>)</para>
                </listitem>
                <listitem>
                    <para>JMX (RMI Registry 1099)</para>
                    <itemizedlist>
                        <listitem>
                            <para>AlgoTrader: <classname>AnnotationMBeanExporter</classname>
                                    (defined in
                                    <filename>applicationContext-common.xml</filename>)</para>
                        </listitem>
                        <listitem>
                            <para>Hibernate:
                                        <classname>hibernate.jmx.StatisticsService</classname>
                                    (defined in
                                    <filename>applicationContext-server.xml</filename>)</para>
                        </listitem>
                        <listitem>
                            <para>EhCache:
                                        <classname>net.sf.ehcache.management.ManagementService</classname>
                                    (defined in
                                    <filename>applicationContext-server.xml</filename>)</para>
                        </listitem>
                        <listitem>
                            <para>Log4J:<classname> Log4JExporter</classname> (defined in
                                        <filename>applicationContext-server.xml</filename>)</para>
                        </listitem>
                        <listitem>
                            <para>Esper: <classname>EsperJMX</classname> (defined in
                                        <filename>esper-xxx.cfg.xml</filename>)</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
            </itemizedlist>
        </section>
        <section>
            <title>Socket</title>
            <table frame="all" pgwide="1">
                <title>Sockets</title>
                <tgroup cols="3">
                    <colspec colwidth="0.6*"/>
                    <colspec colwidth="1*"/>
                    <colspec colwidth="1*"/>
                    <thead>
                        <row>
                            <entry>Socket</entry>
                            <entry>Description</entry>
                            <entry>Ports</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>JMX RMI</entry>
                            <entry>Java Management</entry>
                            <entry>1099/1098, 1097/1096, 1095/1094,etc.</entry>
                        </row>
                        <row>
                            <entry>RMI Exporter</entry>
                            <entry>Remote access to Spring services</entry>
                            <entry>1199</entry>
                        </row>
                        <row>
                            <entry>MySql</entry>
                            <entry>Database connection</entry>
                            <entry>3306</entry>
                        </row>
                        <row>
                            <entry>Java Debugging Agent</entry>
                            <entry>specified as a VM argument (testing only)</entry>
                            <entry>8000 and up</entry>
                        </row>
                        <row>
                            <entry>IB Gateway</entry>
                            <entry>defined by IB Gateway configuration</entry>
                            <entry>4001</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section id="JMX">
            <title>JMX</title>
            <para>Management is provided through JMX. The JMX connection is secured through SSL by
                using the following vm arguments:</para>
            <screen>-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=true
-Dcom.sun.management.jmxremote.ssl.need.client.auth=true
-Dcom.sun.management.jmxremote.registry.ssl=true
-Djavax.net.ssl.keyStore=keystore
-Djavax.net.ssl.keyStorePassword=...
-Djavax.net.ssl.trustStore=truststore
-Djavax.net.ssl.trustStorePassword=...</screen>
            <para>By default only the RMI Registry Port can be defined through vm arguments
                    (<parameter>com.sun.management.jmxremote.port</parameter>). The RMI Server Port
                is chosen randomly which is not feasible through firewalls. For this reason a Custom
                JMXAgent is in place, which takes the following two vm arguments to define both
                ports:</para>
            <screen>-Dcom.algoTrarder.rmi.registryPort
-Dcom.algoTrarder.rmi.serverPort</screen>
            <para>In order to use this Custom JMXAgent the following has to be specified on the
                commandline:</para>
            <screen>-javaagent:lib/agent.jar</screen>
            <para>In addition the following vm argument has to be specified, which defines the
                public external host name:</para>
            <screen>-Djava.rmi.server.hostname=xxx</screen>
            <note>
                <itemizedlist>
                    <listitem>
                        <para>This vm argument will also be used by SpringRMI. It is therefore
                            important that the public hostname is declarded in the local hosts
                            file!!!</para>
                    </listitem>
                    <listitem>
                        <para>It is easiest if the same keystore and truststore files are used on
                            server and client.</para>
                    </listitem>
                    <listitem>
                        <para>The keystore password has to be the same as the key password.</para>
                    </listitem>
                    <listitem>
                        <para>In addition the truststore should also contain the default CA Certs
                            (copied from<filename> jre/lib/security/cacerts</filename>).</para>
                    </listitem>
                </itemizedlist>
            </note>
        </section>
    </chapter>
    <chapter id="Threading_and_Concurrency">
        <title>Threading and Concurrency</title>
        <para>AlgoTrader is designed for a multi-threaded, highly-concurrent environment through the
            use of Esper Threading.</para>
        <section>
            <title>Esper Threading</title>
            <para>Esper has several options for enabling a multi-threaded environment, see <ulink url="http://esper.codehaus.org/esper-4.9.0/doc/reference/en-US/html_single/index.html#api-threading">Esper API Threading</ulink>
            </para>
            <para>In Live-Trading Mode AlgoTrader uses outbound threading with 3 threads by default.
                This means that all Subscriber / Listener Tasks are handled by a thread-pool of 3
                threads. Subscribers / Listeners working in parallel is generally not a problem as
                long as they do not modify the same Entity at the same time. However if two
                Subscribers / Listeners modify the same Entity (e.g. a Position) at the same time,
                this could lead to an inconsistent state in the database.</para>
            <para>For this purpose AlgoTrader uses general database isolation levels as well as
                Hibernate's optimistic and pessimistic locking.</para>
            <para>For debugging reasons AlgoTrader logs the name of the thread using log4j, see
                    <xref linkend="Logging"/>
            </para>
        </section>
        <section>
            <title>Database Isolation Level</title>
            <para>Mysql operates at Repeatable read isolation level (only Phantom reads are
                possible)</para>
        </section>
        <section id="Hibernate_Locking">
            <title>Hibernate Locking</title>
            <para>Per default no concurrency control is enabled. If two sessions operate on the same entity
                at the same time, the last update wins and the first update is lost.</para>
            <section>
                <title>Optimistic Locking</title>
                <para>This option is best for situations where concurrent modifications happen
                    rarely, but one wishes to be notified in case two sessions operate on the same
                    entity at the same time. In this case the first update wins and the second
                    update throws an exception.</para>
                <para>Hibernate uses versions for this purpose. To enable add the following to the
                    class-mapping:</para>
                <programlisting language="XML">&lt;version name="version"/&gt;</programlisting>
                <para>The tagged value andromda_hibernate_version can be used in the UML model to
                    enable versioning for an Entity.</para>
                <para>Optimistic Locking is only necessary for tables that are actually updated.
                    Currently the following tables are using optimistic locking:</para>
                <itemizedlist>
                    <listitem>
                        <para>CashBalance</para>
                    </listitem>
                    <listitem>
                        <para>PropertyHolder (primarily used by Position, but for union-subclasses, version can only
                            be set on the top-level class) </para>
                    </listitem>
                    <listitem>
                        <para>Property</para>
                    </listitem>
                    <listitem>
                        <para>Component</para>
                    </listitem>
                </itemizedlist>
            </section>
            <section>
                <title>Pessimistic Locking</title>
                <para>This option is best for situations where concurrent modifications are expected
                    and unacceptable (e.g. modifications to positions/cashBalances).</para>
                <para>For this purpose Hibernate uses database locks. To request a lock do one of
                    the following:</para>
                <programlisting language="Java">session.createQuery(sql).setLockOptions(LockOptions.UPGRADE)
session.get(class, id, LockMode.PESSIMISTIC_WRITE)
session.refresh(class, id, LockMode.PESSIMISTIC_WRITE)
session.buildLockRequest(LockOptions.NONE).lock(entity)</programlisting>
                <para>This will execute a</para>
                <programlisting>SELECT ... FOR UPDATE</programlisting>
                <para>AlgoTrader provides the tagged value
                        <parameter>algotrader_finder_method_lock</parameter> which will use
                    QueryLocking:</para>
                <programlisting language="Java">queryObject.setLockOptions(LockOptions.UPGRADE);</programlisting>
                <para>The records that are selected are locked on the database level. Unlocked
                    selects are still possible, but the following are blocked until the locking
                    session is committed / rolled-back:</para>
                <itemizedlist>
                    <listitem>
                        <para>commit in another session</para>
                    </listitem>
                    <listitem>
                        <para>lock request in another session</para>
                    </listitem>
                </itemizedlist>
                <warning>
                    <para>session.buildLockRequest might throw a StaleObjectException if the other
                        session holding the lock actually modified the object in the meantime. If
                        the exception is thrown, the session has to be aborted because recovery of
                        the Exception is not possible</para>
                </warning>
                <section>
                    <title>Transactions</title>
                    <itemizedlist>
                        <listitem>
                            <para>in order for locks to work, there needs to be a transaction
                            </para>
                        </listitem>
                        <listitem>
                            <para>to find out if there is a transaction call:</para>
                        </listitem>
                    </itemizedlist>
                    <programlisting language="Java">getSessionFactory().getCurrentSession().getTransaction().isActive()</programlisting>
                </section>
                <section>
                    <title>Query Locking</title>
                    <itemizedlist>
                        <listitem>
                            <para>locking on a query only works if there are no cross-joins
                                generated</para>
                        </listitem>
                        <listitem>
                            <para>The following HQL will create a cross join:</para>
                        </listitem>
                    </itemizedlist>
                    <programlisting>from PositionImpl as p
where and p.strategy.name = 'BASE'</programlisting>
                    <itemizedlist>
                        <listitem>
                            <para>If it is rewritten as follows, there will not be a cross join
                                in the generated SQL:</para>
                        </listitem>
                    </itemizedlist>
                    <programlisting>from PositionImpl as p
join p.strategy as s
where and s.name = 'BASE'</programlisting>
                    <itemizedlist>
                        <listitem>
                            <para>It is a good idea to test generated SQL statements in an SQL
                                client for locking issues</para>
                        </listitem>
                        <listitem>
                            <para>Locked queries should not be cached, because if they are, the second query would not go
                                to the database and therefore would not be locked</para>
                        </listitem>
                        <listitem>
                            <para>If a query is unmatched (e.g. from PositionImpl where id = 10
                                and the id does not exist), Hibernate locks the entire table! To
                                prevent this either use transaction isolation level
                                <parameter>READ COMMITTED</parameter> or set the
                                <parameter>innodb_locks_unsafe_for_binlog</parameter>
                            </para>
                        </listitem>
                    </itemizedlist>
                </section>
            </section>
        </section>
        <section id="HibernateSession_Handling">
            <title>Hibernate Session Handling</title>
            <para>Any access to the database needs to be accompanied by a Hibernate Session. The
                Hibernate Session has its own First Level Cache and is also responsible to access
                the Second Level Cache if necessary. In case an Object that is already loaded into
                the current Hibernate Session, is modified outside the Session, the current Session
                will not get notified of the change. For this reason it is important to know at what
                poing a new Session is created and for how long it exists. There are basically two
                scenarios in which Hibernate Session are created.</para>
            <section>
                <title>Market Data Event Hibernate Sessions</title>
                <figure>
                    <title>Market Data Event Hibernate Sessions</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/MarketDataEventHibernateSessions.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>In Simulation Mode the <classname>CustomSender</classname> is responsible to
                    send <classname>MarketDataEvents</classname> into the Base Esper Engine. </para>
                <para>In Live Trading it is the <classname>MessageHandler</classname> of the
                    corresponding BrokerInterface (e.g.
                    <classname>IBEsperMessageHandler</classname>) who is responsible to send
                        <classname>MarketDataEvents</classname> into the Base Esper Engine. </para>
                <para>Before the <classname>MarketDataEvents</classname> are sent into the Esper
                    Engine, both the <classname>CustomSender</classname> and the
                        <classname>MessageHandler</classname> contact the
                        <classname>LookupService</classname> to get an up-to-date version of the
                    corresponding Security. This step involves opening a new Hibernate Session and
                    initializing the corresponding <classname>SecurityFamily</classname>, Underlying
                        <classname>Security</classname>, <classname>Subscriptions</classname> and
                        <classname>Positions</classname>.</para>
                <para>By the time the <classname>MarketDataEvent</classname> is sent into the Esper
                    Engine of the Base, the session is already closed an the
                        <classname>MarketDataEvent</classname> (along with its attached
                        <classname>Security</classname>) are now in detached state, which means that
                    traversal along the Object Tree (beyond <classname>Security</classname>,
                        <classname>SecurityFamily</classname>, Underlying
                        <classname>Security</classname>, <classname>Subscriptions</classname> and
                        <classname>Positions</classname>) will throw a
                        <classname>LazyInitializationException</classname>.</para>
                <para>If any statement of the Base Esper Engine invokes a Service via Esper
                    Subscriber a new Hibernate Session is stared (and immediately closed
                    afterwards).</para>
                <para>Market Data Events get transferred to the Strategies by the
                        <classname>MarketeDataPropagator</classname>. Since Strategies run in
                    different JVM's their entire operation (Esper Statements and Java Code) run
                    outside of a Hibernate Session. Traversal along the Object Tree (beyond
                        <classname>Security</classname>, <classname>SecurityFamily</classname>,
                    Underlying <classname>Security</classname>, <classname>Subscriptions</classname>
                    and <classname>Positions</classname>) would again throw a
                        <classname>LazyInitializationException</classname>. </para>
                <para>However custom getter methods generated into the Entities  (e.g.
                        <methodname>Transaction.getSecurityInitialized()</methodname> or
                        <methodname>Security.getPositionsInitialized()</methodname>) check if the
                    requested association is already initialized. If not the
                        <classname>LazyLoaderService</classname> is called, which loads the
                    requested association. Subsequent calls to the same association will then get
                    access to the already initialized Entity or Collection. By this technique the
                    Lazy-Loading Mechanism that is normally only be available inside a Hibernate
                    Session (and therefore only inside the Base) is also available to
                    Strategies.</para>
            </section>
            <section>
                <title>Trade Hibernate Sessions</title>
                <figure>
                    <title>Market Data Event Hibernate Sessions</title>
                    <mediaobject>
                        <imageobject>
                            <imagedata scalefit="1" fileref="images/TradeHibernateSessions.png"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <para>An <classname>Order</classname> is either created by the
                        <classname>StrategyService</classname> or manually through the
                        <classname>ManagementService</classname>. </para>
                <para>An <classname>Order</classname> is created in detached state (since Strategies
                    run outside of a Hibernate Session). The <classname>Order</classname> object is
                    sent to the <classname>OrderService</classname> (via RMI) at which point a
                    Hibernate Session is created. The
                        <methodname>OrderService.sendOrder</methodname> method is responsible to
                    "refresh" the <classname>Security</classname>, <classname>Strategy</classname>
                    and <classname>Account</classname> association of the
                        <classname>Order</classname>. This is necessary since the Entities that are
                    attached to the Order might be stale or obsolete by the time they arrive at the
                        <classname>OrderService</classname>. The <classname>OrderService</classname>
                    is also responsible to delegate the <classname>Order</classname> to the Broker
                    specific <classname>OrderService</classname>, which send the
                        <classname>Order</classname> over the wire. </para>
                <para>After sending the <classname>Order</classname>, the Hibernate Session is
                    closed and the detached object is sent into the Base Esper Engine, where it is
                    correlated with <classname>OrderStatus</classname> events and
                        <classname>Fills</classname> arriving back from the external Broker
                    Interface. </para>
                <para>After that the following three steps take place, each happens inside its own
                    Hibernate Session:</para>
                <para>
                    <itemizedlist>
                        <listitem>
                            <para><classname>OrderStatus</classname> events are propagated to the
                                Strategy by the
                                    <methodname>OrderService.propagateOrderStatus</methodname>
                                method </para>
                        </listitem>
                        <listitem>
                            <para><classname>Fills</classname> are propagated  to the Strategy by
                                the <methodname>TransactionService.propagateFill</methodname>
                                method</para>
                        </listitem>
                        <listitem>
                            <para><classname>Fills</classname> are passed to the
                                    <classname>TransactionService</classname> which is responsible
                                to create a corresponding <classname>Transaction</classname> in the
                                database and propagate it to the Strategy.</para>
                        </listitem>
                    </itemizedlist>
                </para>
            </section>
        </section>
    </chapter>
    <chapter id="Security">
        <title>Security</title>
        <para>At the current stage the system is a NON secure application. It does not provide
            authentication or authorization services of any kind. All passwords are stored in
            plain-text.</para>
        <para>It is therefore necessary that the system is run in a secure environment and not being
            accessible from the outside world. For remote access to the system (i.e. JMX) it is
            recommended to use an SSH tunnel.</para>
        <para>Through extensive use of Logging a very detailed Audit Trail is enabled. See <xref linkend="Logging"/>
        </para>
    </chapter>
    <chapter id="Metrics">
        <title>Metrics</title>
        <para>In Simulation Mode the performance objective of the system is high-throughput, whereas in
            Live Trading Mode the objective is low latency. To pinpoint potential performance
            bottlenecks, AlgoTrader has a built-in metrics functionality.</para>
        <section>
            <title>Configuration</title>
            <para>To enable this feature:</para>
            <itemizedlist>
                <listitem>
                    <para>in <filename>conf.properties</filename> set
                            <parameter>misc.metricsEnabled</parameter> to true</para>
                </listitem>
                <listitem>
                    <para>add module <parameter>metrics</parameter> to all relevant strategy db
                        records</para>
                </listitem>
                <listitem>
                    <para>inside <filename>esper-common.cfg.xml</filename>, uncomment the following
                        sections:</para>
                </listitem>
            </itemizedlist>
            <programlisting language="XML">&lt;event-type name="StatementMetric" class="com.algoTrader.vo.StatementMetricVO"/>

// in simulation
&lt;metrics-reporting enabled="true" engine-interval="-1" statement-interval="86400000" />

// in live trading
&lt;metrics-reporting enabled="true" engine-interval="-1" statement-interval="10000" /> </programlisting>
            <para>The class <classname>com.algoTrader.util.metric.MetricsUtil</classname> provides
                several methods for recording execution time of critical code (i.e. account and
                accountEnd).</para>
        </section>
        <section>
            <title>Metrics Reporting</title>
            <para>AlgoTrader Metrics Reporting logs a detailed summary of all metrics as well as
                statement time consumption to the console. Displayed values are Execution time (in
                nano seconds) and Execution Count.</para>
            <para>Metrics Reporting is invoked by one of the following two methods:</para>
            <itemizedlist>
                <listitem>
                    <para>In Live Trading Mode a metrics report can be invoked through the
                                <classname>BaseManagementService</classname> (through this service
                            it is also possible to reset metrics)</para>
                </listitem>
                <listitem>
                    <para>In Simulation Mode (if metrics are enabled) there will be a metrics
                            report at the end of each simulation run</para>
                </listitem>
            </itemizedlist>
            <para>A typical display of performance metrics looks like this, where ideally the sum of all
                items on a sub-level should add up to the metrics value of the parent-level:</para>
            <itemizedlist>
                <listitem>
                    <para>TotalDuration</para>
                    <itemizedlist>
                        <listitem>
                            <para>CustomSender.readCSV</para>
                        </listitem>
                        <listitem>
                            <para>CustomSender.completeRaw</para>
                            <itemizedlist>
                                <listitem>
                                    <para>LookupService.getMarketDataEventFromRaw</para>
                                    <itemizedlist>
                                        <listitem>
                                            <para>MarketDataEventDao.rawToEntity</para>
                                        </listitem>
                                        <listitem>
                                            <para>MarketDataEventDao.getSecurityId</para>
                                        </listitem>
                                        <listitem>
                                            <para>MarketDataEventDao.securityLookup</para>
                                        </listitem>
                                        <listitem>
                                            <para>MarketDataEventDao.initialization</para>
                                            <itemizedlist>
                                                <listitem>
                                                    <para>Security.positions</para>
                                                </listitem>
                                                <listitem>
                                                    <para>Security.subscriptions</para>
                                                </listitem>
                                                <listitem>
                                                    <para>Security.underlying</para>
                                                </listitem>
                                                <listitem>
                                                    <para>Security.securityFamily</para>
                                                </listitem>
                                            </itemizedlist>
                                        </listitem>
                                    </itemizedlist>
                                </listitem>
                                <listitem>
                                    <para>Session initialization</para>
                                </listitem>
                            </itemizedlist>
                        </listitem>
                        <listitem>
                            <para>CustomSender.sendCurrentTimeEvent</para>
                        </listitem>
                        <listitem>
                            <para>CustomSender.sendMarketDataEvent</para>
                            <itemizedlist>
                                <listitem>
                                    <para>EsperManager.BASE.BarImpl</para>
                                </listitem>
                                <listitem>
                                    <para>EsperManager.BASE.CurrentTimeEvent</para>
                                    <itemizedlist>
                                        <listitem>
                                            <para>BASE.CLOSE_POSITION</para>
                                        </listitem>
                                        <listitem>
                                            <para>BASE.CURRENT_MARKET_DATA_EVENT</para>
                                        </listitem>
                                        <listitem>
                                            <para>BASE.PROPAGATE_MARKET_DATA_EVENTS</para>
                                        </listitem>
                                        <listitem>
                                            <para>BASE.INSERT_INTO_PORTFOLIO_VALUE</para>
                                        </listitem>
                                        <listitem>
                                            <para>BASE...</para>
                                        </listitem>
                                        <listitem>
                                            <para>LogPortfolioValueSubscriber</para>
                                        </listitem>
                                        <listitem>
                                            <para>TradeCallback.BASE</para>
                                        </listitem>
                                        <listitem>
                                            <para>PropagateMarketDataEventSubscriber.update</para>
                                            <itemizedlist>
                                                <listitem>
                                                    <para>EsperManager.STRATEGY1.CurrentTimeEvent
                                                </para>
                                                </listitem>
                                                <listitem>
                                                    <para>EsperManager.STRATEGY1.BarImpl</para>
                                                </listitem>
                                                <listitem>
                                                    <para>EsperManager.STRATEGY1.FillImpl</para>
                                                </listitem>
                                                <listitem>
                                                    <para>EsperManager.STRATEGY1.TransactionImpl
                                                </para>
                                                </listitem>
                                                <listitem>
                                                    <para>EsperManager.STRATEGY1.OrderStatusImpl
                                                </para>
                                                </listitem>
                                                <listitem>
                                                    <para>EsperManager.STRATEGY1.OpenPositionVO
                                                </para>
                                                </listitem>
                                                <listitem>
                                                    <para>EsperManager.STRATEGY1.ClosePositionVO</para>
                                                    <itemizedlist>
                                                        <listitem>
                                                            <para>STRATEGY1.STATEMENT1</para>
                                                        </listitem>
                                                        <listitem>
                                                            <para>STRATEGY1.STATEMENT2</para>
                                                        </listitem>
                                                        <listitem>
                                                            <para>STRATEGY1.STATEMENT3</para>
                                                        </listitem>
                                                        <listitem>
                                                            <para>STRATEGY1...</para>
                                                        </listitem>
                                                        <listitem>
                                                            <para>Strategy1ServiceSubscriber1</para>
                                                        </listitem>
                                                        <listitem>
                                                            <para>Strategy1ServiceSubscriber2</para>
                                                        </listitem>
                                                        <listitem>
                                                            <para>Strategy1ServiceSubscriber3</para>
                                                        </listitem>
                                                        <listitem>
                                                            <para>Callback1.STRATEGY1</para>
                                                        </listitem>
                                                        <listitem>
                                                            <para>Callback2.STRATEGY1</para>
                                                        </listitem>
                                                    </itemizedlist>
                                                </listitem>
                                                <listitem>
                                                    <para>Esper Overhead STRATEGY1</para>
                                                </listitem>
                                            </itemizedlist>
                                        </listitem>
                                    </itemizedlist>
                                </listitem>
                                <listitem>
                                    <para>Esper Overhead BASE</para>
                                </listitem>
                            </itemizedlist>
                        </listitem>
                        <listitem>
                            <para>CustomSender.sendCurrentTimeEvent Overhead</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
            </itemizedlist>
            <note>
                <para>Subscriber time consumption is not included in statement metrics, whereas static method
                    invocation is included.</para>
            </note>
        </section>
    </chapter>
    <chapter id="Logging">
        <title>Logging</title>
        <para>Logging is done using the <ulink url="http://logging.apache.org/log4j"> log4j</ulink>
            framework. The Logging system is configured by means of <filename>log4j.xml</filename>
            and <filename>log4j-prod.xml</filename> (for productive use) files.</para>
        <para>The log level can be changed through the following vm-argument:</para>
        <screen>-DlogLevel=ERROR</screen>
        <section>
            <title>log4j.xml</title>
            <table frame="all" pgwide="1">
                <title>Log4j Appenders</title>
                <tgroup cols="2">
                    <colspec colwidth="1*"/>
                    <colspec colwidth="2*"/>
                    <thead>
                        <row>
                            <entry>Appender</entry>
                            <entry>Description</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>STDOUT</entry>
                            <entry>Logs to Standard Out</entry>
                        </row>
                        <row>
                            <entry>STDERR</entry>
                            <entry>Logs to Standard Error</entry>
                        </row>
                        <row>
                            <entry>PORTFOLIO</entry>
                            <entry>Logs Portfolio Values to the portfolio.csv log file</entry>
                        </row>
                        <row>
                            <entry>INDICATOR</entry>
                            <entry>Logs arbitrary values to indicator.csv</entry>
                        </row>
                        <row>
                            <entry>SOCKET</entry>
                            <entry>Logs to a Remote Socket Server (used when doing multiple
                                simulations in parallel)</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section>
            <title>log4j-prod.xml</title>
            <table frame="all" pgwide="1">
                <title>Log4j Prod Appenders</title>
                <tgroup cols="2">
                    <colspec colwidth="1*"/>
                    <colspec colwidth="2*"/>
                    <thead>
                        <row>
                            <entry>Appender</entry>
                            <entry>Description</entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>DEBUG</entry>
                            <entry>Logs everything to a non-appending file</entry>
                        </row>
                        <row>
                            <entry>FILE</entry>
                            <entry>Logs Info and up to an appending file</entry>
                        </row>
                        <row>
                            <entry>ERROR</entry>
                            <entry>Sends Email Messages on Errors</entry>
                        </row>
                        <row>
                            <entry>SMS</entry>
                            <entry>Sends Text Messages on Errors</entry>
                        </row>
                        <row>
                            <entry>TRADE</entry>
                            <entry>Sends Email Messages on executed trades</entry>
                        </row>
                        <row>
                            <entry>NOTIFICATION</entry>
                            <entry>Sends arbitrary Email Notifications</entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
            <note>
                <itemizedlist>
                    <listitem>
                        <para>Problems with the Email or SMS Appender go to System.err (on server
                            see nohup.log)</para>
                    </listitem>
                    <listitem>
                        <para>log4j-prod.xml defines AsyncAppenders for appenders that send
                            Emails/SMS to ensure that calling code is not blocked by the send
                            operation</para>
                    </listitem>
                    <listitem>
                        <para>To prevent saturation of the logs several loggers have been defined
                            with a logging level higher than the root log level</para>
                    </listitem>
                </itemizedlist>
            </note>
        </section>
    </chapter>
    <appendix id="Box_Strategy">
        <title>Example Strategy "Box"</title>
        <section>
            <title>Trading Idea</title>
            <warning>
                <para>The purpose of this Strategy is to demonstrates many of the capabilities of
                    AlgoTrader. Do not use it with a Live Trading Account an real Money! Due to
                    frequent Draw Downs, it might lead to large losses. Even when modifying ore
                    extending the Strategy use extreme caution before trading it Live.</para>
            </warning>
            <para>The Strategy trades the EUR.USD FX Market and is based on the Stairstep Breakouts
                Indicator that is presented on <ulink url="http://www.forexfactory.com/showthread.php?t=302007">www.forexfactory.com</ulink> by <ulink url="http://www.forexfactory.com/forexhard">forexhard</ulink>.</para>
            <para>The Trading Idea behind the Strategy is the following. Markets will often stay
                within a trading range for a considerable amount of time before they break-out in
                either direction. The following Chart shows some examples of trading ranges.</para>
            <figure>
                <title>Box Trading Ranges</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/BoxTradingRanges.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>After a break-out markets might return back into the trading range but will
                eventually make a major move in one direction.</para>
            <para>According to the defined settings, the Strategy looks for a trading range with a
                minimum length in Minutes (e.g. 90 Minutes) and a maximum width in Pips (e.g. 30
                Pips). The chart below displays a typical trading range in dark blue color.</para>
            <figure>
                <title>Box Strategy</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/Box.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>As soon as trading range has been built according to these parameters, the
                Strategy waits for the first break-out to happen. The strategy enters the market in
                the direction of the breakout as soon as a small margin called buffer (dashed red
                line, e.g. 5 Pips) has been crossed. In the example above, this happened at
                10:48.</para>
            <para>The Strategy will set a stop at the opposite side of the box (e.g. 1.3618 = 39
                Pips) and a target with the same distance (e.g. 1.3544 = 39 Pips).</para>
            <para>If the target is reached, the Strategy resets itself and waits for a new Box to
                build itself.</para>
            <para>If the Position gets stopped out (at the opposite side of the Box), The Strategy
                waits for the next break-out to happen (on the same Box) and enters the market again
                after the buffer-line has been crossed. This time the size of the position is
                doubled in order to cover the losses of the first entry, in case the target is
                reached this time around. Position size is doubled up to a defined maximum. Because
                of this doubling the system can be categorized as a Martingale Strategy (see <ulink url="http://en.wikipedia.org/wiki/Martingale_%28betting_system%29">Martingale
                    Betting System</ulink>).</para>
            <para>The following State Chart Diagram depicts the different states the Strategy will
                pass through:</para>
            <figure>
                <title>Box States</title>
                <mediaobject>
                    <imageobject>
                        <imagedata fileref="images/BoxStates.png"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>The default setting of the Strategy will go up to level 5 which will result in a
                position size of 16 times the original size. So the individual sizes on the
                different levels will be: 1, 2, 4, 8 &amp; 16. Each successful series will therefor
                present a profit of 1 unit. Very often series will be successful on a level that is
                below the maximum level (e.g. below level 5). However if the Strategy has a loosing
                set, which will be terminated at the maximum level (e.g. at level 5), there will be
                a loss of 16 times the original position size.</para>
            <para>The Strategy will often have multiple successful series in a row before having one
                major draw down. A typical performance chart will therefore look like this:</para>
            <figure>
                <title>Box Strategy Performance</title>
                <mediaobject>
                    <imageobject>
                        <imagedata scalefit="1" fileref="images/BoxPerformance.gif"/>
                    </imageobject>
                </mediaobject>
            </figure>
            <para>To prevent having open positions over the weekend the Strategy does not create any
                new boxes after a defined time on Friday (e.g. 4PM). Also, it will terminate a
                potential ongoing series at a defined time on Friday (e.g. 10PM)</para>
        </section>
        <section>
            <title>Implementation</title>
            <para>The main artifacts needed for the Implementation of a new Strategy are described
                in chapter <xref linkend="Strategy_Development"/>.</para>
            <para>The following list will give an overview of the specific artifacts implemented by
                the Box Strategy (Note: Most of the functionality is documented via JavaDoc or Esper
                comments):</para>
            <variablelist>
                <varlistentry>
                    <term>
                        <filename>/src/main/java/com/algoTrader/strategy/forex/BoxServiceImpl.java</filename>
                    </term>
                    <listitem>
                        <para>The strategy service class providing the main methods invoked by
                            different Esper statements.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/java/com/algoTrader/strategy/forex/BoxChartServiceImpl.java</filename>
                    </term>
                    <listitem>
                        <para>This class provides input data for the Box Custom Chart (see <xref linkend="Custom_Chart"/>).</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/java/com/algoTrader/strategy/forex/BoxStarter.java</filename>
                    </term>
                    <listitem>
                        <para>The class containing the main method to start the strategy in Live
                            Trading Mode. It will also initiate a reset of all Esper variables to
                            its prior state before the Engine was shut down and invoke prefeeding of
                            Tick Data to initialize statements.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/java/com/algoTrader/strategy/forex/Box.java</filename>
                    </term>
                    <listitem>
                        <para>A POJO class representing all properties of a Box (e.g.
                                <parameter>top</parameter>, <parameter>bottom</parameter>,
                                <parameter>startDateTime</parameter> and
                                <parameter>endDateTime</parameter>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/java/com/algoTrader/strategy/forex/State.java</filename>
                    </term>
                    <listitem>
                        <para>A Java Enum representing the different States the Strategy can pass
                            through (<parameter>INIT</parameter>, <parameter>CREATED</parameter>,
                                <parameter>LONG</parameter>, <parameter>SHORT</parameter>,
                                <parameter>FLAT</parameter>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/java/com/algoTrader/strategy/forex/VariableListener.java</filename>
                    </term>
                    <listitem>
                        <para>Esper does not provide any persistence mechanisms between JVM
                            restarts. Therefor all variable values are persisted by means of this
                            class. The <methodname>BoxServiceImpl.initVariable</methodname> method
                            will reset all variable values after a restart.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/module-box-init.epl</filename>
                    </term>
                    <listitem>
                        <para>Esper Module containing statements for capturing market data, creating
                            variables and creating Boxes. In Live Trading, these statements will be
                            deployed before the prefeeding.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/module-box-run.epl</filename>
                    </term>
                    <listitem>
                        <para>Esper Module containing statements that invoke the business actions on
                            the <classname>BoxService</classname> (<methodname>entry</methodname>,
                                <methodname>takeProfit</methodname>,
                                <methodname>closePosition</methodname>,
                                <methodname>reverse</methodname> and
                                <methodname>terminateSeries</methodname>). In Live Trading these
                            statements will be deployed after prefeeding is finished.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/META-INF/conf-forex-box.properties</filename>
                    </term>
                    <listitem>
                        <para>Contains parameters used by the strategy (e.g.
                                <parameter>boxLength</parameter> and
                            <parameter>boxRange</parameter>)</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/META-INF/esper-forex-box.cfg.xml</filename>
                    </term>
                    <listitem>
                        <para>Contains event-types definitions (i.e.
                                <classname>CurrentValue</classname>), imports (i.e.
                                <classname>Box</classname> and <classname>State</classname>),
                            variables (e.g. <parameter>boxLength</parameter> and
                                <parameter>boxRange</parameter>) and the EsperJMS Plugin for
                            receiving market data in Live Trading Mode.</para>
                    </listitem>
                </varlistentry>
                <varlistentry>
                    <term>
                        <filename>/src/main/resources/META-INF/applicationContext-client-box.xml</filename>
                    </term>
                    <listitem>
                        <para>Contains the declaration of the <classname>BoxService</classname> and
                                <classname>BoxChartService</classname> Beans (using autowiring). The
                                <classname>BoxChartService</classname> also contains the definition
                            of the Chart including Axis, Dataset and Series (see <xref linkend="Custom_Chart"/>). The file also contains the declaration of
                            the JMS Queue (i.e. <classname>ActiveMQQueue</classname>).</para>
                    </listitem>
                </varlistentry>
            </variablelist>
            <para> To start the Strategy please see the explanations in chapter <xref linkend="Starting_a_Strategy"/>.</para>
        </section>
    </appendix>
</book>
